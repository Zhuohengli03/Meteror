<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小行星撞击地球模拟</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        // 确保Three.js和OrbitControls加载完成
        window.addEventListener('load', function() {
            console.log('Three.js loaded:', typeof THREE !== 'undefined');
            console.log('OrbitControls loaded:', typeof THREE.OrbitControls !== 'undefined');
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            overflow: hidden;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            border: 2px solid #333;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff88;
            text-align: center;
        }

        .instruction {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }

        .step {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #00ff88;
        }

        .step-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .step-content {
            font-size: 14px;
            color: white;
        }

        select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            margin-top: 5px;
        }

        select:focus {
            outline: none;
            border-color: #00ff88;
        }

        select option {
            background: #1a1a1a;
            color: white;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-height: 50vh;
            min-height: 200px;
            overflow-y: auto;
            resize: vertical;
        }

        .results-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ff4444;
            text-align: center;
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 0;
            margin: -20px -20px 15px -20px;
            border-radius: 15px 15px 0 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
        }

        .results-toggle {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .results-toggle:hover {
            background: #357ABD;
        }

        .results.collapsed {
            height: 50px;
            overflow: hidden;
        }

        .results.collapsed .impact-stats,
        .results.collapsed .cities-section {
            display: none;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 15px;
            background: linear-gradient(to right, #4A90E2, #00aaff);
            cursor: ns-resize;
            border-radius: 0 0 15px 15px;
            opacity: 0.8;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resize-handle:hover {
            opacity: 1;
            height: 20px;
        }

        .resize-handle::before {
            content: "⋮⋮";
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .trajectory-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #fff;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4A90E2;
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: #4A90E2;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .impact-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
        }

        .cities-section {
            margin-top: 15px;
        }

        .cities-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        .cities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .city-item {
            background: rgba(255, 107, 107, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #ff6b6b;
            font-size: 12px;
        }

        .city-name {
            font-weight: bold;
            color: #ff6b6b;
        }

        .city-info {
            color: #ccc;
            font-size: 11px;
        }

        .error {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 3px solid #ff4444;
            font-size: 12px;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-ready { color: #00ff88; }
        .status-selected { color: #ffaa00; }
        .status-simulating { color: #00aaff; }
        .status-error { color: #ff4444; }

        .grid-label {
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            border: 1px solid #ff6b6b;
        }

        .impact-zone-label {
            background: transparent;
            border: none;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #1a1a1a;
            margin: 5% auto;
            padding: 0;
            border: 2px solid #333;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #2a2a2a;
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: white;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        .search-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .filter-group input {
            padding: 8px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: white;
        }

        .filter-group input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .history-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .history-item:hover {
            background: #333;
        }

        .history-item h3 {
            color: #4a90e2;
            margin: 0 0 10px 0;
        }

        .history-item .meta {
            color: #aaa;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .history-item .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            color: white;
        }

        .stat-label {
            font-size: 11px;
            color: #aaa;
        }

        .history-marker {
            background: transparent;
            border: none;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* 动态演示样式 */
        .demo-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .asteroid-trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff6b6b;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff6b6b;
            animation: asteroidMove 3s ease-in-out forwards;
        }

        .impact-flash {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ffff00, #ff4444);
            border-radius: 50%;
            animation: impactFlash 0.5s ease-out;
        }

        .orbit-path {
            position: absolute;
            border: 2px dashed #00aaff;
            border-radius: 50%;
            opacity: 0.7;
            animation: orbitPulse 2s ease-in-out infinite;
        }

        @keyframes asteroidMove {
            0% {
                transform: translate(0, 0) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(var(--target-x), var(--target-y)) scale(1);
                opacity: 0;
            }
        }

        @keyframes impactFlash {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(10);
                opacity: 0;
            }
        }

        @keyframes orbitPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff88;
            font-size: 18px;
            z-index: 1001;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .map-controls button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .map-controls button:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .map-controls button.active {
            background: #00ff88;
            color: #000;
        }

        .layer-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
        }

        .layer-controls h4 {
            color: #00ff88;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .layer-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .layer-item label {
            color: white;
            cursor: pointer;
            flex: 1;
        }

        .layer-opacity {
            width: 60px;
            margin-left: 10px;
        }

        .real-time-indicator {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 1000;
            border: 1px solid #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
        <div class="container">
        <div id="map"></div>
        <div class="map-loading" id="map-loading">🌍 正在加载地图...</div>
        
        <div class="control-panel">
            <div class="title">🌍 小行星撞击地球模拟</div>
            <div class="instruction">
                点击地图选择撞击地点 → 选择小行星 → 运行模拟
    </div>

            <div class="step">
                <div class="step-label">步骤 1: 选择撞击地点</div>
                <div class="step-content" id="location-status">点击地图上的任意位置</div>
            </div>

            <div class="step">
                <div class="step-label">步骤 2: 选择小行星</div>
                <div class="asteroid-search">
                    <input type="text" id="asteroid-search" placeholder="搜索小行星名称..." style="width: 100%; padding: 6px; margin-bottom: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <select id="asteroid-select" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="">请先选择撞击地点</option>
                        </select>
                    <div class="asteroid-stats" id="asteroid-stats" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
                    </div>
                    </div>

        <div class="step">
            <div class="step-label">步骤 3: 轨迹设置</div>
            <div class="trajectory-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="show-trajectory" checked>
                    <span class="checkmark"></span>
                    显示降落轨迹
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="show-3d-effect" checked>
                    <span class="checkmark"></span>
                    立体地图效果
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="show-coordinates" checked>
                    <span class="checkmark"></span>
                    显示经纬度
                </label>
                    </div>
                    </div>

            <button class="btn" id="simulate-btn" onclick="runSimulation()" disabled>
                🚀 运行撞击模拟
            </button>
            
            <button class="btn" id="history-btn" onclick="showHistoryModal()" style="background: #4a90e2; margin-top: 10px;">
                📊 查询历史模拟
            </button>
            
            <div class="error" id="error" style="display: none;"></div>
                    </div>

        <div class="status-indicator" id="status">
            <span class="status-ready">● 准备就绪</span>
                </div>

        <!-- 历史模拟查询模态框 -->
        <div id="history-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>📊 历史模拟查询</h2>
                    <span class="close" onclick="closeHistoryModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="search-filters">
                        <div class="filter-group">
                            <label>小行星名称:</label>
                            <input type="text" id="asteroid-name-filter" placeholder="输入小行星名称">
            </div>
                        <div class="filter-group">
                            <label>日期范围:</label>
                            <input type="date" id="start-date-filter">
                            <span>至</span>
                            <input type="date" id="end-date-filter">
        </div>
                        <div class="filter-group">
                            <label>撞击地点:</label>
                            <input type="text" id="location-filter" placeholder="输入地点关键词">
    </div>
                        <button class="btn" onclick="searchHistory()" style="background: #4a90e2;">
                            🔍 搜索
                        </button>
                    </div>
                    <div class="history-results" id="history-results">
                        <!-- 历史模拟结果将在这里显示 -->
                </div>
            </div>
                    </div>
                    </div>

        <div class="real-time-indicator">
            🛰️ NASA小行星数据
                    </div>

        <div class="layer-controls">
            <h4>🗺️ 地图图层</h4>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="osm-layer" checked>
                <label for="osm-layer">OpenStreetMap</label>
                    </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="terrain-layer">
                <label for="terrain-layer">地形图</label>
                </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="dark-layer">
                <label for="dark-layer">深色主题</label>
            </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="esri-layer">
                <label for="esri-layer">Esri地图</label>
    </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="imagery-layer">
                <label for="imagery-layer">卫星影像</label>
        </div>
    </div>

        <div class="results" id="results">
            <div class="results-header">
                <span>💥 撞击影响分析</span>
                <button class="results-toggle" onclick="toggleResults()" id="results-toggle">−</button>
                </div>
            
            <div class="impact-stats" id="impact-stats">
                <!-- 统计数据将在这里显示 -->
            </div>

            <div class="cities-section">
                <div class="cities-title">🏙️ 受影响城市</div>
                <div class="cities-grid" id="affected-cities">
                    <!-- 城市列表将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let impactMarker;
        let currentImpactMarker = null;
        let impactCircle;
        let cityMarkers = [];
        let selectedLocation = null;
        let currentImpactData = null;
        let activeLayers = {};

        // 主要城市数据（简化版）
        const majorCities = [
            { name: "北京", lat: 39.9042, lng: 116.4074, population: 21540000, country: "中国" },
            { name: "上海", lat: 31.2304, lng: 121.4737, population: 24280000, country: "中国" },
            { name: "广州", lat: 23.1291, lng: 113.2644, population: 15300000, country: "中国" },
            { name: "深圳", lat: 22.5431, lng: 114.0579, population: 17560000, country: "中国" },
            { name: "成都", lat: 30.5728, lng: 104.0668, population: 16580000, country: "中国" },
            { name: "重庆", lat: 29.4316, lng: 106.9123, population: 32050000, country: "中国" },
            { name: "天津", lat: 39.3434, lng: 117.3616, population: 13870000, country: "中国" },
            { name: "武汉", lat: 30.5928, lng: 114.3055, population: 12320000, country: "中国" },
            { name: "西安", lat: 34.3416, lng: 108.9398, population: 12950000, country: "中国" },
            { name: "杭州", lat: 30.2741, lng: 120.1551, population: 11930000, country: "中国" },
            { name: "南京", lat: 32.0603, lng: 118.7969, population: 9315000, country: "中国" },
            { name: "青岛", lat: 36.0986, lng: 120.3719, population: 10070000, country: "中国" },
            { name: "大连", lat: 38.9140, lng: 121.6147, population: 7450000, country: "中国" },
            { name: "厦门", lat: 24.4798, lng: 118.0819, population: 4110000, country: "中国" },
            { name: "苏州", lat: 31.2989, lng: 120.5853, population: 12750000, country: "中国" },
            { name: "宁波", lat: 29.8683, lng: 121.5440, population: 8542000, country: "中国" },
            { name: "长沙", lat: 28.2278, lng: 112.9388, population: 10050000, country: "中国" },
            { name: "郑州", lat: 34.7466, lng: 113.6254, population: 12600000, country: "中国" },
            { name: "济南", lat: 36.6512, lng: 117.1201, population: 9200000, country: "中国" },
            { name: "福州", lat: 26.0745, lng: 119.2965, population: 8290000, country: "中国" },
            { name: "石家庄", lat: 38.0428, lng: 114.5149, population: 11200000, country: "中国" },
            { name: "合肥", lat: 31.8206, lng: 117.2272, population: 9465000, country: "中国" },
            { name: "南昌", lat: 28.6820, lng: 115.8579, population: 6255000, country: "中国" },
            { name: "昆明", lat: 25.0389, lng: 102.7183, population: 8460000, country: "中国" },
            { name: "贵阳", lat: 26.6470, lng: 106.6302, population: 6100000, country: "中国" },
            { name: "兰州", lat: 36.0611, lng: 103.8343, population: 4350000, country: "中国" },
            { name: "银川", lat: 38.4872, lng: 106.2309, population: 2850000, country: "中国" },
            { name: "西宁", lat: 36.6232, lng: 101.7782, population: 2460000, country: "中国" },
            { name: "乌鲁木齐", lat: 43.8256, lng: 87.6168, population: 4050000, country: "中国" },
            { name: "拉萨", lat: 29.6465, lng: 91.1172, population: 867000, country: "中国" },
            { name: "台北", lat: 25.0330, lng: 121.5654, population: 2600000, country: "中国台湾" },
            { name: "高雄", lat: 22.6273, lng: 120.3014, population: 2700000, country: "中国台湾" },
            { name: "香港", lat: 22.3193, lng: 114.1694, population: 7500000, country: "中国香港" },
            { name: "澳门", lat: 22.1987, lng: 113.5439, population: 680000, country: "中国澳门" },
            // 国际主要城市
            { name: "东京", lat: 35.6762, lng: 139.6503, population: 37400000, country: "日本" },
            { name: "首尔", lat: 37.5665, lng: 126.9780, population: 9720000, country: "韩国" },
            { name: "新加坡", lat: 1.3521, lng: 103.8198, population: 5450000, country: "新加坡" },
            { name: "曼谷", lat: 13.7563, lng: 100.5018, population: 10540000, country: "泰国" },
            { name: "雅加达", lat: -6.2088, lng: 106.8456, population: 10560000, country: "印度尼西亚" },
            { name: "马尼拉", lat: 14.5995, lng: 120.9842, population: 13480000, country: "菲律宾" },
            { name: "胡志明市", lat: 10.8231, lng: 106.6297, population: 8993000, country: "越南" },
            { name: "吉隆坡", lat: 3.1390, lng: 101.6869, population: 1588000, country: "马来西亚" },
            { name: "新德里", lat: 28.6139, lng: 77.2090, population: 32900000, country: "印度" },
            { name: "孟买", lat: 19.0760, lng: 72.8777, population: 20000000, country: "印度" },
            { name: "加尔各答", lat: 22.5726, lng: 88.3639, population: 14900000, country: "印度" },
            { name: "班加罗尔", lat: 12.9716, lng: 77.5946, population: 12400000, country: "印度" },
            { name: "悉尼", lat: -33.8688, lng: 151.2093, population: 5312000, country: "澳大利亚" },
            { name: "墨尔本", lat: -37.8136, lng: 144.9631, population: 5078000, country: "澳大利亚" },
            { name: "纽约", lat: 40.7128, lng: -74.0060, population: 8336000, country: "美国" },
            { name: "洛杉矶", lat: 34.0522, lng: -118.2437, population: 3972000, country: "美国" },
            { name: "芝加哥", lat: 41.8781, lng: -87.6298, population: 2694000, country: "美国" },
            { name: "休斯顿", lat: 29.7604, lng: -95.3698, population: 2320000, country: "美国" },
            { name: "伦敦", lat: 51.5074, lng: -0.1278, population: 8982000, country: "英国" },
            { name: "巴黎", lat: 48.8566, lng: 2.3522, population: 2161000, country: "法国" },
            { name: "柏林", lat: 52.5200, lng: 13.4050, population: 3669000, country: "德国" },
            { name: "罗马", lat: 41.9028, lng: 12.4964, population: 2873000, country: "意大利" },
            { name: "莫斯科", lat: 55.7558, lng: 37.6176, population: 12500000, country: "俄罗斯" },
            { name: "圣彼得堡", lat: 59.9311, lng: 30.3609, population: 5384000, country: "俄罗斯" },
            { name: "开罗", lat: 30.0444, lng: 31.2357, population: 20480000, country: "埃及" },
            { name: "拉各斯", lat: 6.5244, lng: 3.3792, population: 15388000, country: "尼日利亚" },
            { name: "约翰内斯堡", lat: -26.2041, lng: 28.0473, population: 5635000, country: "南非" },
            { name: "开普敦", lat: -33.9249, lng: 18.4241, population: 4618000, country: "南非" },
            { name: "圣保罗", lat: -23.5505, lng: -46.6333, population: 12300000, country: "巴西" },
            { name: "里约热内卢", lat: -22.9068, lng: -43.1729, population: 6748000, country: "巴西" },
            { name: "布宜诺斯艾利斯", lat: -34.6118, lng: -58.3960, population: 15590000, country: "阿根廷" },
            { name: "墨西哥城", lat: 19.4326, lng: -99.1332, population: 21800000, country: "墨西哥" },
            { name: "多伦多", lat: 43.6532, lng: -79.3832, population: 2930000, country: "加拿大" },
            { name: "温哥华", lat: 49.2827, lng: -123.1207, population: 675000, country: "加拿大" }
        ];

        // 初始化地图
        function initMap() {
            try {
                map = L.map('map', {
                    zoomControl: true,
                    attributionControl: false
                }).setView([20, 0], 2);  // 使用标准坐标系
                
                // 使用可靠的地图服务
                const mapLayers = [
                    // OpenStreetMap (最可靠)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors',
                        maxZoom: 19
                    }),
                    // 备用1: OpenTopoMap 地形图
                    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors, SRTM | © OpenTopoMap (CC-BY-SA)',
                        subdomains: 'abc',
                        maxZoom: 17
                    }),
                    // 备用2: CartoDB 深色主题
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '© OpenStreetMap contributors © CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }),
                    // 备用3: Esri 世界地图
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '© Esri',
                        maxZoom: 19
                    }),
                    // 备用4: Esri 世界影像
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '© Esri',
                        maxZoom: 19
                    })
                ];

                // 初始化图层
                activeLayers = {
                    osm: mapLayers[0],
                    terrain: mapLayers[1],
                    dark: mapLayers[2],
                    esri: mapLayers[3],
                    imagery: mapLayers[4]
                };

                // 默认显示OpenStreetMap
                activeLayers.osm.addTo(map);

                // 设置图层控制事件
                setupLayerControls();

                // 地图加载成功后隐藏加载提示
                map.on('load', function() {
                    document.getElementById('map-loading').style.display = 'none';
                });

                // 如果地图加载失败，尝试备用服务
                activeLayers.osm.on('tileerror', function() {
                    console.log('OpenStreetMap加载失败，尝试备用服务...');
                    map.removeLayer(activeLayers.osm);
                    activeLayers.dark.addTo(map);
                });

                // 设置超时，如果5秒后还在加载，强制隐藏加载提示
                setTimeout(function() {
                    document.getElementById('map-loading').style.display = 'none';
                }, 5000);

                // 添加城市标记
                addCityMarkers();

                // 地图点击事件
                map.on('click', function(e) {
                    selectImpactLocation(e.latlng);
                });

                // 加载小行星数据
                loadAsteroids();

            } catch (error) {
                console.error('地图初始化失败:', error);
                showError('地图初始化失败: ' + error.message);
            }
        }

        // 添加城市标记
        function addCityMarkers() {
            majorCities.forEach(city => {
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: 3,
                    fillColor: '#ff6b6b',
                    color: 'white',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                }).addTo(map);

                marker.bindPopup(`
                    <div style="text-align: center; color: #333;">
                        <h4 style="margin: 0 0 5px 0;">${city.name}</h4>
                        <p style="margin: 0; font-size: 12px;">${city.country}</p>
                        <p style="margin: 0; font-size: 11px; color: #666;">人口: ${city.population.toLocaleString()}</p>
                    </div>
                `);

                cityMarkers.push(marker);
            });
        }

        // 选择撞击地点
        function selectImpactLocation(latlng) {
            selectedLocation = latlng;
            
            // 移除之前的撞击标记
            if (impactMarker) {
                map.removeLayer(impactMarker);
            }
            if (impactCircle) {
                map.removeLayer(impactCircle);
            }

            // 添加新的撞击标记
            impactMarker = L.circleMarker(latlng, {
                radius: 8,
                fillColor: '#ff4444',
                color: 'white',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            impactMarker.bindPopup(`
                <div style="text-align: center; color: #333;">
                    <h4 style="margin: 0 0 5px 0;">🎯 撞击地点</h4>
                    <p style="margin: 0; font-size: 12px;">纬度: ${latlng.lat ? latlng.lat.toFixed(4) : 'N/A'}°</p>
                    <p style="margin: 0; font-size: 12px;">经度: ${latlng.lng ? latlng.lng.toFixed(4) : 'N/A'}°</p>
                </div>
            `);

            // 更新状态
            updateStatus('selected', '已选择撞击地点');
            document.getElementById('location-status').textContent = 
                `已选择: ${latlng.lat ? latlng.lat.toFixed(2) : 'N/A'}°, ${latlng.lng ? latlng.lng.toFixed(2) : 'N/A'}°`;
            
            // 启用小行星选择
            document.getElementById('asteroid-select').disabled = false;
            document.getElementById('asteroid-select').innerHTML = '<option value="">加载小行星数据...</option>';
            
            // 重新加载小行星数据
            loadAsteroids();
        }

        // 存储所有小行星数据
        let allAsteroids = [];

        // 加载小行星数据
        async function loadAsteroids() {
            try {
                const response = await fetch('http://localhost:8000/asteroids');
                allAsteroids = await response.json();
                
                // 初始化搜索功能
                setupAsteroidSearch();
                
                // 显示所有小行星
                displayAsteroids(allAsteroids);

                // 启用模拟按钮
                document.getElementById('simulate-btn').disabled = false;
                
            } catch (error) {
                console.error('加载小行星数据失败:', error);
                showError('无法加载小行星数据，请检查后端服务');
            }
        }
        
        // 设置小行星搜索功能
        function setupAsteroidSearch() {
            const searchInput = document.getElementById('asteroid-search');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredAsteroids = allAsteroids.filter(asteroid => 
                    asteroid.name.toLowerCase().includes(searchTerm) ||
                    asteroid.id.includes(searchTerm)
                );
                displayAsteroids(filteredAsteroids);
            });
        }
        
        // 显示小行星列表
        function displayAsteroids(asteroids) {
            const select = document.getElementById('asteroid-select');
            const stats = document.getElementById('asteroid-stats');
            
            select.innerHTML = '';
            
            if (asteroids.length === 0) {
                select.innerHTML = '<option value="">未找到匹配的小行星</option>';
                stats.textContent = '显示 0 个小行星';
                return;
            }
            
            // 按危险等级和直径排序
            asteroids.sort((a, b) => {
                if (a.is_potentially_hazardous !== b.is_potentially_hazardous) {
                    return b.is_potentially_hazardous - a.is_potentially_hazardous;
                }
                return (b.diameter_min + b.diameter_max) - (a.diameter_min + a.diameter_max);
            });
            
                asteroids.forEach(asteroid => {
                    const option = document.createElement('option');
                    option.value = asteroid.id;
                    
                    // 只显示名字和日期
                    const approachDate = asteroid.close_approach_data?.[0]?.close_approach_date || '未知';
                    const hazardStatus = asteroid.is_potentially_hazardous ? '⚠️' : '✅';
                    
                    option.textContent = `${hazardStatus} ${asteroid.name} | ${approachDate}`;
                    select.appendChild(option);
                });
            
            // 更新统计信息
            const hazardousCount = asteroids.filter(a => a.is_potentially_hazardous).length;
            stats.textContent = `显示 ${asteroids.length} 个小行星 (${hazardousCount} 个高危)`;
        }

        // 运行撞击模拟
        async function runSimulation() {
            const asteroidSelect = document.getElementById('asteroid-select');
            const asteroidId = asteroidSelect.value;
            
            if (!asteroidId) {
                showError('请选择一个小行星');
                return;
            }

            if (!selectedLocation) {
                showError('请在地图上点击选择撞击地点');
                return;
            }

            await runStaticSimulation(asteroidId);
        }

        async function runStaticSimulation(asteroidId) {
            hideError();

            try {
                // 清理所有现有显示
                clearAllDisplays();
                
                // 检查是否显示轨迹
                const showTrajectory = document.getElementById('show-trajectory').checked;
                const show3DEffect = document.getElementById('show-3d-effect').checked;
                
                if (showTrajectory) {
                    updateStatus('simulating', '正在显示降落轨迹...');
                    // 显示降落轨迹动画
                    await showImpactTrajectory(asteroidId, show3DEffect);
                }
                
                // 更新状态
                updateStatus('simulating', '正在计算撞击影响...');

                // 获取小行星数据以获取真实速度
                const asteroidResponse = await fetch('http://localhost:8000/asteroids');
                const asteroids = await asteroidResponse.json();
                const asteroid = asteroids.find(a => a.id === asteroidId);
                
                // 使用API中的真实速度，如果没有则使用默认值
                let impactVelocity = 20000; // 默认20km/s
                
                if (asteroid && asteroid.close_approach_data && asteroid.close_approach_data.length > 0) {
                    // 从多个接近数据中选择一个速度（选择最近的或随机的）
                    const approachData = asteroid.close_approach_data[0]; // 使用最近的接近数据
                    const velocityStr = approachData.relative_velocity.kilometers_per_second;
                    const velocity = parseFloat(velocityStr);
                    if (!isNaN(velocity) && velocity > 0) {
                        impactVelocity = velocity * 1000; // 转换为m/s
                    }
                } else if (asteroid && asteroid.velocity) {
                    // 使用存储的平均速度
                    impactVelocity = asteroid.velocity;
                }
                
                console.log('撞击速度:', impactVelocity, 'm/s');
                console.log('小行星接近数据:', asteroid.close_approach_data?.length || 0, '条记录');
                
                const response = await fetch('http://localhost:8000/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        asteroid_id: asteroidId,
                        impact_angle: 45,
                        impact_velocity: impactVelocity,
                        target_density: 3000,
                        target_type: 'continental_crust',
                        impact_latitude: selectedLocation.lat,
                        impact_longitude: selectedLocation.lng
                    })
                });

                const result = await response.json();
                currentImpactData = result;
                
                // 计算影响半径用于城市计算
                const craterRadius = result.crater_diameter / 2;
                const impactRadius = craterRadius * 50; // 影响范围是陨石坑的50倍
                
                // 显示结果
                displayResults(result, impactRadius);
                
                // 延迟显示撞击范围，模拟撞击后的效果
                setTimeout(() => {
                    // 确保清除所有现有圈层
                    clearImpactZones();
                    showImpactArea(result);
                }, 1000);
                
                updateStatus('ready', '模拟完成');
                
            } catch (error) {
                console.error('模拟失败:', error);
                showError('模拟失败: ' + error.message);
                updateStatus('error', '模拟失败');
            }
        }

        // 显示撞击范围
        function showImpactArea(result) {
            console.log('showImpactArea called with result:', result);
            console.log('selectedLocation:', selectedLocation);
            
            if (!selectedLocation) {
                console.error('selectedLocation is null, cannot show impact area');
                return;
            }
            
            const craterRadius = result.crater_diameter / 2;
            const impactRadius = craterRadius * 50; // 影响范围是陨石坑的50倍
            
            console.log('craterRadius:', craterRadius, 'impactRadius:', impactRadius);
            
            // 清除之前的影响范围圆圈
            if (impactCircle) {
                map.removeLayer(impactCircle);
            }
            
            // 准备坐标
            const impactLatLng = [selectedLocation.lat, selectedLocation.lng];
            console.log('Creating impact circle at:', impactLatLng, 'with radius:', impactRadius * 1000);
            
            // 添加撞击点标记
            if (currentImpactMarker) {
                map.removeLayer(currentImpactMarker);
            }
            
            currentImpactMarker = L.circleMarker(impactLatLng, {
                radius: 8,
                color: '#ff0000',
                fillColor: '#ff0000',
                fillOpacity: 0.8,
                weight: 2
            }).addTo(map);
            
            // 创建影响圈层
            // craterRadius 单位是米，需要转换为公里用于显示
            const craterRadiusKm = craterRadius / 1000; // 转换为公里
            
            // 获取爆炸效应数据
            const blastEffects = result.blast_effects;
            const zones = [
                {
                    radius: craterRadiusKm,
                    color: '#ff0000',
                    opacity: 0.8,
                    label: '陨石坑',
                    description: '直接撞击区域'
                }
            ];
            
            // 添加爆炸效应圈层
            if (blastEffects) {
                // 20psi超压圈层（严重损坏）
                if (blastEffects.overpressure_20psi_radius > 0) {
                    zones.push({
                        radius: blastEffects.overpressure_20psi_radius,
                        color: '#ff4400',
                        opacity: 0.6,
                        label: '20psi超压区',
                        description: '严重损坏区域'
                    });
                }
                
                // 5psi超压圈层（中等损坏）
                if (blastEffects.overpressure_5psi_radius > 0) {
                    zones.push({
                        radius: blastEffects.overpressure_5psi_radius,
                        color: '#ff8800',
                        opacity: 0.4,
                        label: '5psi超压区',
                        description: '中等损坏区域'
                    });
                }
                
                // 1psi超压圈层（轻微损坏）
                if (blastEffects.overpressure_1psi_radius > 0) {
                    zones.push({
                        radius: blastEffects.overpressure_1psi_radius,
                        color: '#ffaa00',
                        opacity: 0.3,
                        label: '1psi超压区',
                        description: '轻微损坏区域'
                    });
                }
            }
            
            // 创建影响圈层
            zones.forEach((zone, index) => {
                console.log(`创建圈层 ${index + 1}:`, {
                    label: zone.label,
                    color: zone.color,
                    radius: zone.radius,
                    opacity: zone.opacity
                });
                
                const circle = L.circle(impactLatLng, {
                    radius: zone.radius * 1000, // zone.radius已经是公里，转换为米
                    color: zone.color,
                    fillColor: zone.color,
                    fillOpacity: Math.max(zone.opacity, 0.1), // 确保最小透明度
                    weight: 4, // 增加线条粗细
                    dashArray: index === 0 ? '0' : '15, 10' // 陨石坑实线，其他虚线
                }).addTo(map);
                
                circle._impactZone = true;
                
                // 添加标签（所有圈层都添加标签，位置在圈层边缘）
                // 将半径从公里转换为度（粗略转换：1度约111km）
                const radiusInDegrees = zone.radius / 111; // 转换为度
                
                // 为不同圈层设置不同的角度偏移，避免重叠
                // 使用更合理的角度分布：0°, 72°, 144°, 216°, 288°
                const angles = [0, 72, 144, 216, 288];
                const angleOffset = angles[index] || (index * 72) % 360;
                const angleRad = (angleOffset * Math.PI) / 180;
                
                // 计算标签位置，在圈层外部
                const labelOffset = radiusInDegrees * 1.2; // 在圈层外部20%的位置
                const labelLat = selectedLocation.lat + Math.cos(angleRad) * labelOffset;
                const labelLng = selectedLocation.lng + Math.sin(angleRad) * labelOffset;
                
                console.log(`圈层 ${index + 1} 标签位置:`, {
                    label: zone.label,
                    radius: zone.radius + 'm',
                    radiusInDegrees: radiusInDegrees ? radiusInDegrees.toFixed(6) + '°' : 'N/A',
                    angleOffset: angleOffset + '°',
                    labelPosition: [labelLat ? labelLat.toFixed(6) : 'N/A', labelLng ? labelLng.toFixed(6) : 'N/A']
                });
                
                const label = L.marker([labelLat, labelLng], {
                    icon: L.divIcon({
                        className: 'impact-zone-label',
                        html: `
                            <div style="background: ${zone.color}; color: white; padding: 4px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; text-align: center; border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.5); min-width: 80px;">
                                ${zone.label}<br>
                                <small style="font-size: 10px;">${zone.radius ? zone.radius.toFixed(1) : 'N/A'}km</small>
                            </div>
                        `,
                        iconSize: [90, 45],
                        iconAnchor: [45, 22]
                    })
                }).addTo(map);
                label._impactZone = true;
            });
            
            console.log('Impact zones created:', zones.length);
            
            // 添加冲击波动画
            const shockwave = L.circle(impactLatLng, {
                radius: 0,
                color: '#ffaa00',
                weight: 3,
                opacity: 0.8,
                fillOpacity: 0
            }).addTo(map);
            
            // 冲击波扩散动画
            let currentRadius = 0;
            const maxRadius = impactRadius * 1000;
            const animation = setInterval(() => {
                currentRadius += maxRadius / 20;
                shockwave.setRadius(currentRadius);
                shockwave.setStyle({
                    opacity: 0.8 * (1 - currentRadius / maxRadius)
                });
                
                if (currentRadius >= maxRadius) {
                    clearInterval(animation);
                    map.removeLayer(shockwave);
                }
            }, 50);
            
            // 更新城市影响状态
            updateCityImpactStatus(selectedLocation, impactRadius);
        }

        // 更新城市影响状态
        function updateCityImpactStatus(impactPoint, radius) {
            cityMarkers.forEach((marker, index) => {
                const city = majorCities[index];
                const distance = impactPoint.distanceTo([city.lat, city.lng]);
                
                if (distance <= radius) {
                    marker.setStyle({
                        fillColor: '#ff6b6b',
                        color: '#ff4444',
                        weight: 2,
                        radius: 5
                    });
                } else {
                    marker.setStyle({
                        fillColor: '#ff6b6b',
                        color: 'white',
                        weight: 1,
                        radius: 3
                    });
                }
            });
        }

        // 格式化经济损失显示
        function formatEconomicLoss(loss) {
            if (!loss || isNaN(loss) || loss < 0) {
                return 'N/A';
            }
            if (loss >= 1000000) {
                return (loss / 1000000).toFixed(1) + 'T'; // 万亿
            } else if (loss >= 1000) {
                return (loss / 1000).toFixed(1) + 'B'; // 十亿
            } else if (loss >= 1) {
                return loss.toFixed(1) + 'M'; // 百万
            } else {
                return (loss * 1000).toFixed(1) + 'K'; // 千
            }
        }

        // 格式化撞击速度显示
        function formatImpactVelocity(velocity) {
            // 确保velocity是数字，处理可能的字符串输入
            let numVelocity = parseFloat(velocity);
            
            if (isNaN(numVelocity) || numVelocity <= 0) {
                return 'N/A';
            }
            return (numVelocity / 1000).toFixed(1) + 'km/s';
        }

        // 显示结果
        function displayResults(result, impactRadius) {
            const resultsDiv = document.getElementById('results');
            const statsDiv = document.getElementById('impact-stats');
            const citiesDiv = document.getElementById('affected-cities');

            // 添加调整手柄（如果不存在）
            if (!document.querySelector('.resize-handle')) {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                resultsDiv.appendChild(resizeHandle);
            }

            // 更新统计数据
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${result.asteroid_diameter ? result.asteroid_diameter.toFixed(1) : 'N/A'}m</div>
                    <div class="stat-label">小行星直径</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatImpactVelocity(result.impact_velocity)}</div>
                    <div class="stat-label">撞击速度</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.asteroid_mass ? (result.asteroid_mass / 1e9).toFixed(1) : 'N/A'}B kg</div>
                    <div class="stat-label">小行星质量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.crater_diameter ? Math.round(result.crater_diameter/1000) : 'N/A'}km</div>
                    <div class="stat-label">陨石坑直径</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.seismic_magnitude ? result.seismic_magnitude.toFixed(1) : 'N/A'}</div>
                    <div class="stat-label">地震震级</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.tsunami_height ? Math.round(result.tsunami_height) : 'N/A'}m</div>
                    <div class="stat-label">海啸高度</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.impact_energy ? (result.impact_energy / 1e21).toFixed(1) : 'N/A'}EJ</div>
                    <div class="stat-label">冲击能量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.energy_megatons ? result.blast_effects.energy_megatons.toFixed(1) : 0}MT</div>
                    <div class="stat-label">TNT当量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.overpressure_1psi_radius ? Math.round(result.blast_effects.overpressure_1psi_radius) : 0}km</div>
                    <div class="stat-label">1psi超压半径</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.overpressure_5psi_radius ? Math.round(result.blast_effects.overpressure_5psi_radius) : 0}km</div>
                    <div class="stat-label">5psi超压半径</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.overpressure_20psi_radius ? Math.round(result.blast_effects.overpressure_20psi_radius) : 0}km</div>
                    <div class="stat-label">20psi超压半径</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.thermal_50km ? (result.blast_effects.thermal_50km / 1e6).toFixed(1) : 0}MJ/m²</div>
                    <div class="stat-label">50km热辐射</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.population_loss !== undefined ? result.population_loss.toLocaleString() : 'N/A'}</div>
                    <div class="stat-label">人口损失</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${formatEconomicLoss(result.building_loss)}</div>
                    <div class="stat-label">建筑损失</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${formatEconomicLoss(result.total_economic_loss)}</div>
                    <div class="stat-label">总经济损失</div>
                </div>
            `;
            
            // 计算受影响城市
            const affectedCities = [];
            const impactPoint = selectedLocation;
            
            console.log(`影响半径: ${impactRadius/1000}km`); // 调试信息
            
            majorCities.forEach(city => {
                const distance = impactPoint.distanceTo([city.lat, city.lng]);
                console.log(`${city.name}: 距离 ${distance/1000}km`); // 调试信息
                
                if (distance <= impactRadius) {
                    affectedCities.push({
                        ...city,
                        distance: Math.round(distance / 1000)
                    });
                }
            });
            
            console.log(`受影响城市数量: ${affectedCities.length}`); // 调试信息

            // 按距离排序
            affectedCities.sort((a, b) => a.distance - b.distance);

            // 显示受影响城市
            let citiesHtml = '';
            
            if (affectedCities.length === 0) {
                citiesHtml += `
                    <div style="color: #00aa00; margin-bottom: 10px; font-weight: bold;">
                        ✅ 撞击地点位于偏远地区，无城市受影响
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        由于撞击地点远离城市，此次撞击不会造成人口损失和经济损失。
                    </div>
                `;
            } else {
                citiesHtml += `
                    <div style="color: #ff4444; margin-bottom: 10px; font-weight: bold;">
                        🚨 受影响城市 (${affectedCities.length}个)：
                    </div>
                    ${affectedCities.map(city => `
                        <div class="city-item" style="color: #ff4444; font-weight: bold;">
                            <div class="city-name">${city.name}</div>
                            <div class="city-info">${city.country} | ${city.distance}km | ${city.population.toLocaleString()}人</div>
                        </div>
                    `).join('')}
                `;
            }
            
            
            citiesDiv.innerHTML = citiesHtml;

            resultsDiv.style.display = 'block';
        }

        // 更新状态指示器
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            const statusMap = {
                'ready': { class: 'status-ready', text: '● 准备就绪' },
                'selected': { class: 'status-selected', text: '● 已选择地点' },
                'simulating': { class: 'status-simulating', text: '● 计算中...' },
                'error': { class: 'status-error', text: '● 错误' }
            };
            
            const status = statusMap[type];
            statusEl.innerHTML = `<span class="${status.class}">${status.text}</span>`;
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // 隐藏错误信息
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // 设置图层控制
        function setupLayerControls() {
            // OpenStreetMap控制
            document.getElementById('osm-layer').addEventListener('change', function() {
                if (this.checked) {
                    // 移除所有图层
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // 添加OSM图层
                    activeLayers.osm.addTo(map);
                }
            });

            // 地形图控制
            document.getElementById('terrain-layer').addEventListener('change', function() {
                if (this.checked) {
                    // 移除所有图层
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // 添加地形图层
                    activeLayers.terrain.addTo(map);
                }
            });

            // 深色主题控制
            document.getElementById('dark-layer').addEventListener('change', function() {
                if (this.checked) {
                    // 移除所有图层
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // 添加深色图层
                    activeLayers.dark.addTo(map);
                }
            });

            // Esri地图控制
            document.getElementById('esri-layer').addEventListener('change', function() {
                if (this.checked) {
                    // 移除所有图层
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // 添加Esri图层
                    activeLayers.esri.addTo(map);
                }
            });

            // 卫星影像控制
            document.getElementById('imagery-layer').addEventListener('change', function() {
                if (this.checked) {
                    // 移除所有图层
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // 添加卫星影像图层
                    activeLayers.imagery.addTo(map);
                }
            });
        }

        async function runDynamicDemo(asteroidId, mode) {
            updateStatus('simulating', '正在准备动态演示...');
            hideError();

            try {
                // 获取小行星数据
                const response = await fetch('http://localhost:8000/asteroids');
                const asteroids = await response.json();
                const asteroid = asteroids.find(a => a.id === asteroidId);
                
                if (!asteroid) {
                    showError('小行星数据未找到');
                    return;
                }

                // 创建演示容器
                createDemoContainer();
                
                if (mode === 'orbit') {
                    await showOrbitDemo(asteroid);
                } else if (mode === '3d') {
                    await show3DOrbitDemo(asteroid);
                } else if (mode === 'simple-3d') {
                    await showSimple3DDemo(asteroid);
                } else {
                    await showImpactDemo(asteroid);
                }

                // 运行静态模拟获取结果
                await runStaticSimulation(asteroidId);

            } catch (error) {
                console.error('Demo error:', error);
                showError('演示失败，请检查后端服务');
                updateStatus('error', '演示失败');
            }
        }

        function createDemoContainer() {
            // 移除现有的演示容器
            const existing = document.getElementById('demo-container');
            if (existing) {
                existing.remove();
            }

            // 创建新的演示容器
            const container = document.createElement('div');
            container.id = 'demo-container';
            container.className = 'demo-container';
            document.getElementById('map').appendChild(container);
        }

        async function showOrbitDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // 显示轨道路径
            const orbitPath = document.createElement('div');
            orbitPath.className = 'orbit-path';
            orbitPath.style.left = '50%';
            orbitPath.style.top = '50%';
            orbitPath.style.width = '200px';
            orbitPath.style.height = '200px';
            orbitPath.style.marginLeft = '-100px';
            orbitPath.style.marginTop = '-100px';
            container.appendChild(orbitPath);

            // 显示小行星在轨道上移动
            const asteroidElement = document.createElement('div');
            asteroidElement.className = 'asteroid-trail';
            asteroidElement.style.left = '50%';
            asteroidElement.style.top = '50%';
            asteroidElement.style.marginLeft = '-2px';
            asteroidElement.style.marginTop = '-2px';
            container.appendChild(asteroidElement);

            // 添加轨道信息
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '10px';
            info.style.borderRadius = '5px';
            info.style.fontSize = '12px';
            info.innerHTML = `
                <div><strong>🛰️ ${asteroid.name}</strong></div>
                <div>直径: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>速度: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>轨道类型: 近地轨道</div>
            `;
            container.appendChild(info);

            // 3秒后清理
            setTimeout(() => {
                container.remove();
            }, 5000);
        }

        async function showImpactDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // 获取地图容器和选中的撞击位置
            const mapContainer = document.getElementById('map');
            const mapRect = mapContainer.getBoundingClientRect();
            
            // 将选中的经纬度转换为屏幕坐标
            const mapBounds = map.getBounds();
            const mapSize = map.getSize();
            
            // 计算撞击点在屏幕上的位置
            const impactPoint = L.latLng(selectedLocation.lat, selectedLocation.lng);
            const impactPixel = map.latLngToContainerPoint(impactPoint);
            
            // 计算轨迹起点（从屏幕边缘随机位置）
            const startX = Math.random() * (mapRect.width - 100) + 50;
            const startY = 50;
            const endX = impactPixel.x;
            const endY = impactPixel.y;

            // 创建小行星轨迹
            const asteroidElement = document.createElement('div');
            asteroidElement.className = 'asteroid-trail';
            asteroidElement.style.left = startX + 'px';
            asteroidElement.style.top = startY + 'px';
            asteroidElement.style.setProperty('--target-x', (endX - startX) + 'px');
            asteroidElement.style.setProperty('--target-y', (endY - startY) + 'px');
            container.appendChild(asteroidElement);

            // 添加小行星信息
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.right = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '10px';
            info.style.borderRadius = '5px';
            info.style.fontSize = '12px';
            info.innerHTML = `
                <div><strong>🚀 ${asteroid.name}</strong></div>
                <div>直径: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>撞击速度: 20,000 m/s</div>
                <div>撞击角度: 45°</div>
            `;
            container.appendChild(info);

            // 撞击瞬间效果
            setTimeout(() => {
                const impactFlash = document.createElement('div');
                impactFlash.className = 'impact-flash';
                impactFlash.style.left = endX + 'px';
                impactFlash.style.top = endY + 'px';
                impactFlash.style.marginLeft = '-10px';
                impactFlash.style.marginTop = '-10px';
                container.appendChild(impactFlash);

                // 添加撞击信息
                const impactInfo = document.createElement('div');
                impactInfo.style.position = 'absolute';
                impactInfo.style.bottom = '20px';
                impactInfo.style.left = '50%';
                impactInfo.style.transform = 'translateX(-50%)';
                impactInfo.style.background = 'rgba(255, 0, 0, 0.9)';
                impactInfo.style.color = 'white';
                impactInfo.style.padding = '15px';
                impactInfo.style.borderRadius = '10px';
                impactInfo.style.fontSize = '14px';
                impactInfo.style.fontWeight = 'bold';
                impactInfo.style.textAlign = 'center';
                impactInfo.innerHTML = '💥 撞击发生！';
                container.appendChild(impactInfo);
            }, 2500);

            // 5秒后清理
            setTimeout(() => {
                container.remove();
            }, 5000);
        }

        async function show3DOrbitDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // 检查Three.js是否加载
            if (typeof THREE === 'undefined') {
                showError('Three.js库未加载，请刷新页面重试');
                return;
            }
            
            try {
                // 创建3D场景
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ alpha: true });
                
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                renderer.setClearColor(0x000000, 0);
            container.appendChild(renderer.domElement);

                // 添加轨道控制器（如果可用）
                let controls = null;
                if (typeof THREE.OrbitControls !== 'undefined') {
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
                }

            // 创建地球
            const earthGeometry = new THREE.SphereGeometry(2, 32, 32);
            const earthMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x4A90E2,
                shininess: 100
            });
            const earth = new THREE.Mesh(earthGeometry, earthMaterial);
            scene.add(earth);

            // 创建小行星
            const asteroidGeometry = new THREE.SphereGeometry(0.1, 8, 8);
            const asteroidMaterial = new THREE.MeshPhongMaterial({ color: 0xff6b6b });
            const asteroidMesh = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
            scene.add(asteroidMesh);

            // 创建轨道路径
            const orbitGeometry = new THREE.RingGeometry(3, 3.1, 64);
            const orbitMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00aaff, 
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.3
            });
            const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
            orbit.rotation.x = Math.PI / 2;
            scene.add(orbit);

            // 添加光照
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // 设置相机位置
            camera.position.set(8, 4, 8);
            controls.target.set(0, 0, 0);

            // 添加信息面板
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '15px';
            info.style.borderRadius = '8px';
            info.style.fontSize = '14px';
            info.style.zIndex = '1000';
            info.innerHTML = `
                <div><strong>🛰️ ${asteroid.name}</strong></div>
                <div>直径: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>速度: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>轨道类型: 近地轨道</div>
                <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                    使用鼠标拖拽旋转视角，滚轮缩放
                </div>
            `;
            container.appendChild(info);

            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '✕ 关闭3D视图';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '20px';
            closeBtn.style.right = '20px';
            closeBtn.style.background = 'rgba(255, 0, 0, 0.8)';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.padding = '10px 15px';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.zIndex = '1000';
            closeBtn.onclick = () => {
                container.remove();
            };
            container.appendChild(closeBtn);

                // 动画循环
                let angle = 0;
                function animate() {
                    requestAnimationFrame(animate);
                    
                    // 小行星轨道运动
                    angle += 0.02;
                    asteroidMesh.position.x = Math.cos(angle) * 3;
                    asteroidMesh.position.z = Math.sin(angle) * 3;
                    asteroidMesh.position.y = Math.sin(angle * 2) * 0.5;

                    // 地球自转
                    earth.rotation.y += 0.01;

                    // 更新控制器（如果可用）
                    if (controls) {
                        controls.update();
                    }
                    renderer.render(scene, camera);
                }
            animate();

                // 10秒后自动关闭
                setTimeout(() => {
                    if (container.parentNode) {
                        container.remove();
                    }
                }, 10000);
                
            } catch (error) {
                console.error('3D演示错误:', error);
                showError('3D演示初始化失败: ' + error.message);
                // 清理容器
                if (container.parentNode) {
                    container.remove();
                }
            }
        }

        async function showSimple3DDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // 创建简化的3D演示（使用CSS 3D变换）
            const earth = document.createElement('div');
            earth.style.width = '100px';
            earth.style.height = '100px';
            earth.style.borderRadius = '50%';
            earth.style.background = 'radial-gradient(circle at 30% 30%, #4A90E2, #2E5BBA)';
            earth.style.position = 'absolute';
            earth.style.left = '50%';
            earth.style.top = '50%';
            earth.style.marginLeft = '-50px';
            earth.style.marginTop = '-50px';
            earth.style.boxShadow = '0 0 20px rgba(74, 144, 226, 0.5)';
            earth.style.animation = 'earthRotate 10s linear infinite';
            container.appendChild(earth);

            // 创建小行星
            const asteroidElement = document.createElement('div');
            asteroidElement.style.width = '8px';
            asteroidElement.style.height = '8px';
            asteroidElement.style.borderRadius = '50%';
            asteroidElement.style.background = '#ff6b6b';
            asteroidElement.style.position = 'absolute';
            asteroidElement.style.left = '50%';
            asteroidElement.style.top = '50%';
            asteroidElement.style.marginLeft = '-4px';
            asteroidElement.style.marginTop = '-4px';
            asteroidElement.style.boxShadow = '0 0 10px #ff6b6b';
            asteroidElement.style.animation = 'asteroidOrbit 5s linear infinite';
            container.appendChild(asteroidElement);

            // 创建轨道路径
            const orbit = document.createElement('div');
            orbit.style.width = '200px';
            orbit.style.height = '200px';
            orbit.style.border = '2px dashed #00aaff';
            orbit.style.borderRadius = '50%';
            orbit.style.position = 'absolute';
            orbit.style.left = '50%';
            orbit.style.top = '50%';
            orbit.style.marginLeft = '-100px';
            orbit.style.marginTop = '-100px';
            orbit.style.opacity = '0.5';
            container.appendChild(orbit);

            // 添加信息面板
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '15px';
            info.style.borderRadius = '8px';
            info.style.fontSize = '14px';
            info.style.zIndex = '1000';
            info.innerHTML = `
                <div><strong>🛰️ ${asteroid.name}</strong></div>
                <div>直径: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>速度: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>轨道类型: 近地轨道</div>
                <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                    简化3D演示 - 使用CSS动画
                </div>
            `;
            container.appendChild(info);

            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '✕ 关闭演示';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '20px';
            closeBtn.style.right = '20px';
            closeBtn.style.background = 'rgba(255, 0, 0, 0.8)';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.padding = '10px 15px';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.zIndex = '1000';
            closeBtn.onclick = () => {
                container.remove();
            };
            container.appendChild(closeBtn);

            // 添加CSS动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes earthRotate {
                    from { transform: rotateY(0deg); }
                    to { transform: rotateY(360deg); }
                }
                @keyframes asteroidOrbit {
                    from { 
                        transform: rotate(0deg) translateX(100px) rotate(0deg);
                    }
                    to { 
                        transform: rotate(360deg) translateX(100px) rotate(-360deg);
                    }
                }
            `;
            document.head.appendChild(style);

            // 8秒后自动关闭
            setTimeout(() => {
                if (container.parentNode) {
                    container.remove();
                }
                document.head.removeChild(style);
            }, 8000);
        }

        async function showImpactTrajectory(asteroidId, show3DEffect = true) {
            // 获取小行星数据
            const response = await fetch('http://localhost:8000/asteroids');
            const asteroids = await response.json();
            const asteroid = asteroids.find(a => a.id === asteroidId);
            
            if (!asteroid) return;

            // 创建轨迹容器
            const container = document.createElement('div');
            container.id = 'trajectory-container';
            container.style.position = 'absolute';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '1000';
            document.getElementById('map').appendChild(container);

            // 计算撞击点在屏幕上的位置
            const impactPoint = L.latLng(selectedLocation.lat, selectedLocation.lng);
            const impactPixel = map.latLngToContainerPoint(impactPoint);

            // 创建轨迹效果
            await create3DTrajectory(container, impactPixel, asteroid, show3DEffect);

            // 显示经纬度信息
            if (document.getElementById('show-coordinates').checked) {
                showCoordinates(selectedLocation.lat, selectedLocation.lng);
            }
            
            // 显示轨道信息
            showOrbitalInfo(asteroid);

            // 3秒后清理轨迹，但不显示影响圈层
            setTimeout(() => {
                if (container.parentNode) {
                    container.remove();
                }
            }, 3000);
        }

        function showCoordinates(lat, lng) {
            // 创建经纬线网格
            createGridLines(lat, lng);
            
            // 创建经纬度显示框
            const coordBox = document.createElement('div');
            coordBox.id = 'coordinates-display';
            coordBox.style.position = 'absolute';
            coordBox.style.top = '20px';
            coordBox.style.right = '20px';
            coordBox.style.background = 'rgba(0, 0, 0, 0.8)';
            coordBox.style.color = 'white';
            coordBox.style.padding = '10px';
            coordBox.style.borderRadius = '5px';
            coordBox.style.fontSize = '14px';
            coordBox.style.zIndex = '1001';
            coordBox.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">📍 撞击坐标</div>
                <div>纬度: ${lat ? lat.toFixed(4) : 'N/A'}°</div>
                <div>经度: ${lng ? lng.toFixed(4) : 'N/A'}°</div>
            `;
            
            document.getElementById('map').appendChild(coordBox);
            
            // 5秒后自动隐藏
            setTimeout(() => {
                if (coordBox.parentNode) {
                    coordBox.remove();
                }
                // 清除网格线
                clearGridLines();
            }, 5000);
        }

        function createGridLines(lat, lng) {
            // 创建经线（垂直线）
            const meridian = L.polyline([
                [90, lng], [-90, lng]
            ], {
                color: '#ff6b6b',
                weight: 2,
                opacity: 0.8,
                dashArray: '5, 5'
            }).addTo(map);
            meridian._gridId = 'meridian';

            // 创建纬线（水平线）
            const parallel = L.polyline([
                [lat, -180], [lat, 180]
            ], {
                color: '#ff6b6b',
                weight: 2,
                opacity: 0.8,
                dashArray: '5, 5'
            }).addTo(map);
            parallel._gridId = 'parallel';

            // 添加标签
            const latLabel = L.marker([lat, lng + 5], {
                icon: L.divIcon({
                    className: 'grid-label',
                    html: `${lat ? lat.toFixed(2) : 'N/A'}°`,
                    iconSize: [50, 20],
                    iconAnchor: [25, 10]
                })
            }).addTo(map);
            latLabel._gridId = 'lat-label';

            const lngLabel = L.marker([lat + 2, lng], {
                icon: L.divIcon({
                    className: 'grid-label',
                    html: `${lng ? lng.toFixed(2) : 'N/A'}°`,
                    iconSize: [50, 20],
                    iconAnchor: [25, 10]
                })
            }).addTo(map);
            lngLabel._gridId = 'lng-label';
        }

        function clearGridLines() {
            map.eachLayer(function(layer) {
                if (layer._gridId) {
                    map.removeLayer(layer);
                }
            });
        }

        function showOrbitalInfo(asteroid) {
            const orbitalData = asteroid.orbital_data || {};
            const closeApproachData = asteroid.close_approach_data || [];
            
            // 创建轨道信息显示框
            const orbitalBox = document.createElement('div');
            orbitalBox.id = 'orbital-info';
            orbitalBox.style.position = 'absolute';
            orbitalBox.style.bottom = '20px';
            orbitalBox.style.right = '20px';
            orbitalBox.style.background = 'rgba(0, 0, 0, 0.8)';
            orbitalBox.style.color = 'white';
            orbitalBox.style.padding = '10px';
            orbitalBox.style.borderRadius = '5px';
            orbitalBox.style.fontSize = '12px';
            orbitalBox.style.zIndex = '1001';
            orbitalBox.style.maxWidth = '250px';
            
            let orbitalInfo = `
                <div style="font-weight: bold; margin-bottom: 5px;">🛰️ 轨道信息</div>
                <div>小行星: ${asteroid.name}</div>
            `;
            
            if (orbitalData && orbitalData.inclination && !isNaN(parseFloat(orbitalData.inclination))) {
                orbitalInfo += `<div>轨道倾角: ${parseFloat(orbitalData.inclination).toFixed(2)}°</div>`;
            }
            if (orbitalData && orbitalData.eccentricity && !isNaN(parseFloat(orbitalData.eccentricity))) {
                orbitalInfo += `<div>偏心率: ${parseFloat(orbitalData.eccentricity).toFixed(3)}</div>`;
            }
            if (orbitalData && orbitalData.orbital_period && !isNaN(parseFloat(orbitalData.orbital_period))) {
                orbitalInfo += `<div>轨道周期: ${parseFloat(orbitalData.orbital_period).toFixed(1)}天</div>`;
            }
            if (closeApproachData.length > 0) {
                const approach = closeApproachData[0];
                if (approach && approach.relative_velocity && approach.relative_velocity.kilometers_per_second) {
                    orbitalInfo += `<div>接近速度: ${parseFloat(approach.relative_velocity.kilometers_per_second).toFixed(1)} km/s</div>`;
                }
            }
            
            orbitalBox.innerHTML = orbitalInfo;
            document.getElementById('map').appendChild(orbitalBox);
            
            // 5秒后自动隐藏
            setTimeout(() => {
                if (orbitalBox.parentNode) {
                    orbitalBox.remove();
                }
            }, 5000);
        }

        async function showImpactZones(lat, lng, asteroid) {
            // 使用后端API的精确计算
            try {
            const simulationData = {
                    asteroid_id: asteroid.id,
                    impact_latitude: lat,
                    impact_longitude: lng,
                    impact_angle: 45,
                    impact_velocity: parseFloat(asteroid.velocity) || 20000,
                    target_type: "continental_crust"
                };
                
                const response = await fetch('http://localhost:8000/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(simulationData)
                });

                if (!response.ok) {
                    throw new Error('模拟失败');
                }

                const result = await response.json();
                
                // 使用后端计算的精确数据
                const craterDiameter = result.crater_diameter; // 米
                const craterRadius = craterDiameter / 2000; // 转换为公里半径
                
                // 基于精确陨石坑直径计算其他圈层
                const immediateRadius = craterRadius * 5; // 立即影响区域
                const severeRadius = craterRadius * 15; // 严重影响区域
                const moderateRadius = craterRadius * 30; // 中等影响区域
                const lightRadius = craterRadius * 50; // 轻微影响区域
                
                // 创建不同圈层
                const zones = [
                    {
                        radius: craterRadius,
                        color: '#ff0000',
                        opacity: 0.8,
                        label: '陨石坑',
                        description: '直接撞击区域'
                    },
                    {
                        radius: immediateRadius,
                        color: '#ff4400',
                        opacity: 0.6,
                        label: '立即影响区',
                        description: '爆炸、地震、热辐射'
                    },
                    {
                        radius: severeRadius,
                        color: '#ff8800',
                        opacity: 0.4,
                        label: '严重影响区',
                        description: '强烈地震、冲击波'
                    },
                    {
                        radius: moderateRadius,
                        color: '#ffaa00',
                        opacity: 0.3,
                        label: '中等影响区',
                        description: '中等地震、碎片飞溅'
                    },
                    {
                        radius: lightRadius,
                        color: '#ffcc00',
                        opacity: 0.2,
                        label: '轻微影响区',
                        description: '轻微地震、声波'
                    }
                ];
                
                // 创建影响圈层
                createImpactCircles(lat, lng, zones);
                
                // 添加图例
                showImpactLegend(zones);
                
            } catch (error) {
                console.error('获取精确数据失败，使用简化计算:', error);
                // 回退到简化计算
                const diameter = (parseFloat(asteroid.diameter_min) + parseFloat(asteroid.diameter_max)) / 2;
                const craterRadius = Math.max(0.1, diameter * 0.1);
                const immediateRadius = craterRadius * 5;
                const severeRadius = craterRadius * 15;
                const moderateRadius = craterRadius * 30;
                const lightRadius = craterRadius * 50;
                
                const zones = [
                    { radius: craterRadius, color: '#ff0000', opacity: 0.8, label: '陨石坑', description: '直接撞击区域' },
                    { radius: immediateRadius, color: '#ff4400', opacity: 0.6, label: '立即影响区', description: '爆炸、地震、热辐射' },
                    { radius: severeRadius, color: '#ff8800', opacity: 0.4, label: '严重影响区', description: '强烈地震、冲击波' },
                    { radius: moderateRadius, color: '#ffaa00', opacity: 0.3, label: '中等影响区', description: '中等地震、碎片飞溅' },
                    { radius: lightRadius, color: '#ffcc00', opacity: 0.2, label: '轻微影响区', description: '轻微地震、声波' }
                ];
                
                createImpactCircles(lat, lng, zones);
                showImpactLegend(zones);
            }
        }

        function createImpactCircles(lat, lng, zones) {
            // 创建影响圈层
            zones.forEach((zone, index) => {
                const circle = L.circle([lat, lng], {
                    radius: zone.radius * 1000, // 转换为米
                    color: zone.color,
                    fillColor: zone.color,
                    fillOpacity: zone.opacity,
                    weight: 2,
                    dashArray: index === 0 ? '0' : '5, 5' // 陨石坑实线，其他虚线
                }).addTo(map);
                
                circle._impactZone = true;
                
                // 添加标签
                if (zone.radius > 1) { // 只对较大的圈层添加标签
                    const label = L.marker([lat + zone.radius * 0.01, lng + zone.radius * 0.01], {
                        icon: L.divIcon({
                            className: 'impact-zone-label',
                            html: `
                                <div style="background: ${zone.color}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; text-align: center; border: 1px solid white;">
                                    ${zone.label}<br>
                                    <small>${zone.radius ? zone.radius.toFixed(1) : 'N/A'}km</small>
                </div>
                            `,
                            iconSize: [60, 30],
                            iconAnchor: [30, 15]
                        })
                    }).addTo(map);
                    label._impactZone = true;
                }
            });
        }

        function showImpactLegend(zones) {
            const legend = document.createElement('div');
            legend.id = 'impact-legend';
            legend.style.position = 'absolute';
            legend.style.top = '20px';
            legend.style.right = '20px';
            legend.style.background = 'rgba(0, 0, 0, 0.9)';
            legend.style.color = 'white';
            legend.style.padding = '15px';
            legend.style.borderRadius = '8px';
            legend.style.fontSize = '12px';
            legend.style.zIndex = '1001';
            legend.style.maxWidth = '220px';
            legend.style.border = '2px solid #ff6b6b';
            legend.style.boxShadow = '0 4px 8px rgba(0,0,0,0.5)';
            
            let legendHtml = '<h4 style="margin: 0 0 10px 0; color: #ff6b6b; text-align: center;">💥 撞击影响范围</h4>';
            
            // 显示所有5个圈层
            zones.forEach((zone, index) => {
                const lineStyle = index === 0 ? 'solid' : 'dashed';
                legendHtml += `
                    <div style="display: flex; align-items: center; margin: 8px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                        <div style="width: 20px; height: 3px; background: ${zone.color}; margin-right: 10px; border-radius: 2px; border: 1px solid white; border-style: ${lineStyle};"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: ${zone.color};">${zone.label}</div>
                            <div style="font-size: 10px; color: #ccc;">${zone.radius ? (zone.radius/1000).toFixed(1) : 'N/A'}km - ${zone.description}</div>
                </div>
                </div>
                `;
            });
            
            legend.innerHTML = legendHtml;
            document.getElementById('map').appendChild(legend);
            
            // 15秒后只隐藏图例，保留影响圈层
            setTimeout(() => {
                if (legend.parentNode) {
                    legend.remove();
                }
                // 不再自动清除影响圈层，让它们持续显示
            }, 15000);
        }

        function clearImpactZones() {
            map.eachLayer(function(layer) {
                if (layer._impactZone) {
                    map.removeLayer(layer);
                }
            });
        }

        function clearAllDisplays() {
            // 清除所有影响圈层
            clearImpactZones();
            
            // 清除撞击标记
            if (impactMarker) {
                map.removeLayer(impactMarker);
                impactMarker = null;
            }
            if (currentImpactMarker) {
                map.removeLayer(currentImpactMarker);
                currentImpactMarker = null;
            }
            if (impactCircle) {
                map.removeLayer(impactCircle);
                impactCircle = null;
            }
            
            // 清除城市标记
            cityMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            cityMarkers = [];
            
            // 清除轨迹容器
            const trajectoryContainer = document.getElementById('trajectory-container');
            if (trajectoryContainer) {
                trajectoryContainer.remove();
            }
            
            // 清除经纬线网格
            map.eachLayer(function(layer) {
                if (layer._gridId) {
                    map.removeLayer(layer);
                }
            });
            
            // 清除信息面板
            const orbitalInfo = document.getElementById('orbital-info');
            if (orbitalInfo) {
                orbitalInfo.remove();
            }
            
            const historyInfo = document.getElementById('history-info');
            if (historyInfo) {
                historyInfo.remove();
            }
            
            console.log('All displays cleared');
        }

        // 历史模拟查询功能
        function showHistoryModal() {
            document.getElementById('history-modal').style.display = 'block';
            loadHistoryData();
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
        }

        async function loadHistoryData() {
            try {
                // 模拟历史数据（实际应用中应该从后端获取）
                const mockHistory = [
                    {
                        id: 1,
                        asteroidName: "2062 Aten (1976 AA)",
                        date: "2024-01-15",
                        location: "33.14°, 120.59°",
                        craterDiameter: 1000,
                        impactVelocity: 11300,
                        seismicMagnitude: 11.3,
                        tsunamiHeight: 61,
                        populationLoss: 54772,
                        buildingLoss: 362.3,
                        totalEconomicLoss: 83.2
                    },
                    {
                        id: 2,
                        asteroidName: "99942 Apophis",
                        date: "2024-01-10",
                        location: "40.71°, -74.01°",
                        craterDiameter: 2500,
                        impactVelocity: 15000,
                        seismicMagnitude: 12.1,
                        tsunamiHeight: 85,
                        populationLoss: 125000,
                        buildingLoss: 850.7,
                        totalEconomicLoss: 195.3
                    },
                    {
                        id: 3,
                        asteroidName: "101955 Bennu",
                        date: "2024-01-05",
                        location: "51.51°, -0.13°",
                        craterDiameter: 800,
                        impactVelocity: 9800,
                        seismicMagnitude: 10.8,
                        tsunamiHeight: 45,
                        populationLoss: 32000,
                        buildingLoss: 180.5,
                        totalEconomicLoss: 42.1
                    }
                ];
                
                displayHistoryResults(mockHistory);
            } catch (error) {
                console.error('加载历史数据失败:', error);
                document.getElementById('history-results').innerHTML = 
                    '<div style="color: #ff4444; text-align: center; padding: 20px;">加载历史数据失败</div>';
            }
        }

        function displayHistoryResults(historyData) {
            const resultsContainer = document.getElementById('history-results');
            
            if (historyData.length === 0) {
                resultsContainer.innerHTML = '<div style="color: #aaa; text-align: center; padding: 20px;">暂无历史模拟数据</div>';
                return;
            }
            
            let html = '';
            historyData.forEach(item => {
                html += `
                    <div class="history-item" onclick="loadHistorySimulation(${item.id})">
                        <h3>${item.asteroidName}</h3>
                        <div class="meta">
                            📅 ${item.date} | 📍 ${item.location}
                </div>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-value">${item.craterDiameter}m</div>
                                <div class="stat-label">陨石坑直径</div>
                </div>
                            <div class="stat-item">
                                <div class="stat-value">${item.impactVelocity/1000}km/s</div>
                                <div class="stat-label">撞击速度</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${item.seismicMagnitude}</div>
                                <div class="stat-label">地震震级</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${item.populationLoss.toLocaleString()}</div>
                                <div class="stat-label">人口损失</div>
                            </div>
                        </div>
                </div>
            `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function searchHistory() {
            const asteroidName = document.getElementById('asteroid-name-filter').value.toLowerCase();
            const startDate = document.getElementById('start-date-filter').value;
            const endDate = document.getElementById('end-date-filter').value;
            const location = document.getElementById('location-filter').value.toLowerCase();
            
            // 这里应该调用后端API进行搜索
            // 目前使用模拟数据
            loadHistoryData();
        }

        function loadHistorySimulation(simulationId) {
            // 加载历史模拟到地图上
            console.log('加载历史模拟:', simulationId);
            
            // 模拟历史数据（实际应用中应该从后端获取）
            const mockHistory = [
                {
                    id: 1,
                    asteroidName: "2062 Aten (1976 AA)",
                    date: "2024-01-15",
                    location: "33.14°, 120.59°",
                    lat: 33.14,
                    lng: 120.59,
                    craterDiameter: 1000,
                    impactVelocity: 11300,
                    seismicMagnitude: 11.3,
                    tsunamiHeight: 61,
                    populationLoss: 54772,
                    buildingLoss: 362.3,
                    totalEconomicLoss: 83.2
                },
                {
                    id: 2,
                    asteroidName: "99942 Apophis",
                    date: "2024-01-10",
                    location: "40.71°, -74.01°",
                    lat: 40.71,
                    lng: -74.01,
                    craterDiameter: 2500,
                    impactVelocity: 15000,
                    seismicMagnitude: 12.1,
                    tsunamiHeight: 85,
                    populationLoss: 125000,
                    buildingLoss: 850.7,
                    totalEconomicLoss: 195.3
                },
                {
                    id: 3,
                    asteroidName: "101955 Bennu",
                    date: "2024-01-05",
                    location: "51.51°, -0.13°",
                    lat: 51.51,
                    lng: -0.13,
                    craterDiameter: 800,
                    impactVelocity: 9800,
                    seismicMagnitude: 10.8,
                    tsunamiHeight: 45,
                    populationLoss: 32000,
                    buildingLoss: 180.5,
                    totalEconomicLoss: 42.1
                }
            ];
            
            const historyItem = mockHistory.find(item => item.id === simulationId);
            if (historyItem) {
                // 清除之前的影响圈层
                clearImpactZones();
                
                // 移动到撞击位置，使用合适的缩放级别
                const maxRadius = Math.max(historyItem.craterDiameter / 2000 * 50, 50); // 确保能看到最大圈层
                const zoomLevel = Math.max(4, Math.min(8, 10 - Math.log2(maxRadius / 100)));
                map.setView([historyItem.lat, historyItem.lng], zoomLevel);
                
                // 显示影响圈层
                showHistoryImpactZones(historyItem);
                
                // 显示历史模拟信息
                showHistoryInfo(historyItem);
                
                // 关闭模态框
                closeHistoryModal();
            }
        }

        function showHistoryImpactZones(historyItem) {
            const lat = historyItem.lat;
            const lng = historyItem.lng;
            const craterDiameter = historyItem.craterDiameter; // 米
            const craterRadius = craterDiameter / 2; // 转换为米半径，与实时模拟保持一致
            
            console.log('历史模拟圈层计算:', {
                craterDiameter,
                craterRadius,
                lat,
                lng
            });
            
            // 确保最小半径，避免圈层太小看不见
            const minRadius = 10; // 最小10公里
            const adjustedCraterRadius = Math.max(craterRadius, minRadius);
            
            // 基于调整后的陨石坑半径计算其他圈层
            const immediateRadius = adjustedCraterRadius * 5; // 立即影响区域
            const severeRadius = adjustedCraterRadius * 15; // 严重影响区域
            const moderateRadius = adjustedCraterRadius * 30; // 中等影响区域
            const lightRadius = adjustedCraterRadius * 50; // 轻微影响区域
            
            // 创建不同圈层
            const zones = [
                {
                    radius: adjustedCraterRadius,
                    color: '#ff0000',
                    opacity: 0.8,
                    label: '陨石坑',
                    description: '直接撞击区域'
                },
                {
                    radius: immediateRadius,
                    color: '#ff4400',
                    opacity: 0.6,
                    label: '立即影响区',
                    description: '爆炸、地震、热辐射'
                },
                {
                    radius: severeRadius,
                    color: '#ff8800',
                    opacity: 0.4,
                    label: '严重影响区',
                    description: '强烈地震、冲击波'
                },
                {
                    radius: moderateRadius,
                    color: '#ffaa00',
                    opacity: 0.3,
                    label: '中等影响区',
                    description: '中等地震、碎片飞溅'
                },
                {
                    radius: lightRadius,
                    color: '#ffcc00',
                    opacity: 0.2,
                    label: '轻微影响区',
                    description: '轻微地震、声波'
                }
            ];
            
            console.log('历史模拟圈层数据:', zones);
            
            // 创建影响圈层
            createImpactCircles(lat, lng, zones);
            
            // 添加历史标记
            const historyMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'history-marker',
                    html: `
                        <div style="background: #4a90e2; color: white; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; text-align: center; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                            📊 历史模拟<br>
                            <small>${historyItem.asteroidName}</small>
                        </div>
                    `,
                    iconSize: [80, 40],
                    iconAnchor: [40, 20]
                })
            }).addTo(map);
            historyMarker._impactZone = true;
            
            // 添加图例
            showImpactLegend(zones);
        }

        function showHistoryInfo(historyItem) {
            // 创建历史信息显示框
            const historyInfo = document.createElement('div');
            historyInfo.id = 'history-info';
            historyInfo.style.position = 'absolute';
            historyInfo.style.top = '20px';
            historyInfo.style.left = '20px';
            historyInfo.style.background = 'rgba(74, 144, 226, 0.9)';
            historyInfo.style.color = 'white';
            historyInfo.style.padding = '15px';
            historyInfo.style.borderRadius = '8px';
            historyInfo.style.fontSize = '14px';
            historyInfo.style.zIndex = '1001';
            historyInfo.style.maxWidth = '300px';
            historyInfo.style.border = '2px solid #4a90e2';
            
            historyInfo.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">
                    📊 历史模拟详情
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>小行星:</strong> ${historyItem.asteroidName}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>模拟日期:</strong> ${historyItem.date}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>撞击位置:</strong> ${historyItem.location}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>陨石坑直径:</strong> ${historyItem.craterDiameter}m
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>撞击速度:</strong> ${historyItem.impactVelocity ? (historyItem.impactVelocity/1000).toFixed(1) : 'N/A'}km/s
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>地震震级:</strong> ${historyItem.seismicMagnitude}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>海啸高度:</strong> ${historyItem.tsunamiHeight}m
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>人口损失:</strong> ${historyItem.populationLoss.toLocaleString()}人
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>建筑损失:</strong> $${historyItem.buildingLoss}B
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>总经济损失:</strong> $${historyItem.totalEconomicLoss}B
                </div>
                <button onclick="clearHistoryDisplay()" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                    ✕ 清除显示
                </button>
            `;
            
            document.getElementById('map').appendChild(historyInfo);
        }

        function clearHistoryDisplay() {
            // 清除历史信息显示
            const historyInfo = document.getElementById('history-info');
            if (historyInfo) {
                historyInfo.remove();
            }
            
            // 清除影响圈层
            clearImpactZones();
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('history-modal');
            if (event.target === modal) {
                closeHistoryModal();
            }
        }

        // 折叠/展开结果面板
        function toggleResults() {
            const resultsDiv = document.getElementById('results');
            const toggleBtn = document.getElementById('results-toggle');
            
            if (resultsDiv.classList.contains('collapsed')) {
                resultsDiv.classList.remove('collapsed');
                toggleBtn.textContent = '−';
                toggleBtn.title = '折叠面板';
            } else {
                resultsDiv.classList.add('collapsed');
                toggleBtn.textContent = '+';
                toggleBtn.title = '展开面板';
            }
        }

        async function create3DTrajectory(container, impactPixel, asteroid, show3DEffect = true) {
            // 根据小行星轨道数据计算真实轨迹
            const orbitalData = asteroid.orbital_data || {};
            const closeApproachData = asteroid.close_approach_data || [];
            
            console.log('🌍 创建真实轨迹模拟');
            console.log('小行星:', asteroid.name);
            console.log('轨道数据:', orbitalData);
            console.log('接近数据:', closeApproachData);
            
            // 计算撞击角度（基于轨道倾角）
            let impactAngle = 45; // 默认角度
            if (orbitalData.inclination && !isNaN(parseFloat(orbitalData.inclination))) {
                const inclination = parseFloat(orbitalData.inclination);
                // 轨道倾角越大，撞击角度越大（更接近水平）
                impactAngle = Math.min(85, Math.max(15, inclination * 0.8 + 20));
                console.log('📐 轨道倾角:', inclination, '° → 撞击角度:', impactAngle, '°');
            }
            
            // 根据轨道偏心率计算轨迹弯曲度
            let trajectoryCurvature = 0;
            if (orbitalData.eccentricity && !isNaN(parseFloat(orbitalData.eccentricity))) {
                const eccentricity = parseFloat(orbitalData.eccentricity);
                // 偏心率越大，轨迹越弯曲
                trajectoryCurvature = Math.min(30, Math.max(-30, (eccentricity - 0.5) * 60));
                console.log('🔄 轨道偏心率:', eccentricity, '→ 轨迹弯曲度:', trajectoryCurvature, '°');
            }
            
            // 计算轨迹方向（基于轨道参数和接近方向）
            let trajectoryDirection = 0; // 默认从上方
            let trajectoryLength = 200;
            let animationDuration = 3000;
            let approachDirection = 0; // 接近方向角度
            
            if (closeApproachData.length > 0) {
                const approach = closeApproachData[0];
                const relativeVelocity = approach.relative_velocity || {};
                
                // 根据相对速度计算轨迹长度和动画时长
                if (relativeVelocity.kilometers_per_second && !isNaN(parseFloat(relativeVelocity.kilometers_per_second))) {
                    const velocity = parseFloat(relativeVelocity.kilometers_per_second);
                    trajectoryLength = Math.min(500, Math.max(200, velocity * 10));
                    animationDuration = Math.min(6000, Math.max(2000, 5000 - velocity * 40));
                    
                    // 根据速度计算基础轨迹方向
                    trajectoryDirection = Math.min(60, Math.max(-60, (velocity - 15) * 2));
                    
                    console.log('🚀 相对速度:', velocity, 'km/s → 长度:', trajectoryLength, 'px 时长:', animationDuration, 'ms');
                }
                
                // 根据轨道倾角计算接近方向
                if (orbitalData.inclination && !isNaN(parseFloat(orbitalData.inclination))) {
                    const inclination = parseFloat(orbitalData.inclination);
                    // 轨道倾角影响接近方向（0-180度）
                    approachDirection = (inclination * 2) % 360;
                    console.log('📐 轨道倾角:', inclination, '° → 接近方向:', approachDirection, '°');
                }
                
                // 根据轨道偏心率计算轨迹弯曲
                if (orbitalData.eccentricity && !isNaN(parseFloat(orbitalData.eccentricity))) {
                    const eccentricity = parseFloat(orbitalData.eccentricity);
                    // 偏心率越大，轨迹越弯曲
                    const curvature = (eccentricity - 0.5) * 30;
                    approachDirection += curvature;
                    console.log('🔄 轨道偏心率:', eccentricity, '→ 轨迹弯曲:', curvature, '°');
                }
                
                // 根据轨道周期调整轨迹特征
                if (orbitalData.orbital_period && !isNaN(parseFloat(orbitalData.orbital_period))) {
                    const period = parseFloat(orbitalData.orbital_period);
                    // 轨道周期越长，轨迹越平缓
                    const periodEffect = Math.min(20, Math.max(-20, (period - 365) * 0.05));
                    approachDirection += periodEffect;
                    console.log('⏰ 轨道周期:', period, '天 → 轨迹调整:', periodEffect, '°');
                }
            }
            
            // 计算最终轨迹方向（结合所有因素）
            const finalDirection = (trajectoryDirection + approachDirection + trajectoryCurvature) % 360;
            console.log('🎯 最终轨迹方向:', finalDirection, '° (基础:', trajectoryDirection, '° + 接近:', approachDirection, '° + 弯曲:', trajectoryCurvature, '°)');
            
            // 根据轨道周期调整动画速度
            if (orbitalData.orbital_period && !isNaN(parseFloat(orbitalData.orbital_period))) {
                const period = parseFloat(orbitalData.orbital_period);
                // 轨道周期越长，动画越慢
                animationDuration = Math.min(6000, Math.max(2000, period * 0.1));
                console.log('⏰ 轨道周期:', period, '天 → 动画时长:', animationDuration, 'ms');
            }
            
            // 计算最终轨迹参数（使用新的方向计算）
            const angleRad = (finalDirection * Math.PI) / 180;
            const startX = impactPixel.x - Math.cos(angleRad) * trajectoryLength;
            const startY = impactPixel.y - Math.sin(angleRad) * trajectoryLength;
            
            console.log('🎯 最终轨迹参数:');
            console.log('  起始位置:', startX, startY);
            console.log('  撞击位置:', impactPixel.x, impactPixel.y);
            console.log('  轨迹长度:', trajectoryLength);
            console.log('  总角度:', impactAngle + trajectoryDirection + trajectoryCurvature, '°');
            
            // 不再创建轨迹线，只保留小行星和尾迹效果

            // 创建小行星（基于真实数据）
            const asteroidElement = document.createElement('div');
            asteroidElement.style.position = 'absolute';
            asteroidElement.style.left = startX + 'px';
            asteroidElement.style.top = startY + 'px';
            
            // 根据小行星大小调整显示尺寸
            const diameter = asteroid.diameter_min || 100;
            const displaySize = Math.max(8, Math.min(20, diameter / 50));
            asteroidElement.style.width = displaySize + 'px';
            asteroidElement.style.height = displaySize + 'px';
            
            // 根据小行星类型选择颜色
            let asteroidColor = '#ff6b6b';
            if (asteroid.orbital_data && asteroid.orbital_data.orbit_class) {
                // 确保orbit_class是字符串类型
                const orbitClass = String(asteroid.orbital_data.orbit_class).toLowerCase();
                if (orbitClass.includes('apollo')) asteroidColor = '#ff4444';
                else if (orbitClass.includes('aten')) asteroidColor = '#ff8800';
                else if (orbitClass.includes('amor')) asteroidColor = '#ffaa00';
                else if (orbitClass.includes('main_belt')) asteroidColor = '#ffcc00';
            }
            
            asteroidElement.style.background = `radial-gradient(circle, ${asteroidColor}, #cc0000)`;
            asteroidElement.style.borderRadius = '50%';
            asteroidElement.style.boxShadow = `0 0 ${displaySize * 2}px ${asteroidColor}, 0 0 ${displaySize * 4}px rgba(255, 107, 107, 0.5)`;
            asteroidElement.style.animation = `asteroidFall ${animationDuration}ms ease-in forwards`;
            asteroidElement.title = `${asteroid.name} (${diameter}m)`;
            container.appendChild(asteroidElement);
            
            console.log('🪨 小行星创建完成:', {
                name: asteroid.name,
                size: displaySize + 'px',
                color: asteroidColor,
                duration: animationDuration + 'ms'
            });

            // 创建尾迹效果（基于真实数据）
            const trail = document.createElement('div');
            trail.style.position = 'absolute';
            trail.style.left = startX + 'px';
            trail.style.top = startY + 'px';
            trail.style.width = '2px';
            trail.style.height = '0px';
            
            // 根据速度调整尾迹颜色和强度
            let trailColor = '#ffaa00';
            let trailIntensity = '0.8';
            if (closeApproachData.length > 0) {
                const approach = closeApproachData[0];
                const relativeVelocity = approach.relative_velocity || {};
                if (relativeVelocity.kilometers_per_second && !isNaN(parseFloat(relativeVelocity.kilometers_per_second))) {
                    const velocity = parseFloat(relativeVelocity.kilometers_per_second);
                    if (velocity > 30) {
                        trailColor = '#ff4444'; // 高速 - 红色
                        trailIntensity = '1.0';
                    } else if (velocity > 20) {
                        trailColor = '#ff8800'; // 中速 - 橙色
                        trailIntensity = '0.9';
                    } else {
                        trailColor = '#ffaa00'; // 低速 - 黄色
                        trailIntensity = '0.7';
                    }
                }
            }
            
            trail.style.background = `linear-gradient(to bottom, transparent, ${trailColor}, #ff6b6b)`;
            trail.style.transform = `rotate(${finalDirection}deg)`;
            trail.style.animation = `trailGrow ${animationDuration}ms ease-in forwards`;
            trail.style.opacity = trailIntensity;
            container.appendChild(trail);
            
            console.log('🌠 尾迹创建完成:', {
                color: trailColor,
                intensity: trailIntensity,
                duration: animationDuration + 'ms'
            });
            
            // 添加轨迹方向指示器
            const directionIndicator = document.createElement('div');
            directionIndicator.style.position = 'absolute';
            directionIndicator.style.left = (startX - 20) + 'px';
            directionIndicator.style.top = (startY - 20) + 'px';
            directionIndicator.style.width = '40px';
            directionIndicator.style.height = '40px';
            directionIndicator.style.background = `conic-gradient(from ${finalDirection}deg, transparent 0deg, ${asteroidColor} 60deg, transparent 120deg)`;
            directionIndicator.style.borderRadius = '50%';
            directionIndicator.style.opacity = '0.6';
            directionIndicator.style.animation = 'pulse 2s infinite';
            directionIndicator.title = `轨迹方向: ${finalDirection ? finalDirection.toFixed(1) : 'N/A'}°`;
            container.appendChild(directionIndicator);
            
            // 添加方向箭头
            const arrow = document.createElement('div');
            arrow.style.position = 'absolute';
            arrow.style.left = (startX - 5) + 'px';
            arrow.style.top = (startY - 5) + 'px';
            arrow.style.width = '10px';
            arrow.style.height = '10px';
            arrow.style.background = asteroidColor;
            arrow.style.clipPath = 'polygon(0% 0%, 100% 50%, 0% 100%)';
            arrow.style.transform = `rotate(${finalDirection + 90}deg)`;
            arrow.style.animation = 'pulse 2s infinite';
            container.appendChild(arrow);
            
            console.log('🧭 方向指示器创建完成:', {
                direction: finalDirection ? finalDirection.toFixed(1) + '°' : 'N/A',
                color: asteroidColor
            });

            // 添加立体地图效果（如果启用）
            if (show3DEffect) {
                add3DMapEffect(container);
            }

            // 添加CSS动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes trajectoryFall {
                    0% {
                        transform: translate(-50%, -50%) rotate(0deg) scale(1);
                        opacity: 1;
                    }
                    50% {
                        transform: translate(-50%, -50%) rotate(15deg) scale(1.2);
                        opacity: 0.8;
                    }
                    100% {
                        transform: translate(${impactPixel.x - window.innerWidth/2}px, ${impactPixel.y - window.innerHeight/10}px) rotate(45deg) scale(1.5);
                        opacity: 0;
                    }
                }
                
                @keyframes asteroidFall {
                    0% {
                        transform: translate(-50%, -50%) scale(0.5);
                        opacity: 1;
                    }
                    50% {
                        transform: translate(-50%, -50%) scale(1);
                        opacity: 0.9;
                    }
                    100% {
                        transform: translate(${impactPixel.x - startX}px, ${impactPixel.y - startY}px) scale(1.2);
                        opacity: 0;
                    }
                }
                
                @keyframes trailGrow {
                    0% {
                        height: 0px;
                        opacity: 0;
                    }
                    50% {
                        height: ${trajectoryLength * 0.3}px;
                        opacity: ${trailIntensity};
                    }
                    100% {
                        height: ${trajectoryLength}px;
                        opacity: ${parseFloat(trailIntensity) * 0.8};
                    }
                }
                
                @keyframes mapShake {
                    0%, 100% { transform: translate(0, 0) rotate(0deg); }
                    10% { transform: translate(-2px, -1px) rotate(-0.5deg); }
                    20% { transform: translate(2px, 1px) rotate(0.5deg); }
                    30% { transform: translate(-1px, 2px) rotate(-0.3deg); }
                    40% { transform: translate(1px, -2px) rotate(0.3deg); }
                    50% { transform: translate(-2px, 1px) rotate(-0.2deg); }
                    60% { transform: translate(2px, -1px) rotate(0.2deg); }
                    70% { transform: translate(-1px, -2px) rotate(-0.1deg); }
                    80% { transform: translate(1px, 2px) rotate(0.1deg); }
                    90% { transform: translate(-2px, -1px) rotate(-0.05deg); }
                }
                
                @keyframes pulse {
                    0%, 100% { 
                        opacity: 0.6; 
                        transform: scale(1); 
                    }
                    50% { 
                        opacity: 1; 
                        transform: scale(1.2); 
                    }
                }
            `;
            document.head.appendChild(style);

            // 撞击瞬间效果
            setTimeout(() => {
                // 地图震动效果
                const mapElement = document.getElementById('map');
                mapElement.style.animation = 'mapShake 0.5s ease-out';

                // 撞击闪光
                const flash = document.createElement('div');
                flash.style.position = 'absolute';
                flash.style.left = impactPixel.x + 'px';
                flash.style.top = impactPixel.y + 'px';
                flash.style.width = '20px';
                flash.style.height = '20px';
                flash.style.background = 'radial-gradient(circle, #ffff00, #ff4444)';
                flash.style.borderRadius = '50%';
                flash.style.transform = 'translate(-50%, -50%)';
                flash.style.animation = 'impactFlash 0.5s ease-out';
                container.appendChild(flash);

                // 冲击波
                const shockwave = document.createElement('div');
                shockwave.style.position = 'absolute';
                shockwave.style.left = impactPixel.x + 'px';
                shockwave.style.top = impactPixel.y + 'px';
                shockwave.style.width = '0px';
                shockwave.style.height = '0px';
                shockwave.style.border = '3px solid #ffaa00';
                shockwave.style.borderRadius = '50%';
                shockwave.style.transform = 'translate(-50%, -50%)';
                shockwave.style.animation = 'shockwaveExpand 1s ease-out';
                container.appendChild(shockwave);

                // 添加冲击波动画
                const shockwaveStyle = document.createElement('style');
                shockwaveStyle.textContent = `
                    @keyframes impactFlash {
                        0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
                        100% { transform: translate(-50%, -50%) scale(10); opacity: 0; }
                    }
                    
                    @keyframes shockwaveExpand {
                        0% { 
                            width: 0px; 
                            height: 0px; 
                            opacity: 1; 
                        }
                        100% { 
                            width: 200px; 
                            height: 200px; 
                            opacity: 0; 
                        }
                    }
                `;
                document.head.appendChild(shockwaveStyle);

                // 清理动画样式
                setTimeout(() => {
                    document.head.removeChild(style);
                    document.head.removeChild(shockwaveStyle);
                    mapElement.style.animation = '';
                }, 3000);

            }, 2500);
        }

        function add3DMapEffect(container) {
            // 添加立体地图效果
            const mapElement = document.getElementById('map');
            
            // 添加3D变换
            mapElement.style.transform = 'perspective(1000px) rotateX(5deg)';
            mapElement.style.transition = 'transform 0.3s ease';
            
            // 添加阴影效果
            const shadow = document.createElement('div');
            shadow.style.position = 'absolute';
            shadow.style.bottom = '-20px';
            shadow.style.left = '20px';
            shadow.style.right = '20px';
            shadow.style.height = '20px';
            shadow.style.background = 'radial-gradient(ellipse, rgba(0,0,0,0.3), transparent)';
            shadow.style.borderRadius = '50%';
            shadow.style.transform = 'scale(1.2)';
            container.appendChild(shadow);

            // 添加深度指示器
            const depthIndicator = document.createElement('div');
            depthIndicator.style.position = 'absolute';
            depthIndicator.style.top = '20px';
            depthIndicator.style.right = '20px';
            depthIndicator.style.background = 'rgba(0, 0, 0, 0.8)';
            depthIndicator.style.color = 'white';
            depthIndicator.style.padding = '10px';
            depthIndicator.style.borderRadius = '5px';
            depthIndicator.style.fontSize = '12px';
            depthIndicator.innerHTML = `
                <div>🌍 立体地图视图</div>
                <div>📐 3D轨迹显示</div>
            `;
            container.appendChild(depthIndicator);

            // 3秒后恢复地图
            setTimeout(() => {
                mapElement.style.transform = 'perspective(1000px) rotateX(0deg)';
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
