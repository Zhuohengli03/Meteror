<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¡Œæ˜Ÿæ’å‡»åœ°çƒæ¨¡æ‹Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        // ç¡®ä¿Three.jså’ŒOrbitControlsåŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            console.log('Three.js loaded:', typeof THREE !== 'undefined');
            console.log('OrbitControls loaded:', typeof THREE.OrbitControls !== 'undefined');
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            overflow: hidden;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            border: 2px solid #333;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff88;
            text-align: center;
        }

        .instruction {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }

        .step {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #00ff88;
        }

        .step-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .step-content {
            font-size: 14px;
            color: white;
        }

        select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            margin-top: 5px;
        }

        select:focus {
            outline: none;
            border-color: #00ff88;
        }

        select option {
            background: #1a1a1a;
            color: white;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-height: 50vh;
            min-height: 200px;
            overflow-y: auto;
            resize: vertical;
        }

        .results-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ff4444;
            text-align: center;
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 0;
            margin: -20px -20px 15px -20px;
            border-radius: 15px 15px 0 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
        }

        .results-toggle {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .results-toggle:hover {
            background: #357ABD;
        }

        .results.collapsed {
            height: 50px;
            overflow: hidden;
        }

        .results.collapsed .impact-stats,
        .results.collapsed .cities-section {
            display: none;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 15px;
            background: linear-gradient(to right, #4A90E2, #00aaff);
            cursor: ns-resize;
            border-radius: 0 0 15px 15px;
            opacity: 0.8;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resize-handle:hover {
            opacity: 1;
            height: 20px;
        }

        .resize-handle::before {
            content: "â‹®â‹®";
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .trajectory-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #fff;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4A90E2;
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: #4A90E2;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .impact-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
        }

        .cities-section {
            margin-top: 15px;
        }

        .cities-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        .cities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .city-item {
            background: rgba(255, 107, 107, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #ff6b6b;
            font-size: 12px;
        }

        .city-name {
            font-weight: bold;
            color: #ff6b6b;
        }

        .city-info {
            color: #ccc;
            font-size: 11px;
        }

        .error {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 3px solid #ff4444;
            font-size: 12px;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-ready { color: #00ff88; }
        .status-selected { color: #ffaa00; }
        .status-simulating { color: #00aaff; }
        .status-error { color: #ff4444; }

        .grid-label {
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            border: 1px solid #ff6b6b;
        }

        .impact-zone-label {
            background: transparent;
            border: none;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #1a1a1a;
            margin: 5% auto;
            padding: 0;
            border: 2px solid #333;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #2a2a2a;
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: white;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        .search-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .filter-group input {
            padding: 8px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: white;
        }

        .filter-group input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .history-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .history-item:hover {
            background: #333;
        }

        .history-item h3 {
            color: #4a90e2;
            margin: 0 0 10px 0;
        }

        .history-item .meta {
            color: #aaa;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .history-item .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            color: white;
        }

        .stat-label {
            font-size: 11px;
            color: #aaa;
        }

        .history-marker {
            background: transparent;
            border: none;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* åŠ¨æ€æ¼”ç¤ºæ ·å¼ */
        .demo-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .asteroid-trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff6b6b;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff6b6b;
            animation: asteroidMove 3s ease-in-out forwards;
        }

        .impact-flash {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ffff00, #ff4444);
            border-radius: 50%;
            animation: impactFlash 0.5s ease-out;
        }

        .orbit-path {
            position: absolute;
            border: 2px dashed #00aaff;
            border-radius: 50%;
            opacity: 0.7;
            animation: orbitPulse 2s ease-in-out infinite;
        }

        @keyframes asteroidMove {
            0% {
                transform: translate(0, 0) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(var(--target-x), var(--target-y)) scale(1);
                opacity: 0;
            }
        }

        @keyframes impactFlash {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(10);
                opacity: 0;
            }
        }

        @keyframes orbitPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff88;
            font-size: 18px;
            z-index: 1001;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .map-controls button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .map-controls button:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .map-controls button.active {
            background: #00ff88;
            color: #000;
        }

        .layer-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
        }

        .layer-controls h4 {
            color: #00ff88;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .layer-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .layer-item label {
            color: white;
            cursor: pointer;
            flex: 1;
        }

        .layer-opacity {
            width: 60px;
            margin-left: 10px;
        }

        .real-time-indicator {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 1000;
            border: 1px solid #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
        <div class="container">
        <div id="map"></div>
        <div class="map-loading" id="map-loading">ğŸŒ æ­£åœ¨åŠ è½½åœ°å›¾...</div>
        
        <div class="control-panel">
            <div class="title">ğŸŒ å°è¡Œæ˜Ÿæ’å‡»åœ°çƒæ¨¡æ‹Ÿ</div>
            <div class="instruction">
                ç‚¹å‡»åœ°å›¾é€‰æ‹©æ’å‡»åœ°ç‚¹ â†’ é€‰æ‹©å°è¡Œæ˜Ÿ â†’ è¿è¡Œæ¨¡æ‹Ÿ
    </div>

            <div class="step">
                <div class="step-label">æ­¥éª¤ 1: é€‰æ‹©æ’å‡»åœ°ç‚¹</div>
                <div class="step-content" id="location-status">ç‚¹å‡»åœ°å›¾ä¸Šçš„ä»»æ„ä½ç½®</div>
            </div>

            <div class="step">
                <div class="step-label">æ­¥éª¤ 2: é€‰æ‹©å°è¡Œæ˜Ÿ</div>
                <div class="asteroid-search">
                    <input type="text" id="asteroid-search" placeholder="æœç´¢å°è¡Œæ˜Ÿåç§°..." style="width: 100%; padding: 6px; margin-bottom: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <select id="asteroid-select" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="">è¯·å…ˆé€‰æ‹©æ’å‡»åœ°ç‚¹</option>
                        </select>
                    <div class="asteroid-stats" id="asteroid-stats" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
                    </div>
                    </div>

        <div class="step">
            <div class="step-label">æ­¥éª¤ 3: è½¨è¿¹è®¾ç½®</div>
            <div class="trajectory-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="show-trajectory" checked>
                    <span class="checkmark"></span>
                    æ˜¾ç¤ºé™è½è½¨è¿¹
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="show-3d-effect" checked>
                    <span class="checkmark"></span>
                    ç«‹ä½“åœ°å›¾æ•ˆæœ
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="show-coordinates" checked>
                    <span class="checkmark"></span>
                    æ˜¾ç¤ºç»çº¬åº¦
                </label>
                    </div>
                    </div>

            <button class="btn" id="simulate-btn" onclick="runSimulation()" disabled>
                ğŸš€ è¿è¡Œæ’å‡»æ¨¡æ‹Ÿ
            </button>
            
            <button class="btn" id="history-btn" onclick="showHistoryModal()" style="background: #4a90e2; margin-top: 10px;">
                ğŸ“Š æŸ¥è¯¢å†å²æ¨¡æ‹Ÿ
            </button>
            
            <div class="error" id="error" style="display: none;"></div>
                    </div>

        <div class="status-indicator" id="status">
            <span class="status-ready">â— å‡†å¤‡å°±ç»ª</span>
                </div>

        <!-- å†å²æ¨¡æ‹ŸæŸ¥è¯¢æ¨¡æ€æ¡† -->
        <div id="history-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“Š å†å²æ¨¡æ‹ŸæŸ¥è¯¢</h2>
                    <span class="close" onclick="closeHistoryModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="search-filters">
                        <div class="filter-group">
                            <label>å°è¡Œæ˜Ÿåç§°:</label>
                            <input type="text" id="asteroid-name-filter" placeholder="è¾“å…¥å°è¡Œæ˜Ÿåç§°">
            </div>
                        <div class="filter-group">
                            <label>æ—¥æœŸèŒƒå›´:</label>
                            <input type="date" id="start-date-filter">
                            <span>è‡³</span>
                            <input type="date" id="end-date-filter">
        </div>
                        <div class="filter-group">
                            <label>æ’å‡»åœ°ç‚¹:</label>
                            <input type="text" id="location-filter" placeholder="è¾“å…¥åœ°ç‚¹å…³é”®è¯">
    </div>
                        <button class="btn" onclick="searchHistory()" style="background: #4a90e2;">
                            ğŸ” æœç´¢
                        </button>
                    </div>
                    <div class="history-results" id="history-results">
                        <!-- å†å²æ¨¡æ‹Ÿç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
                    </div>
                    </div>

        <div class="real-time-indicator">
            ğŸ›°ï¸ NASAå°è¡Œæ˜Ÿæ•°æ®
                    </div>

        <div class="layer-controls">
            <h4>ğŸ—ºï¸ åœ°å›¾å›¾å±‚</h4>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="osm-layer" checked>
                <label for="osm-layer">OpenStreetMap</label>
                    </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="terrain-layer">
                <label for="terrain-layer">åœ°å½¢å›¾</label>
                </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="dark-layer">
                <label for="dark-layer">æ·±è‰²ä¸»é¢˜</label>
            </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="esri-layer">
                <label for="esri-layer">Esriåœ°å›¾</label>
    </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="imagery-layer">
                <label for="imagery-layer">å«æ˜Ÿå½±åƒ</label>
        </div>
    </div>

        <div class="results" id="results">
            <div class="results-header">
                <span>ğŸ’¥ æ’å‡»å½±å“åˆ†æ</span>
                <button class="results-toggle" onclick="toggleResults()" id="results-toggle">âˆ’</button>
                </div>
            
            <div class="impact-stats" id="impact-stats">
                <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <div class="cities-section">
                <div class="cities-title">ğŸ™ï¸ å—å½±å“åŸå¸‚</div>
                <div class="cities-grid" id="affected-cities">
                    <!-- åŸå¸‚åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let impactMarker;
        let currentImpactMarker = null;
        let impactCircle;
        let cityMarkers = [];
        let selectedLocation = null;
        let currentImpactData = null;
        let activeLayers = {};

        // ä¸»è¦åŸå¸‚æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const majorCities = [
            { name: "åŒ—äº¬", lat: 39.9042, lng: 116.4074, population: 21540000, country: "ä¸­å›½" },
            { name: "ä¸Šæµ·", lat: 31.2304, lng: 121.4737, population: 24280000, country: "ä¸­å›½" },
            { name: "å¹¿å·", lat: 23.1291, lng: 113.2644, population: 15300000, country: "ä¸­å›½" },
            { name: "æ·±åœ³", lat: 22.5431, lng: 114.0579, population: 17560000, country: "ä¸­å›½" },
            { name: "æˆéƒ½", lat: 30.5728, lng: 104.0668, population: 16580000, country: "ä¸­å›½" },
            { name: "é‡åº†", lat: 29.4316, lng: 106.9123, population: 32050000, country: "ä¸­å›½" },
            { name: "å¤©æ´¥", lat: 39.3434, lng: 117.3616, population: 13870000, country: "ä¸­å›½" },
            { name: "æ­¦æ±‰", lat: 30.5928, lng: 114.3055, population: 12320000, country: "ä¸­å›½" },
            { name: "è¥¿å®‰", lat: 34.3416, lng: 108.9398, population: 12950000, country: "ä¸­å›½" },
            { name: "æ­å·", lat: 30.2741, lng: 120.1551, population: 11930000, country: "ä¸­å›½" },
            { name: "å—äº¬", lat: 32.0603, lng: 118.7969, population: 9315000, country: "ä¸­å›½" },
            { name: "é’å²›", lat: 36.0986, lng: 120.3719, population: 10070000, country: "ä¸­å›½" },
            { name: "å¤§è¿", lat: 38.9140, lng: 121.6147, population: 7450000, country: "ä¸­å›½" },
            { name: "å¦é—¨", lat: 24.4798, lng: 118.0819, population: 4110000, country: "ä¸­å›½" },
            { name: "è‹å·", lat: 31.2989, lng: 120.5853, population: 12750000, country: "ä¸­å›½" },
            { name: "å®æ³¢", lat: 29.8683, lng: 121.5440, population: 8542000, country: "ä¸­å›½" },
            { name: "é•¿æ²™", lat: 28.2278, lng: 112.9388, population: 10050000, country: "ä¸­å›½" },
            { name: "éƒ‘å·", lat: 34.7466, lng: 113.6254, population: 12600000, country: "ä¸­å›½" },
            { name: "æµå—", lat: 36.6512, lng: 117.1201, population: 9200000, country: "ä¸­å›½" },
            { name: "ç¦å·", lat: 26.0745, lng: 119.2965, population: 8290000, country: "ä¸­å›½" },
            { name: "çŸ³å®¶åº„", lat: 38.0428, lng: 114.5149, population: 11200000, country: "ä¸­å›½" },
            { name: "åˆè‚¥", lat: 31.8206, lng: 117.2272, population: 9465000, country: "ä¸­å›½" },
            { name: "å—æ˜Œ", lat: 28.6820, lng: 115.8579, population: 6255000, country: "ä¸­å›½" },
            { name: "æ˜†æ˜", lat: 25.0389, lng: 102.7183, population: 8460000, country: "ä¸­å›½" },
            { name: "è´µé˜³", lat: 26.6470, lng: 106.6302, population: 6100000, country: "ä¸­å›½" },
            { name: "å…°å·", lat: 36.0611, lng: 103.8343, population: 4350000, country: "ä¸­å›½" },
            { name: "é“¶å·", lat: 38.4872, lng: 106.2309, population: 2850000, country: "ä¸­å›½" },
            { name: "è¥¿å®", lat: 36.6232, lng: 101.7782, population: 2460000, country: "ä¸­å›½" },
            { name: "ä¹Œé²æœ¨é½", lat: 43.8256, lng: 87.6168, population: 4050000, country: "ä¸­å›½" },
            { name: "æ‹‰è¨", lat: 29.6465, lng: 91.1172, population: 867000, country: "ä¸­å›½" },
            { name: "å°åŒ—", lat: 25.0330, lng: 121.5654, population: 2600000, country: "ä¸­å›½å°æ¹¾" },
            { name: "é«˜é›„", lat: 22.6273, lng: 120.3014, population: 2700000, country: "ä¸­å›½å°æ¹¾" },
            { name: "é¦™æ¸¯", lat: 22.3193, lng: 114.1694, population: 7500000, country: "ä¸­å›½é¦™æ¸¯" },
            { name: "æ¾³é—¨", lat: 22.1987, lng: 113.5439, population: 680000, country: "ä¸­å›½æ¾³é—¨" },
            // å›½é™…ä¸»è¦åŸå¸‚
            { name: "ä¸œäº¬", lat: 35.6762, lng: 139.6503, population: 37400000, country: "æ—¥æœ¬" },
            { name: "é¦–å°”", lat: 37.5665, lng: 126.9780, population: 9720000, country: "éŸ©å›½" },
            { name: "æ–°åŠ å¡", lat: 1.3521, lng: 103.8198, population: 5450000, country: "æ–°åŠ å¡" },
            { name: "æ›¼è°·", lat: 13.7563, lng: 100.5018, population: 10540000, country: "æ³°å›½" },
            { name: "é›…åŠ è¾¾", lat: -6.2088, lng: 106.8456, population: 10560000, country: "å°åº¦å°¼è¥¿äºš" },
            { name: "é©¬å°¼æ‹‰", lat: 14.5995, lng: 120.9842, population: 13480000, country: "è²å¾‹å®¾" },
            { name: "èƒ¡å¿—æ˜å¸‚", lat: 10.8231, lng: 106.6297, population: 8993000, country: "è¶Šå—" },
            { name: "å‰éš†å¡", lat: 3.1390, lng: 101.6869, population: 1588000, country: "é©¬æ¥è¥¿äºš" },
            { name: "æ–°å¾·é‡Œ", lat: 28.6139, lng: 77.2090, population: 32900000, country: "å°åº¦" },
            { name: "å­Ÿä¹°", lat: 19.0760, lng: 72.8777, population: 20000000, country: "å°åº¦" },
            { name: "åŠ å°”å„ç­”", lat: 22.5726, lng: 88.3639, population: 14900000, country: "å°åº¦" },
            { name: "ç­åŠ ç½—å°”", lat: 12.9716, lng: 77.5946, population: 12400000, country: "å°åº¦" },
            { name: "æ‚‰å°¼", lat: -33.8688, lng: 151.2093, population: 5312000, country: "æ¾³å¤§åˆ©äºš" },
            { name: "å¢¨å°”æœ¬", lat: -37.8136, lng: 144.9631, population: 5078000, country: "æ¾³å¤§åˆ©äºš" },
            { name: "çº½çº¦", lat: 40.7128, lng: -74.0060, population: 8336000, country: "ç¾å›½" },
            { name: "æ´›æ‰çŸ¶", lat: 34.0522, lng: -118.2437, population: 3972000, country: "ç¾å›½" },
            { name: "èŠåŠ å“¥", lat: 41.8781, lng: -87.6298, population: 2694000, country: "ç¾å›½" },
            { name: "ä¼‘æ–¯é¡¿", lat: 29.7604, lng: -95.3698, population: 2320000, country: "ç¾å›½" },
            { name: "ä¼¦æ•¦", lat: 51.5074, lng: -0.1278, population: 8982000, country: "è‹±å›½" },
            { name: "å·´é»", lat: 48.8566, lng: 2.3522, population: 2161000, country: "æ³•å›½" },
            { name: "æŸæ—", lat: 52.5200, lng: 13.4050, population: 3669000, country: "å¾·å›½" },
            { name: "ç½—é©¬", lat: 41.9028, lng: 12.4964, population: 2873000, country: "æ„å¤§åˆ©" },
            { name: "è«æ–¯ç§‘", lat: 55.7558, lng: 37.6176, population: 12500000, country: "ä¿„ç½—æ–¯" },
            { name: "åœ£å½¼å¾—å ¡", lat: 59.9311, lng: 30.3609, population: 5384000, country: "ä¿„ç½—æ–¯" },
            { name: "å¼€ç½—", lat: 30.0444, lng: 31.2357, population: 20480000, country: "åŸƒåŠ" },
            { name: "æ‹‰å„æ–¯", lat: 6.5244, lng: 3.3792, population: 15388000, country: "å°¼æ—¥åˆ©äºš" },
            { name: "çº¦ç¿°å†…æ–¯å ¡", lat: -26.2041, lng: 28.0473, population: 5635000, country: "å—é" },
            { name: "å¼€æ™®æ•¦", lat: -33.9249, lng: 18.4241, population: 4618000, country: "å—é" },
            { name: "åœ£ä¿ç½—", lat: -23.5505, lng: -46.6333, population: 12300000, country: "å·´è¥¿" },
            { name: "é‡Œçº¦çƒ­å†…å¢", lat: -22.9068, lng: -43.1729, population: 6748000, country: "å·´è¥¿" },
            { name: "å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯", lat: -34.6118, lng: -58.3960, population: 15590000, country: "é˜¿æ ¹å»·" },
            { name: "å¢¨è¥¿å“¥åŸ", lat: 19.4326, lng: -99.1332, population: 21800000, country: "å¢¨è¥¿å“¥" },
            { name: "å¤šä¼¦å¤š", lat: 43.6532, lng: -79.3832, population: 2930000, country: "åŠ æ‹¿å¤§" },
            { name: "æ¸©å“¥å", lat: 49.2827, lng: -123.1207, population: 675000, country: "åŠ æ‹¿å¤§" }
        ];

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            try {
                map = L.map('map', {
                    zoomControl: true,
                    attributionControl: false
                }).setView([20, 0], 2);  // ä½¿ç”¨æ ‡å‡†åæ ‡ç³»
                
                // ä½¿ç”¨å¯é çš„åœ°å›¾æœåŠ¡
                const mapLayers = [
                    // OpenStreetMap (æœ€å¯é )
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors',
                        maxZoom: 19
                    }),
                    // å¤‡ç”¨1: OpenTopoMap åœ°å½¢å›¾
                    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors, SRTM | Â© OpenTopoMap (CC-BY-SA)',
                        subdomains: 'abc',
                        maxZoom: 17
                    }),
                    // å¤‡ç”¨2: CartoDB æ·±è‰²ä¸»é¢˜
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: 'Â© OpenStreetMap contributors Â© CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }),
                    // å¤‡ç”¨3: Esri ä¸–ç•Œåœ°å›¾
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Â© Esri',
                        maxZoom: 19
                    }),
                    // å¤‡ç”¨4: Esri ä¸–ç•Œå½±åƒ
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Â© Esri',
                        maxZoom: 19
                    })
                ];

                // åˆå§‹åŒ–å›¾å±‚
                activeLayers = {
                    osm: mapLayers[0],
                    terrain: mapLayers[1],
                    dark: mapLayers[2],
                    esri: mapLayers[3],
                    imagery: mapLayers[4]
                };

                // é»˜è®¤æ˜¾ç¤ºOpenStreetMap
                activeLayers.osm.addTo(map);

                // è®¾ç½®å›¾å±‚æ§åˆ¶äº‹ä»¶
                setupLayerControls();

                // åœ°å›¾åŠ è½½æˆåŠŸåéšè—åŠ è½½æç¤º
                map.on('load', function() {
                    document.getElementById('map-loading').style.display = 'none';
                });

                // å¦‚æœåœ°å›¾åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡
                activeLayers.osm.on('tileerror', function() {
                    console.log('OpenStreetMapåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡...');
                    map.removeLayer(activeLayers.osm);
                    activeLayers.dark.addTo(map);
                });

                // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ5ç§’åè¿˜åœ¨åŠ è½½ï¼Œå¼ºåˆ¶éšè—åŠ è½½æç¤º
                setTimeout(function() {
                    document.getElementById('map-loading').style.display = 'none';
                }, 5000);

                // æ·»åŠ åŸå¸‚æ ‡è®°
                addCityMarkers();

                // åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.on('click', function(e) {
                    selectImpactLocation(e.latlng);
                });

                // åŠ è½½å°è¡Œæ˜Ÿæ•°æ®
                loadAsteroids();

            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // æ·»åŠ åŸå¸‚æ ‡è®°
        function addCityMarkers() {
            majorCities.forEach(city => {
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: 3,
                    fillColor: '#ff6b6b',
                    color: 'white',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                }).addTo(map);

                marker.bindPopup(`
                    <div style="text-align: center; color: #333;">
                        <h4 style="margin: 0 0 5px 0;">${city.name}</h4>
                        <p style="margin: 0; font-size: 12px;">${city.country}</p>
                        <p style="margin: 0; font-size: 11px; color: #666;">äººå£: ${city.population.toLocaleString()}</p>
                    </div>
                `);

                cityMarkers.push(marker);
            });
        }

        // é€‰æ‹©æ’å‡»åœ°ç‚¹
        function selectImpactLocation(latlng) {
            selectedLocation = latlng;
            
            // ç§»é™¤ä¹‹å‰çš„æ’å‡»æ ‡è®°
            if (impactMarker) {
                map.removeLayer(impactMarker);
            }
            if (impactCircle) {
                map.removeLayer(impactCircle);
            }

            // æ·»åŠ æ–°çš„æ’å‡»æ ‡è®°
            impactMarker = L.circleMarker(latlng, {
                radius: 8,
                fillColor: '#ff4444',
                color: 'white',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            impactMarker.bindPopup(`
                <div style="text-align: center; color: #333;">
                    <h4 style="margin: 0 0 5px 0;">ğŸ¯ æ’å‡»åœ°ç‚¹</h4>
                    <p style="margin: 0; font-size: 12px;">çº¬åº¦: ${latlng.lat ? latlng.lat.toFixed(4) : 'N/A'}Â°</p>
                    <p style="margin: 0; font-size: 12px;">ç»åº¦: ${latlng.lng ? latlng.lng.toFixed(4) : 'N/A'}Â°</p>
                </div>
            `);

            // æ›´æ–°çŠ¶æ€
            updateStatus('selected', 'å·²é€‰æ‹©æ’å‡»åœ°ç‚¹');
            document.getElementById('location-status').textContent = 
                `å·²é€‰æ‹©: ${latlng.lat ? latlng.lat.toFixed(2) : 'N/A'}Â°, ${latlng.lng ? latlng.lng.toFixed(2) : 'N/A'}Â°`;
            
            // å¯ç”¨å°è¡Œæ˜Ÿé€‰æ‹©
            document.getElementById('asteroid-select').disabled = false;
            document.getElementById('asteroid-select').innerHTML = '<option value="">åŠ è½½å°è¡Œæ˜Ÿæ•°æ®...</option>';
            
            // é‡æ–°åŠ è½½å°è¡Œæ˜Ÿæ•°æ®
            loadAsteroids();
        }

        // å­˜å‚¨æ‰€æœ‰å°è¡Œæ˜Ÿæ•°æ®
        let allAsteroids = [];

        // åŠ è½½å°è¡Œæ˜Ÿæ•°æ®
        async function loadAsteroids() {
            try {
                const response = await fetch('http://localhost:8000/asteroids');
                allAsteroids = await response.json();
                
                // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
                setupAsteroidSearch();
                
                // æ˜¾ç¤ºæ‰€æœ‰å°è¡Œæ˜Ÿ
                displayAsteroids(allAsteroids);

                // å¯ç”¨æ¨¡æ‹ŸæŒ‰é’®
                document.getElementById('simulate-btn').disabled = false;
                
            } catch (error) {
                console.error('åŠ è½½å°è¡Œæ˜Ÿæ•°æ®å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½å°è¡Œæ˜Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
            }
        }
        
        // è®¾ç½®å°è¡Œæ˜Ÿæœç´¢åŠŸèƒ½
        function setupAsteroidSearch() {
            const searchInput = document.getElementById('asteroid-search');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredAsteroids = allAsteroids.filter(asteroid => 
                    asteroid.name.toLowerCase().includes(searchTerm) ||
                    asteroid.id.includes(searchTerm)
                );
                displayAsteroids(filteredAsteroids);
            });
        }
        
        // æ˜¾ç¤ºå°è¡Œæ˜Ÿåˆ—è¡¨
        function displayAsteroids(asteroids) {
            const select = document.getElementById('asteroid-select');
            const stats = document.getElementById('asteroid-stats');
            
            select.innerHTML = '';
            
            if (asteroids.length === 0) {
                select.innerHTML = '<option value="">æœªæ‰¾åˆ°åŒ¹é…çš„å°è¡Œæ˜Ÿ</option>';
                stats.textContent = 'æ˜¾ç¤º 0 ä¸ªå°è¡Œæ˜Ÿ';
                return;
            }
            
            // æŒ‰å±é™©ç­‰çº§å’Œç›´å¾„æ’åº
            asteroids.sort((a, b) => {
                if (a.is_potentially_hazardous !== b.is_potentially_hazardous) {
                    return b.is_potentially_hazardous - a.is_potentially_hazardous;
                }
                return (b.diameter_min + b.diameter_max) - (a.diameter_min + a.diameter_max);
            });
            
                asteroids.forEach(asteroid => {
                    const option = document.createElement('option');
                    option.value = asteroid.id;
                    
                    // åªæ˜¾ç¤ºåå­—å’Œæ—¥æœŸ
                    const approachDate = asteroid.close_approach_data?.[0]?.close_approach_date || 'æœªçŸ¥';
                    const hazardStatus = asteroid.is_potentially_hazardous ? 'âš ï¸' : 'âœ…';
                    
                    option.textContent = `${hazardStatus} ${asteroid.name} | ${approachDate}`;
                    select.appendChild(option);
                });
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const hazardousCount = asteroids.filter(a => a.is_potentially_hazardous).length;
            stats.textContent = `æ˜¾ç¤º ${asteroids.length} ä¸ªå°è¡Œæ˜Ÿ (${hazardousCount} ä¸ªé«˜å±)`;
        }

        // è¿è¡Œæ’å‡»æ¨¡æ‹Ÿ
        async function runSimulation() {
            const asteroidSelect = document.getElementById('asteroid-select');
            const asteroidId = asteroidSelect.value;
            
            if (!asteroidId) {
                showError('è¯·é€‰æ‹©ä¸€ä¸ªå°è¡Œæ˜Ÿ');
                return;
            }

            if (!selectedLocation) {
                showError('è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©æ’å‡»åœ°ç‚¹');
                return;
            }

            await runStaticSimulation(asteroidId);
        }

        async function runStaticSimulation(asteroidId) {
            hideError();

            try {
                // æ¸…ç†æ‰€æœ‰ç°æœ‰æ˜¾ç¤º
                clearAllDisplays();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºè½¨è¿¹
                const showTrajectory = document.getElementById('show-trajectory').checked;
                const show3DEffect = document.getElementById('show-3d-effect').checked;
                
                if (showTrajectory) {
                    updateStatus('simulating', 'æ­£åœ¨æ˜¾ç¤ºé™è½è½¨è¿¹...');
                    // æ˜¾ç¤ºé™è½è½¨è¿¹åŠ¨ç”»
                    await showImpactTrajectory(asteroidId, show3DEffect);
                }
                
                // æ›´æ–°çŠ¶æ€
                updateStatus('simulating', 'æ­£åœ¨è®¡ç®—æ’å‡»å½±å“...');

                // è·å–å°è¡Œæ˜Ÿæ•°æ®ä»¥è·å–çœŸå®é€Ÿåº¦
                const asteroidResponse = await fetch('http://localhost:8000/asteroids');
                const asteroids = await asteroidResponse.json();
                const asteroid = asteroids.find(a => a.id === asteroidId);
                
                // ä½¿ç”¨APIä¸­çš„çœŸå®é€Ÿåº¦ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
                let impactVelocity = 20000; // é»˜è®¤20km/s
                
                if (asteroid && asteroid.close_approach_data && asteroid.close_approach_data.length > 0) {
                    // ä»å¤šä¸ªæ¥è¿‘æ•°æ®ä¸­é€‰æ‹©ä¸€ä¸ªé€Ÿåº¦ï¼ˆé€‰æ‹©æœ€è¿‘çš„æˆ–éšæœºçš„ï¼‰
                    const approachData = asteroid.close_approach_data[0]; // ä½¿ç”¨æœ€è¿‘çš„æ¥è¿‘æ•°æ®
                    const velocityStr = approachData.relative_velocity.kilometers_per_second;
                    const velocity = parseFloat(velocityStr);
                    if (!isNaN(velocity) && velocity > 0) {
                        impactVelocity = velocity * 1000; // è½¬æ¢ä¸ºm/s
                    }
                } else if (asteroid && asteroid.velocity) {
                    // ä½¿ç”¨å­˜å‚¨çš„å¹³å‡é€Ÿåº¦
                    impactVelocity = asteroid.velocity;
                }
                
                console.log('æ’å‡»é€Ÿåº¦:', impactVelocity, 'm/s');
                console.log('å°è¡Œæ˜Ÿæ¥è¿‘æ•°æ®:', asteroid.close_approach_data?.length || 0, 'æ¡è®°å½•');
                
                const response = await fetch('http://localhost:8000/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        asteroid_id: asteroidId,
                        impact_angle: 45,
                        impact_velocity: impactVelocity,
                        target_density: 3000,
                        target_type: 'continental_crust',
                        impact_latitude: selectedLocation.lat,
                        impact_longitude: selectedLocation.lng
                    })
                });

                const result = await response.json();
                currentImpactData = result;
                
                // è®¡ç®—å½±å“åŠå¾„ç”¨äºåŸå¸‚è®¡ç®—
                const craterRadius = result.crater_diameter / 2;
                const impactRadius = craterRadius * 50; // å½±å“èŒƒå›´æ˜¯é™¨çŸ³å‘çš„50å€
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(result, impactRadius);
                
                // å»¶è¿Ÿæ˜¾ç¤ºæ’å‡»èŒƒå›´ï¼Œæ¨¡æ‹Ÿæ’å‡»åçš„æ•ˆæœ
                setTimeout(() => {
                    // ç¡®ä¿æ¸…é™¤æ‰€æœ‰ç°æœ‰åœˆå±‚
                    clearImpactZones();
                    showImpactArea(result);
                }, 1000);
                
                updateStatus('ready', 'æ¨¡æ‹Ÿå®Œæˆ');
                
            } catch (error) {
                console.error('æ¨¡æ‹Ÿå¤±è´¥:', error);
                showError('æ¨¡æ‹Ÿå¤±è´¥: ' + error.message);
                updateStatus('error', 'æ¨¡æ‹Ÿå¤±è´¥');
            }
        }

        // æ˜¾ç¤ºæ’å‡»èŒƒå›´
        function showImpactArea(result) {
            console.log('showImpactArea called with result:', result);
            console.log('selectedLocation:', selectedLocation);
            
            if (!selectedLocation) {
                console.error('selectedLocation is null, cannot show impact area');
                return;
            }
            
            const craterRadius = result.crater_diameter / 2;
            const impactRadius = craterRadius * 50; // å½±å“èŒƒå›´æ˜¯é™¨çŸ³å‘çš„50å€
            
            console.log('craterRadius:', craterRadius, 'impactRadius:', impactRadius);
            
            // æ¸…é™¤ä¹‹å‰çš„å½±å“èŒƒå›´åœ†åœˆ
            if (impactCircle) {
                map.removeLayer(impactCircle);
            }
            
            // å‡†å¤‡åæ ‡
            const impactLatLng = [selectedLocation.lat, selectedLocation.lng];
            console.log('Creating impact circle at:', impactLatLng, 'with radius:', impactRadius * 1000);
            
            // æ·»åŠ æ’å‡»ç‚¹æ ‡è®°
            if (currentImpactMarker) {
                map.removeLayer(currentImpactMarker);
            }
            
            currentImpactMarker = L.circleMarker(impactLatLng, {
                radius: 8,
                color: '#ff0000',
                fillColor: '#ff0000',
                fillOpacity: 0.8,
                weight: 2
            }).addTo(map);
            
            // åˆ›å»ºå½±å“åœˆå±‚
            // craterRadius å•ä½æ˜¯ç±³ï¼Œéœ€è¦è½¬æ¢ä¸ºå…¬é‡Œç”¨äºæ˜¾ç¤º
            const craterRadiusKm = craterRadius / 1000; // è½¬æ¢ä¸ºå…¬é‡Œ
            
            // è·å–çˆ†ç‚¸æ•ˆåº”æ•°æ®
            const blastEffects = result.blast_effects;
            const zones = [
                {
                    radius: craterRadiusKm,
                    color: '#ff0000',
                    opacity: 0.8,
                    label: 'é™¨çŸ³å‘',
                    description: 'ç›´æ¥æ’å‡»åŒºåŸŸ'
                }
            ];
            
            // æ·»åŠ çˆ†ç‚¸æ•ˆåº”åœˆå±‚
            if (blastEffects) {
                // 20psiè¶…å‹åœˆå±‚ï¼ˆä¸¥é‡æŸåï¼‰
                if (blastEffects.overpressure_20psi_radius > 0) {
                    zones.push({
                        radius: blastEffects.overpressure_20psi_radius,
                        color: '#ff4400',
                        opacity: 0.6,
                        label: '20psiè¶…å‹åŒº',
                        description: 'ä¸¥é‡æŸååŒºåŸŸ'
                    });
                }
                
                // 5psiè¶…å‹åœˆå±‚ï¼ˆä¸­ç­‰æŸåï¼‰
                if (blastEffects.overpressure_5psi_radius > 0) {
                    zones.push({
                        radius: blastEffects.overpressure_5psi_radius,
                        color: '#ff8800',
                        opacity: 0.4,
                        label: '5psiè¶…å‹åŒº',
                        description: 'ä¸­ç­‰æŸååŒºåŸŸ'
                    });
                }
                
                // 1psiè¶…å‹åœˆå±‚ï¼ˆè½»å¾®æŸåï¼‰
                if (blastEffects.overpressure_1psi_radius > 0) {
                    zones.push({
                        radius: blastEffects.overpressure_1psi_radius,
                        color: '#ffaa00',
                        opacity: 0.3,
                        label: '1psiè¶…å‹åŒº',
                        description: 'è½»å¾®æŸååŒºåŸŸ'
                    });
                }
            }
            
            // åˆ›å»ºå½±å“åœˆå±‚
            zones.forEach((zone, index) => {
                console.log(`åˆ›å»ºåœˆå±‚ ${index + 1}:`, {
                    label: zone.label,
                    color: zone.color,
                    radius: zone.radius,
                    opacity: zone.opacity
                });
                
                const circle = L.circle(impactLatLng, {
                    radius: zone.radius * 1000, // zone.radiuså·²ç»æ˜¯å…¬é‡Œï¼Œè½¬æ¢ä¸ºç±³
                    color: zone.color,
                    fillColor: zone.color,
                    fillOpacity: Math.max(zone.opacity, 0.1), // ç¡®ä¿æœ€å°é€æ˜åº¦
                    weight: 4, // å¢åŠ çº¿æ¡ç²—ç»†
                    dashArray: index === 0 ? '0' : '15, 10' // é™¨çŸ³å‘å®çº¿ï¼Œå…¶ä»–è™šçº¿
                }).addTo(map);
                
                circle._impactZone = true;
                
                // æ·»åŠ æ ‡ç­¾ï¼ˆæ‰€æœ‰åœˆå±‚éƒ½æ·»åŠ æ ‡ç­¾ï¼Œä½ç½®åœ¨åœˆå±‚è¾¹ç¼˜ï¼‰
                // å°†åŠå¾„ä»å…¬é‡Œè½¬æ¢ä¸ºåº¦ï¼ˆç²—ç•¥è½¬æ¢ï¼š1åº¦çº¦111kmï¼‰
                const radiusInDegrees = zone.radius / 111; // è½¬æ¢ä¸ºåº¦
                
                // ä¸ºä¸åŒåœˆå±‚è®¾ç½®ä¸åŒçš„è§’åº¦åç§»ï¼Œé¿å…é‡å 
                // ä½¿ç”¨æ›´åˆç†çš„è§’åº¦åˆ†å¸ƒï¼š0Â°, 72Â°, 144Â°, 216Â°, 288Â°
                const angles = [0, 72, 144, 216, 288];
                const angleOffset = angles[index] || (index * 72) % 360;
                const angleRad = (angleOffset * Math.PI) / 180;
                
                // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œåœ¨åœˆå±‚å¤–éƒ¨
                const labelOffset = radiusInDegrees * 1.2; // åœ¨åœˆå±‚å¤–éƒ¨20%çš„ä½ç½®
                const labelLat = selectedLocation.lat + Math.cos(angleRad) * labelOffset;
                const labelLng = selectedLocation.lng + Math.sin(angleRad) * labelOffset;
                
                console.log(`åœˆå±‚ ${index + 1} æ ‡ç­¾ä½ç½®:`, {
                    label: zone.label,
                    radius: zone.radius + 'm',
                    radiusInDegrees: radiusInDegrees ? radiusInDegrees.toFixed(6) + 'Â°' : 'N/A',
                    angleOffset: angleOffset + 'Â°',
                    labelPosition: [labelLat ? labelLat.toFixed(6) : 'N/A', labelLng ? labelLng.toFixed(6) : 'N/A']
                });
                
                const label = L.marker([labelLat, labelLng], {
                    icon: L.divIcon({
                        className: 'impact-zone-label',
                        html: `
                            <div style="background: ${zone.color}; color: white; padding: 4px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; text-align: center; border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.5); min-width: 80px;">
                                ${zone.label}<br>
                                <small style="font-size: 10px;">${zone.radius ? zone.radius.toFixed(1) : 'N/A'}km</small>
                            </div>
                        `,
                        iconSize: [90, 45],
                        iconAnchor: [45, 22]
                    })
                }).addTo(map);
                label._impactZone = true;
            });
            
            console.log('Impact zones created:', zones.length);
            
            // æ·»åŠ å†²å‡»æ³¢åŠ¨ç”»
            const shockwave = L.circle(impactLatLng, {
                radius: 0,
                color: '#ffaa00',
                weight: 3,
                opacity: 0.8,
                fillOpacity: 0
            }).addTo(map);
            
            // å†²å‡»æ³¢æ‰©æ•£åŠ¨ç”»
            let currentRadius = 0;
            const maxRadius = impactRadius * 1000;
            const animation = setInterval(() => {
                currentRadius += maxRadius / 20;
                shockwave.setRadius(currentRadius);
                shockwave.setStyle({
                    opacity: 0.8 * (1 - currentRadius / maxRadius)
                });
                
                if (currentRadius >= maxRadius) {
                    clearInterval(animation);
                    map.removeLayer(shockwave);
                }
            }, 50);
            
            // æ›´æ–°åŸå¸‚å½±å“çŠ¶æ€
            updateCityImpactStatus(selectedLocation, impactRadius);
        }

        // æ›´æ–°åŸå¸‚å½±å“çŠ¶æ€
        function updateCityImpactStatus(impactPoint, radius) {
            cityMarkers.forEach((marker, index) => {
                const city = majorCities[index];
                const distance = impactPoint.distanceTo([city.lat, city.lng]);
                
                if (distance <= radius) {
                    marker.setStyle({
                        fillColor: '#ff6b6b',
                        color: '#ff4444',
                        weight: 2,
                        radius: 5
                    });
                } else {
                    marker.setStyle({
                        fillColor: '#ff6b6b',
                        color: 'white',
                        weight: 1,
                        radius: 3
                    });
                }
            });
        }

        // æ ¼å¼åŒ–ç»æµæŸå¤±æ˜¾ç¤º
        function formatEconomicLoss(loss) {
            if (!loss || isNaN(loss) || loss < 0) {
                return 'N/A';
            }
            if (loss >= 1000000) {
                return (loss / 1000000).toFixed(1) + 'T'; // ä¸‡äº¿
            } else if (loss >= 1000) {
                return (loss / 1000).toFixed(1) + 'B'; // åäº¿
            } else if (loss >= 1) {
                return loss.toFixed(1) + 'M'; // ç™¾ä¸‡
            } else {
                return (loss * 1000).toFixed(1) + 'K'; // åƒ
            }
        }

        // æ ¼å¼åŒ–æ’å‡»é€Ÿåº¦æ˜¾ç¤º
        function formatImpactVelocity(velocity) {
            // ç¡®ä¿velocityæ˜¯æ•°å­—ï¼Œå¤„ç†å¯èƒ½çš„å­—ç¬¦ä¸²è¾“å…¥
            let numVelocity = parseFloat(velocity);
            
            if (isNaN(numVelocity) || numVelocity <= 0) {
                return 'N/A';
            }
            return (numVelocity / 1000).toFixed(1) + 'km/s';
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(result, impactRadius) {
            const resultsDiv = document.getElementById('results');
            const statsDiv = document.getElementById('impact-stats');
            const citiesDiv = document.getElementById('affected-cities');

            // æ·»åŠ è°ƒæ•´æ‰‹æŸ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!document.querySelector('.resize-handle')) {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                resultsDiv.appendChild(resizeHandle);
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${result.asteroid_diameter ? result.asteroid_diameter.toFixed(1) : 'N/A'}m</div>
                    <div class="stat-label">å°è¡Œæ˜Ÿç›´å¾„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatImpactVelocity(result.impact_velocity)}</div>
                    <div class="stat-label">æ’å‡»é€Ÿåº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.asteroid_mass ? (result.asteroid_mass / 1e9).toFixed(1) : 'N/A'}B kg</div>
                    <div class="stat-label">å°è¡Œæ˜Ÿè´¨é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.crater_diameter ? Math.round(result.crater_diameter/1000) : 'N/A'}km</div>
                    <div class="stat-label">é™¨çŸ³å‘ç›´å¾„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.seismic_magnitude ? result.seismic_magnitude.toFixed(1) : 'N/A'}</div>
                    <div class="stat-label">åœ°éœ‡éœ‡çº§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.tsunami_height ? Math.round(result.tsunami_height) : 'N/A'}m</div>
                    <div class="stat-label">æµ·å•¸é«˜åº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.impact_energy ? (result.impact_energy / 1e21).toFixed(1) : 'N/A'}EJ</div>
                    <div class="stat-label">å†²å‡»èƒ½é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.energy_megatons ? result.blast_effects.energy_megatons.toFixed(1) : 0}MT</div>
                    <div class="stat-label">TNTå½“é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.overpressure_1psi_radius ? Math.round(result.blast_effects.overpressure_1psi_radius) : 0}km</div>
                    <div class="stat-label">1psiè¶…å‹åŠå¾„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.overpressure_5psi_radius ? Math.round(result.blast_effects.overpressure_5psi_radius) : 0}km</div>
                    <div class="stat-label">5psiè¶…å‹åŠå¾„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.overpressure_20psi_radius ? Math.round(result.blast_effects.overpressure_20psi_radius) : 0}km</div>
                    <div class="stat-label">20psiè¶…å‹åŠå¾„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.blast_effects && result.blast_effects.thermal_50km ? (result.blast_effects.thermal_50km / 1e6).toFixed(1) : 0}MJ/mÂ²</div>
                    <div class="stat-label">50kmçƒ­è¾å°„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.population_loss !== undefined ? result.population_loss.toLocaleString() : 'N/A'}</div>
                    <div class="stat-label">äººå£æŸå¤±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${formatEconomicLoss(result.building_loss)}</div>
                    <div class="stat-label">å»ºç­‘æŸå¤±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${formatEconomicLoss(result.total_economic_loss)}</div>
                    <div class="stat-label">æ€»ç»æµæŸå¤±</div>
                </div>
            `;
            
            // è®¡ç®—å—å½±å“åŸå¸‚
            const affectedCities = [];
            const impactPoint = selectedLocation;
            
            console.log(`å½±å“åŠå¾„: ${impactRadius/1000}km`); // è°ƒè¯•ä¿¡æ¯
            
            majorCities.forEach(city => {
                const distance = impactPoint.distanceTo([city.lat, city.lng]);
                console.log(`${city.name}: è·ç¦» ${distance/1000}km`); // è°ƒè¯•ä¿¡æ¯
                
                if (distance <= impactRadius) {
                    affectedCities.push({
                        ...city,
                        distance: Math.round(distance / 1000)
                    });
                }
            });
            
            console.log(`å—å½±å“åŸå¸‚æ•°é‡: ${affectedCities.length}`); // è°ƒè¯•ä¿¡æ¯

            // æŒ‰è·ç¦»æ’åº
            affectedCities.sort((a, b) => a.distance - b.distance);

            // æ˜¾ç¤ºå—å½±å“åŸå¸‚
            let citiesHtml = '';
            
            if (affectedCities.length === 0) {
                citiesHtml += `
                    <div style="color: #00aa00; margin-bottom: 10px; font-weight: bold;">
                        âœ… æ’å‡»åœ°ç‚¹ä½äºåè¿œåœ°åŒºï¼Œæ— åŸå¸‚å—å½±å“
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        ç”±äºæ’å‡»åœ°ç‚¹è¿œç¦»åŸå¸‚ï¼Œæ­¤æ¬¡æ’å‡»ä¸ä¼šé€ æˆäººå£æŸå¤±å’Œç»æµæŸå¤±ã€‚
                    </div>
                `;
            } else {
                citiesHtml += `
                    <div style="color: #ff4444; margin-bottom: 10px; font-weight: bold;">
                        ğŸš¨ å—å½±å“åŸå¸‚ (${affectedCities.length}ä¸ª)ï¼š
                    </div>
                    ${affectedCities.map(city => `
                        <div class="city-item" style="color: #ff4444; font-weight: bold;">
                            <div class="city-name">${city.name}</div>
                            <div class="city-info">${city.country} | ${city.distance}km | ${city.population.toLocaleString()}äºº</div>
                        </div>
                    `).join('')}
                `;
            }
            
            
            citiesDiv.innerHTML = citiesHtml;

            resultsDiv.style.display = 'block';
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            const statusMap = {
                'ready': { class: 'status-ready', text: 'â— å‡†å¤‡å°±ç»ª' },
                'selected': { class: 'status-selected', text: 'â— å·²é€‰æ‹©åœ°ç‚¹' },
                'simulating': { class: 'status-simulating', text: 'â— è®¡ç®—ä¸­...' },
                'error': { class: 'status-error', text: 'â— é”™è¯¯' }
            };
            
            const status = statusMap[type];
            statusEl.innerHTML = `<span class="${status.class}">${status.text}</span>`;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // è®¾ç½®å›¾å±‚æ§åˆ¶
        function setupLayerControls() {
            // OpenStreetMapæ§åˆ¶
            document.getElementById('osm-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ OSMå›¾å±‚
                    activeLayers.osm.addTo(map);
                }
            });

            // åœ°å½¢å›¾æ§åˆ¶
            document.getElementById('terrain-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ åœ°å½¢å›¾å±‚
                    activeLayers.terrain.addTo(map);
                }
            });

            // æ·±è‰²ä¸»é¢˜æ§åˆ¶
            document.getElementById('dark-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ æ·±è‰²å›¾å±‚
                    activeLayers.dark.addTo(map);
                }
            });

            // Esriåœ°å›¾æ§åˆ¶
            document.getElementById('esri-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ Esriå›¾å±‚
                    activeLayers.esri.addTo(map);
                }
            });

            // å«æ˜Ÿå½±åƒæ§åˆ¶
            document.getElementById('imagery-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ å«æ˜Ÿå½±åƒå›¾å±‚
                    activeLayers.imagery.addTo(map);
                }
            });
        }

        async function runDynamicDemo(asteroidId, mode) {
            updateStatus('simulating', 'æ­£åœ¨å‡†å¤‡åŠ¨æ€æ¼”ç¤º...');
            hideError();

            try {
                // è·å–å°è¡Œæ˜Ÿæ•°æ®
                const response = await fetch('http://localhost:8000/asteroids');
                const asteroids = await response.json();
                const asteroid = asteroids.find(a => a.id === asteroidId);
                
                if (!asteroid) {
                    showError('å°è¡Œæ˜Ÿæ•°æ®æœªæ‰¾åˆ°');
                    return;
                }

                // åˆ›å»ºæ¼”ç¤ºå®¹å™¨
                createDemoContainer();
                
                if (mode === 'orbit') {
                    await showOrbitDemo(asteroid);
                } else if (mode === '3d') {
                    await show3DOrbitDemo(asteroid);
                } else if (mode === 'simple-3d') {
                    await showSimple3DDemo(asteroid);
                } else {
                    await showImpactDemo(asteroid);
                }

                // è¿è¡Œé™æ€æ¨¡æ‹Ÿè·å–ç»“æœ
                await runStaticSimulation(asteroidId);

            } catch (error) {
                console.error('Demo error:', error);
                showError('æ¼”ç¤ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                updateStatus('error', 'æ¼”ç¤ºå¤±è´¥');
            }
        }

        function createDemoContainer() {
            // ç§»é™¤ç°æœ‰çš„æ¼”ç¤ºå®¹å™¨
            const existing = document.getElementById('demo-container');
            if (existing) {
                existing.remove();
            }

            // åˆ›å»ºæ–°çš„æ¼”ç¤ºå®¹å™¨
            const container = document.createElement('div');
            container.id = 'demo-container';
            container.className = 'demo-container';
            document.getElementById('map').appendChild(container);
        }

        async function showOrbitDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // æ˜¾ç¤ºè½¨é“è·¯å¾„
            const orbitPath = document.createElement('div');
            orbitPath.className = 'orbit-path';
            orbitPath.style.left = '50%';
            orbitPath.style.top = '50%';
            orbitPath.style.width = '200px';
            orbitPath.style.height = '200px';
            orbitPath.style.marginLeft = '-100px';
            orbitPath.style.marginTop = '-100px';
            container.appendChild(orbitPath);

            // æ˜¾ç¤ºå°è¡Œæ˜Ÿåœ¨è½¨é“ä¸Šç§»åŠ¨
            const asteroidElement = document.createElement('div');
            asteroidElement.className = 'asteroid-trail';
            asteroidElement.style.left = '50%';
            asteroidElement.style.top = '50%';
            asteroidElement.style.marginLeft = '-2px';
            asteroidElement.style.marginTop = '-2px';
            container.appendChild(asteroidElement);

            // æ·»åŠ è½¨é“ä¿¡æ¯
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '10px';
            info.style.borderRadius = '5px';
            info.style.fontSize = '12px';
            info.innerHTML = `
                <div><strong>ğŸ›°ï¸ ${asteroid.name}</strong></div>
                <div>ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>é€Ÿåº¦: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>è½¨é“ç±»å‹: è¿‘åœ°è½¨é“</div>
            `;
            container.appendChild(info);

            // 3ç§’åæ¸…ç†
            setTimeout(() => {
                container.remove();
            }, 5000);
        }

        async function showImpactDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // è·å–åœ°å›¾å®¹å™¨å’Œé€‰ä¸­çš„æ’å‡»ä½ç½®
            const mapContainer = document.getElementById('map');
            const mapRect = mapContainer.getBoundingClientRect();
            
            // å°†é€‰ä¸­çš„ç»çº¬åº¦è½¬æ¢ä¸ºå±å¹•åæ ‡
            const mapBounds = map.getBounds();
            const mapSize = map.getSize();
            
            // è®¡ç®—æ’å‡»ç‚¹åœ¨å±å¹•ä¸Šçš„ä½ç½®
            const impactPoint = L.latLng(selectedLocation.lat, selectedLocation.lng);
            const impactPixel = map.latLngToContainerPoint(impactPoint);
            
            // è®¡ç®—è½¨è¿¹èµ·ç‚¹ï¼ˆä»å±å¹•è¾¹ç¼˜éšæœºä½ç½®ï¼‰
            const startX = Math.random() * (mapRect.width - 100) + 50;
            const startY = 50;
            const endX = impactPixel.x;
            const endY = impactPixel.y;

            // åˆ›å»ºå°è¡Œæ˜Ÿè½¨è¿¹
            const asteroidElement = document.createElement('div');
            asteroidElement.className = 'asteroid-trail';
            asteroidElement.style.left = startX + 'px';
            asteroidElement.style.top = startY + 'px';
            asteroidElement.style.setProperty('--target-x', (endX - startX) + 'px');
            asteroidElement.style.setProperty('--target-y', (endY - startY) + 'px');
            container.appendChild(asteroidElement);

            // æ·»åŠ å°è¡Œæ˜Ÿä¿¡æ¯
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.right = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '10px';
            info.style.borderRadius = '5px';
            info.style.fontSize = '12px';
            info.innerHTML = `
                <div><strong>ğŸš€ ${asteroid.name}</strong></div>
                <div>ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>æ’å‡»é€Ÿåº¦: 20,000 m/s</div>
                <div>æ’å‡»è§’åº¦: 45Â°</div>
            `;
            container.appendChild(info);

            // æ’å‡»ç¬é—´æ•ˆæœ
            setTimeout(() => {
                const impactFlash = document.createElement('div');
                impactFlash.className = 'impact-flash';
                impactFlash.style.left = endX + 'px';
                impactFlash.style.top = endY + 'px';
                impactFlash.style.marginLeft = '-10px';
                impactFlash.style.marginTop = '-10px';
                container.appendChild(impactFlash);

                // æ·»åŠ æ’å‡»ä¿¡æ¯
                const impactInfo = document.createElement('div');
                impactInfo.style.position = 'absolute';
                impactInfo.style.bottom = '20px';
                impactInfo.style.left = '50%';
                impactInfo.style.transform = 'translateX(-50%)';
                impactInfo.style.background = 'rgba(255, 0, 0, 0.9)';
                impactInfo.style.color = 'white';
                impactInfo.style.padding = '15px';
                impactInfo.style.borderRadius = '10px';
                impactInfo.style.fontSize = '14px';
                impactInfo.style.fontWeight = 'bold';
                impactInfo.style.textAlign = 'center';
                impactInfo.innerHTML = 'ğŸ’¥ æ’å‡»å‘ç”Ÿï¼';
                container.appendChild(impactInfo);
            }, 2500);

            // 5ç§’åæ¸…ç†
            setTimeout(() => {
                container.remove();
            }, 5000);
        }

        async function show3DOrbitDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // æ£€æŸ¥Three.jsæ˜¯å¦åŠ è½½
            if (typeof THREE === 'undefined') {
                showError('Three.jsåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            try {
                // åˆ›å»º3Dåœºæ™¯
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ alpha: true });
                
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                renderer.setClearColor(0x000000, 0);
            container.appendChild(renderer.domElement);

                // æ·»åŠ è½¨é“æ§åˆ¶å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                let controls = null;
                if (typeof THREE.OrbitControls !== 'undefined') {
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
                }

            // åˆ›å»ºåœ°çƒ
            const earthGeometry = new THREE.SphereGeometry(2, 32, 32);
            const earthMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x4A90E2,
                shininess: 100
            });
            const earth = new THREE.Mesh(earthGeometry, earthMaterial);
            scene.add(earth);

            // åˆ›å»ºå°è¡Œæ˜Ÿ
            const asteroidGeometry = new THREE.SphereGeometry(0.1, 8, 8);
            const asteroidMaterial = new THREE.MeshPhongMaterial({ color: 0xff6b6b });
            const asteroidMesh = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
            scene.add(asteroidMesh);

            // åˆ›å»ºè½¨é“è·¯å¾„
            const orbitGeometry = new THREE.RingGeometry(3, 3.1, 64);
            const orbitMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00aaff, 
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.3
            });
            const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
            orbit.rotation.x = Math.PI / 2;
            scene.add(orbit);

            // æ·»åŠ å…‰ç…§
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // è®¾ç½®ç›¸æœºä½ç½®
            camera.position.set(8, 4, 8);
            controls.target.set(0, 0, 0);

            // æ·»åŠ ä¿¡æ¯é¢æ¿
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '15px';
            info.style.borderRadius = '8px';
            info.style.fontSize = '14px';
            info.style.zIndex = '1000';
            info.innerHTML = `
                <div><strong>ğŸ›°ï¸ ${asteroid.name}</strong></div>
                <div>ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>é€Ÿåº¦: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>è½¨é“ç±»å‹: è¿‘åœ°è½¨é“</div>
                <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                    ä½¿ç”¨é¼ æ ‡æ‹–æ‹½æ—‹è½¬è§†è§’ï¼Œæ»šè½®ç¼©æ”¾
                </div>
            `;
            container.appendChild(info);

            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'âœ• å…³é—­3Dè§†å›¾';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '20px';
            closeBtn.style.right = '20px';
            closeBtn.style.background = 'rgba(255, 0, 0, 0.8)';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.padding = '10px 15px';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.zIndex = '1000';
            closeBtn.onclick = () => {
                container.remove();
            };
            container.appendChild(closeBtn);

                // åŠ¨ç”»å¾ªç¯
                let angle = 0;
                function animate() {
                    requestAnimationFrame(animate);
                    
                    // å°è¡Œæ˜Ÿè½¨é“è¿åŠ¨
                    angle += 0.02;
                    asteroidMesh.position.x = Math.cos(angle) * 3;
                    asteroidMesh.position.z = Math.sin(angle) * 3;
                    asteroidMesh.position.y = Math.sin(angle * 2) * 0.5;

                    // åœ°çƒè‡ªè½¬
                    earth.rotation.y += 0.01;

                    // æ›´æ–°æ§åˆ¶å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                    if (controls) {
                        controls.update();
                    }
                    renderer.render(scene, camera);
                }
            animate();

                // 10ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (container.parentNode) {
                        container.remove();
                    }
                }, 10000);
                
            } catch (error) {
                console.error('3Dæ¼”ç¤ºé”™è¯¯:', error);
                showError('3Dæ¼”ç¤ºåˆå§‹åŒ–å¤±è´¥: ' + error.message);
                // æ¸…ç†å®¹å™¨
                if (container.parentNode) {
                    container.remove();
                }
            }
        }

        async function showSimple3DDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // åˆ›å»ºç®€åŒ–çš„3Dæ¼”ç¤ºï¼ˆä½¿ç”¨CSS 3Då˜æ¢ï¼‰
            const earth = document.createElement('div');
            earth.style.width = '100px';
            earth.style.height = '100px';
            earth.style.borderRadius = '50%';
            earth.style.background = 'radial-gradient(circle at 30% 30%, #4A90E2, #2E5BBA)';
            earth.style.position = 'absolute';
            earth.style.left = '50%';
            earth.style.top = '50%';
            earth.style.marginLeft = '-50px';
            earth.style.marginTop = '-50px';
            earth.style.boxShadow = '0 0 20px rgba(74, 144, 226, 0.5)';
            earth.style.animation = 'earthRotate 10s linear infinite';
            container.appendChild(earth);

            // åˆ›å»ºå°è¡Œæ˜Ÿ
            const asteroidElement = document.createElement('div');
            asteroidElement.style.width = '8px';
            asteroidElement.style.height = '8px';
            asteroidElement.style.borderRadius = '50%';
            asteroidElement.style.background = '#ff6b6b';
            asteroidElement.style.position = 'absolute';
            asteroidElement.style.left = '50%';
            asteroidElement.style.top = '50%';
            asteroidElement.style.marginLeft = '-4px';
            asteroidElement.style.marginTop = '-4px';
            asteroidElement.style.boxShadow = '0 0 10px #ff6b6b';
            asteroidElement.style.animation = 'asteroidOrbit 5s linear infinite';
            container.appendChild(asteroidElement);

            // åˆ›å»ºè½¨é“è·¯å¾„
            const orbit = document.createElement('div');
            orbit.style.width = '200px';
            orbit.style.height = '200px';
            orbit.style.border = '2px dashed #00aaff';
            orbit.style.borderRadius = '50%';
            orbit.style.position = 'absolute';
            orbit.style.left = '50%';
            orbit.style.top = '50%';
            orbit.style.marginLeft = '-100px';
            orbit.style.marginTop = '-100px';
            orbit.style.opacity = '0.5';
            container.appendChild(orbit);

            // æ·»åŠ ä¿¡æ¯é¢æ¿
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '15px';
            info.style.borderRadius = '8px';
            info.style.fontSize = '14px';
            info.style.zIndex = '1000';
            info.innerHTML = `
                <div><strong>ğŸ›°ï¸ ${asteroid.name}</strong></div>
                <div>ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>é€Ÿåº¦: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>è½¨é“ç±»å‹: è¿‘åœ°è½¨é“</div>
                <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                    ç®€åŒ–3Dæ¼”ç¤º - ä½¿ç”¨CSSåŠ¨ç”»
                </div>
            `;
            container.appendChild(info);

            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'âœ• å…³é—­æ¼”ç¤º';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '20px';
            closeBtn.style.right = '20px';
            closeBtn.style.background = 'rgba(255, 0, 0, 0.8)';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.padding = '10px 15px';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.zIndex = '1000';
            closeBtn.onclick = () => {
                container.remove();
            };
            container.appendChild(closeBtn);

            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes earthRotate {
                    from { transform: rotateY(0deg); }
                    to { transform: rotateY(360deg); }
                }
                @keyframes asteroidOrbit {
                    from { 
                        transform: rotate(0deg) translateX(100px) rotate(0deg);
                    }
                    to { 
                        transform: rotate(360deg) translateX(100px) rotate(-360deg);
                    }
                }
            `;
            document.head.appendChild(style);

            // 8ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (container.parentNode) {
                    container.remove();
                }
                document.head.removeChild(style);
            }, 8000);
        }

        async function showImpactTrajectory(asteroidId, show3DEffect = true) {
            // è·å–å°è¡Œæ˜Ÿæ•°æ®
            const response = await fetch('http://localhost:8000/asteroids');
            const asteroids = await response.json();
            const asteroid = asteroids.find(a => a.id === asteroidId);
            
            if (!asteroid) return;

            // åˆ›å»ºè½¨è¿¹å®¹å™¨
            const container = document.createElement('div');
            container.id = 'trajectory-container';
            container.style.position = 'absolute';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '1000';
            document.getElementById('map').appendChild(container);

            // è®¡ç®—æ’å‡»ç‚¹åœ¨å±å¹•ä¸Šçš„ä½ç½®
            const impactPoint = L.latLng(selectedLocation.lat, selectedLocation.lng);
            const impactPixel = map.latLngToContainerPoint(impactPoint);

            // åˆ›å»ºè½¨è¿¹æ•ˆæœ
            await create3DTrajectory(container, impactPixel, asteroid, show3DEffect);

            // æ˜¾ç¤ºç»çº¬åº¦ä¿¡æ¯
            if (document.getElementById('show-coordinates').checked) {
                showCoordinates(selectedLocation.lat, selectedLocation.lng);
            }
            
            // æ˜¾ç¤ºè½¨é“ä¿¡æ¯
            showOrbitalInfo(asteroid);

            // 3ç§’åæ¸…ç†è½¨è¿¹ï¼Œä½†ä¸æ˜¾ç¤ºå½±å“åœˆå±‚
            setTimeout(() => {
                if (container.parentNode) {
                    container.remove();
                }
            }, 3000);
        }

        function showCoordinates(lat, lng) {
            // åˆ›å»ºç»çº¬çº¿ç½‘æ ¼
            createGridLines(lat, lng);
            
            // åˆ›å»ºç»çº¬åº¦æ˜¾ç¤ºæ¡†
            const coordBox = document.createElement('div');
            coordBox.id = 'coordinates-display';
            coordBox.style.position = 'absolute';
            coordBox.style.top = '20px';
            coordBox.style.right = '20px';
            coordBox.style.background = 'rgba(0, 0, 0, 0.8)';
            coordBox.style.color = 'white';
            coordBox.style.padding = '10px';
            coordBox.style.borderRadius = '5px';
            coordBox.style.fontSize = '14px';
            coordBox.style.zIndex = '1001';
            coordBox.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“ æ’å‡»åæ ‡</div>
                <div>çº¬åº¦: ${lat ? lat.toFixed(4) : 'N/A'}Â°</div>
                <div>ç»åº¦: ${lng ? lng.toFixed(4) : 'N/A'}Â°</div>
            `;
            
            document.getElementById('map').appendChild(coordBox);
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (coordBox.parentNode) {
                    coordBox.remove();
                }
                // æ¸…é™¤ç½‘æ ¼çº¿
                clearGridLines();
            }, 5000);
        }

        function createGridLines(lat, lng) {
            // åˆ›å»ºç»çº¿ï¼ˆå‚ç›´çº¿ï¼‰
            const meridian = L.polyline([
                [90, lng], [-90, lng]
            ], {
                color: '#ff6b6b',
                weight: 2,
                opacity: 0.8,
                dashArray: '5, 5'
            }).addTo(map);
            meridian._gridId = 'meridian';

            // åˆ›å»ºçº¬çº¿ï¼ˆæ°´å¹³çº¿ï¼‰
            const parallel = L.polyline([
                [lat, -180], [lat, 180]
            ], {
                color: '#ff6b6b',
                weight: 2,
                opacity: 0.8,
                dashArray: '5, 5'
            }).addTo(map);
            parallel._gridId = 'parallel';

            // æ·»åŠ æ ‡ç­¾
            const latLabel = L.marker([lat, lng + 5], {
                icon: L.divIcon({
                    className: 'grid-label',
                    html: `${lat ? lat.toFixed(2) : 'N/A'}Â°`,
                    iconSize: [50, 20],
                    iconAnchor: [25, 10]
                })
            }).addTo(map);
            latLabel._gridId = 'lat-label';

            const lngLabel = L.marker([lat + 2, lng], {
                icon: L.divIcon({
                    className: 'grid-label',
                    html: `${lng ? lng.toFixed(2) : 'N/A'}Â°`,
                    iconSize: [50, 20],
                    iconAnchor: [25, 10]
                })
            }).addTo(map);
            lngLabel._gridId = 'lng-label';
        }

        function clearGridLines() {
            map.eachLayer(function(layer) {
                if (layer._gridId) {
                    map.removeLayer(layer);
                }
            });
        }

        function showOrbitalInfo(asteroid) {
            const orbitalData = asteroid.orbital_data || {};
            const closeApproachData = asteroid.close_approach_data || [];
            
            // åˆ›å»ºè½¨é“ä¿¡æ¯æ˜¾ç¤ºæ¡†
            const orbitalBox = document.createElement('div');
            orbitalBox.id = 'orbital-info';
            orbitalBox.style.position = 'absolute';
            orbitalBox.style.bottom = '20px';
            orbitalBox.style.right = '20px';
            orbitalBox.style.background = 'rgba(0, 0, 0, 0.8)';
            orbitalBox.style.color = 'white';
            orbitalBox.style.padding = '10px';
            orbitalBox.style.borderRadius = '5px';
            orbitalBox.style.fontSize = '12px';
            orbitalBox.style.zIndex = '1001';
            orbitalBox.style.maxWidth = '250px';
            
            let orbitalInfo = `
                <div style="font-weight: bold; margin-bottom: 5px;">ğŸ›°ï¸ è½¨é“ä¿¡æ¯</div>
                <div>å°è¡Œæ˜Ÿ: ${asteroid.name}</div>
            `;
            
            if (orbitalData && orbitalData.inclination && !isNaN(parseFloat(orbitalData.inclination))) {
                orbitalInfo += `<div>è½¨é“å€¾è§’: ${parseFloat(orbitalData.inclination).toFixed(2)}Â°</div>`;
            }
            if (orbitalData && orbitalData.eccentricity && !isNaN(parseFloat(orbitalData.eccentricity))) {
                orbitalInfo += `<div>åå¿ƒç‡: ${parseFloat(orbitalData.eccentricity).toFixed(3)}</div>`;
            }
            if (orbitalData && orbitalData.orbital_period && !isNaN(parseFloat(orbitalData.orbital_period))) {
                orbitalInfo += `<div>è½¨é“å‘¨æœŸ: ${parseFloat(orbitalData.orbital_period).toFixed(1)}å¤©</div>`;
            }
            if (closeApproachData.length > 0) {
                const approach = closeApproachData[0];
                if (approach && approach.relative_velocity && approach.relative_velocity.kilometers_per_second) {
                    orbitalInfo += `<div>æ¥è¿‘é€Ÿåº¦: ${parseFloat(approach.relative_velocity.kilometers_per_second).toFixed(1)} km/s</div>`;
                }
            }
            
            orbitalBox.innerHTML = orbitalInfo;
            document.getElementById('map').appendChild(orbitalBox);
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (orbitalBox.parentNode) {
                    orbitalBox.remove();
                }
            }, 5000);
        }

        async function showImpactZones(lat, lng, asteroid) {
            // ä½¿ç”¨åç«¯APIçš„ç²¾ç¡®è®¡ç®—
            try {
            const simulationData = {
                    asteroid_id: asteroid.id,
                    impact_latitude: lat,
                    impact_longitude: lng,
                    impact_angle: 45,
                    impact_velocity: parseFloat(asteroid.velocity) || 20000,
                    target_type: "continental_crust"
                };
                
                const response = await fetch('http://localhost:8000/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(simulationData)
                });

                if (!response.ok) {
                    throw new Error('æ¨¡æ‹Ÿå¤±è´¥');
                }

                const result = await response.json();
                
                // ä½¿ç”¨åç«¯è®¡ç®—çš„ç²¾ç¡®æ•°æ®
                const craterDiameter = result.crater_diameter; // ç±³
                const craterRadius = craterDiameter / 2000; // è½¬æ¢ä¸ºå…¬é‡ŒåŠå¾„
                
                // åŸºäºç²¾ç¡®é™¨çŸ³å‘ç›´å¾„è®¡ç®—å…¶ä»–åœˆå±‚
                const immediateRadius = craterRadius * 5; // ç«‹å³å½±å“åŒºåŸŸ
                const severeRadius = craterRadius * 15; // ä¸¥é‡å½±å“åŒºåŸŸ
                const moderateRadius = craterRadius * 30; // ä¸­ç­‰å½±å“åŒºåŸŸ
                const lightRadius = craterRadius * 50; // è½»å¾®å½±å“åŒºåŸŸ
                
                // åˆ›å»ºä¸åŒåœˆå±‚
                const zones = [
                    {
                        radius: craterRadius,
                        color: '#ff0000',
                        opacity: 0.8,
                        label: 'é™¨çŸ³å‘',
                        description: 'ç›´æ¥æ’å‡»åŒºåŸŸ'
                    },
                    {
                        radius: immediateRadius,
                        color: '#ff4400',
                        opacity: 0.6,
                        label: 'ç«‹å³å½±å“åŒº',
                        description: 'çˆ†ç‚¸ã€åœ°éœ‡ã€çƒ­è¾å°„'
                    },
                    {
                        radius: severeRadius,
                        color: '#ff8800',
                        opacity: 0.4,
                        label: 'ä¸¥é‡å½±å“åŒº',
                        description: 'å¼ºçƒˆåœ°éœ‡ã€å†²å‡»æ³¢'
                    },
                    {
                        radius: moderateRadius,
                        color: '#ffaa00',
                        opacity: 0.3,
                        label: 'ä¸­ç­‰å½±å“åŒº',
                        description: 'ä¸­ç­‰åœ°éœ‡ã€ç¢ç‰‡é£æº…'
                    },
                    {
                        radius: lightRadius,
                        color: '#ffcc00',
                        opacity: 0.2,
                        label: 'è½»å¾®å½±å“åŒº',
                        description: 'è½»å¾®åœ°éœ‡ã€å£°æ³¢'
                    }
                ];
                
                // åˆ›å»ºå½±å“åœˆå±‚
                createImpactCircles(lat, lng, zones);
                
                // æ·»åŠ å›¾ä¾‹
                showImpactLegend(zones);
                
            } catch (error) {
                console.error('è·å–ç²¾ç¡®æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–è®¡ç®—:', error);
                // å›é€€åˆ°ç®€åŒ–è®¡ç®—
                const diameter = (parseFloat(asteroid.diameter_min) + parseFloat(asteroid.diameter_max)) / 2;
                const craterRadius = Math.max(0.1, diameter * 0.1);
                const immediateRadius = craterRadius * 5;
                const severeRadius = craterRadius * 15;
                const moderateRadius = craterRadius * 30;
                const lightRadius = craterRadius * 50;
                
                const zones = [
                    { radius: craterRadius, color: '#ff0000', opacity: 0.8, label: 'é™¨çŸ³å‘', description: 'ç›´æ¥æ’å‡»åŒºåŸŸ' },
                    { radius: immediateRadius, color: '#ff4400', opacity: 0.6, label: 'ç«‹å³å½±å“åŒº', description: 'çˆ†ç‚¸ã€åœ°éœ‡ã€çƒ­è¾å°„' },
                    { radius: severeRadius, color: '#ff8800', opacity: 0.4, label: 'ä¸¥é‡å½±å“åŒº', description: 'å¼ºçƒˆåœ°éœ‡ã€å†²å‡»æ³¢' },
                    { radius: moderateRadius, color: '#ffaa00', opacity: 0.3, label: 'ä¸­ç­‰å½±å“åŒº', description: 'ä¸­ç­‰åœ°éœ‡ã€ç¢ç‰‡é£æº…' },
                    { radius: lightRadius, color: '#ffcc00', opacity: 0.2, label: 'è½»å¾®å½±å“åŒº', description: 'è½»å¾®åœ°éœ‡ã€å£°æ³¢' }
                ];
                
                createImpactCircles(lat, lng, zones);
                showImpactLegend(zones);
            }
        }

        function createImpactCircles(lat, lng, zones) {
            // åˆ›å»ºå½±å“åœˆå±‚
            zones.forEach((zone, index) => {
                const circle = L.circle([lat, lng], {
                    radius: zone.radius * 1000, // è½¬æ¢ä¸ºç±³
                    color: zone.color,
                    fillColor: zone.color,
                    fillOpacity: zone.opacity,
                    weight: 2,
                    dashArray: index === 0 ? '0' : '5, 5' // é™¨çŸ³å‘å®çº¿ï¼Œå…¶ä»–è™šçº¿
                }).addTo(map);
                
                circle._impactZone = true;
                
                // æ·»åŠ æ ‡ç­¾
                if (zone.radius > 1) { // åªå¯¹è¾ƒå¤§çš„åœˆå±‚æ·»åŠ æ ‡ç­¾
                    const label = L.marker([lat + zone.radius * 0.01, lng + zone.radius * 0.01], {
                        icon: L.divIcon({
                            className: 'impact-zone-label',
                            html: `
                                <div style="background: ${zone.color}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; text-align: center; border: 1px solid white;">
                                    ${zone.label}<br>
                                    <small>${zone.radius ? zone.radius.toFixed(1) : 'N/A'}km</small>
                </div>
                            `,
                            iconSize: [60, 30],
                            iconAnchor: [30, 15]
                        })
                    }).addTo(map);
                    label._impactZone = true;
                }
            });
        }

        function showImpactLegend(zones) {
            const legend = document.createElement('div');
            legend.id = 'impact-legend';
            legend.style.position = 'absolute';
            legend.style.top = '20px';
            legend.style.right = '20px';
            legend.style.background = 'rgba(0, 0, 0, 0.9)';
            legend.style.color = 'white';
            legend.style.padding = '15px';
            legend.style.borderRadius = '8px';
            legend.style.fontSize = '12px';
            legend.style.zIndex = '1001';
            legend.style.maxWidth = '220px';
            legend.style.border = '2px solid #ff6b6b';
            legend.style.boxShadow = '0 4px 8px rgba(0,0,0,0.5)';
            
            let legendHtml = '<h4 style="margin: 0 0 10px 0; color: #ff6b6b; text-align: center;">ğŸ’¥ æ’å‡»å½±å“èŒƒå›´</h4>';
            
            // æ˜¾ç¤ºæ‰€æœ‰5ä¸ªåœˆå±‚
            zones.forEach((zone, index) => {
                const lineStyle = index === 0 ? 'solid' : 'dashed';
                legendHtml += `
                    <div style="display: flex; align-items: center; margin: 8px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                        <div style="width: 20px; height: 3px; background: ${zone.color}; margin-right: 10px; border-radius: 2px; border: 1px solid white; border-style: ${lineStyle};"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: ${zone.color};">${zone.label}</div>
                            <div style="font-size: 10px; color: #ccc;">${zone.radius ? (zone.radius/1000).toFixed(1) : 'N/A'}km - ${zone.description}</div>
                </div>
                </div>
                `;
            });
            
            legend.innerHTML = legendHtml;
            document.getElementById('map').appendChild(legend);
            
            // 15ç§’ååªéšè—å›¾ä¾‹ï¼Œä¿ç•™å½±å“åœˆå±‚
            setTimeout(() => {
                if (legend.parentNode) {
                    legend.remove();
                }
                // ä¸å†è‡ªåŠ¨æ¸…é™¤å½±å“åœˆå±‚ï¼Œè®©å®ƒä»¬æŒç»­æ˜¾ç¤º
            }, 15000);
        }

        function clearImpactZones() {
            map.eachLayer(function(layer) {
                if (layer._impactZone) {
                    map.removeLayer(layer);
                }
            });
        }

        function clearAllDisplays() {
            // æ¸…é™¤æ‰€æœ‰å½±å“åœˆå±‚
            clearImpactZones();
            
            // æ¸…é™¤æ’å‡»æ ‡è®°
            if (impactMarker) {
                map.removeLayer(impactMarker);
                impactMarker = null;
            }
            if (currentImpactMarker) {
                map.removeLayer(currentImpactMarker);
                currentImpactMarker = null;
            }
            if (impactCircle) {
                map.removeLayer(impactCircle);
                impactCircle = null;
            }
            
            // æ¸…é™¤åŸå¸‚æ ‡è®°
            cityMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            cityMarkers = [];
            
            // æ¸…é™¤è½¨è¿¹å®¹å™¨
            const trajectoryContainer = document.getElementById('trajectory-container');
            if (trajectoryContainer) {
                trajectoryContainer.remove();
            }
            
            // æ¸…é™¤ç»çº¬çº¿ç½‘æ ¼
            map.eachLayer(function(layer) {
                if (layer._gridId) {
                    map.removeLayer(layer);
                }
            });
            
            // æ¸…é™¤ä¿¡æ¯é¢æ¿
            const orbitalInfo = document.getElementById('orbital-info');
            if (orbitalInfo) {
                orbitalInfo.remove();
            }
            
            const historyInfo = document.getElementById('history-info');
            if (historyInfo) {
                historyInfo.remove();
            }
            
            console.log('All displays cleared');
        }

        // å†å²æ¨¡æ‹ŸæŸ¥è¯¢åŠŸèƒ½
        function showHistoryModal() {
            document.getElementById('history-modal').style.display = 'block';
            loadHistoryData();
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
        }

        async function loadHistoryData() {
            try {
                // æ¨¡æ‹Ÿå†å²æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥ä»åç«¯è·å–ï¼‰
                const mockHistory = [
                    {
                        id: 1,
                        asteroidName: "2062 Aten (1976 AA)",
                        date: "2024-01-15",
                        location: "33.14Â°, 120.59Â°",
                        craterDiameter: 1000,
                        impactVelocity: 11300,
                        seismicMagnitude: 11.3,
                        tsunamiHeight: 61,
                        populationLoss: 54772,
                        buildingLoss: 362.3,
                        totalEconomicLoss: 83.2
                    },
                    {
                        id: 2,
                        asteroidName: "99942 Apophis",
                        date: "2024-01-10",
                        location: "40.71Â°, -74.01Â°",
                        craterDiameter: 2500,
                        impactVelocity: 15000,
                        seismicMagnitude: 12.1,
                        tsunamiHeight: 85,
                        populationLoss: 125000,
                        buildingLoss: 850.7,
                        totalEconomicLoss: 195.3
                    },
                    {
                        id: 3,
                        asteroidName: "101955 Bennu",
                        date: "2024-01-05",
                        location: "51.51Â°, -0.13Â°",
                        craterDiameter: 800,
                        impactVelocity: 9800,
                        seismicMagnitude: 10.8,
                        tsunamiHeight: 45,
                        populationLoss: 32000,
                        buildingLoss: 180.5,
                        totalEconomicLoss: 42.1
                    }
                ];
                
                displayHistoryResults(mockHistory);
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
                document.getElementById('history-results').innerHTML = 
                    '<div style="color: #ff4444; text-align: center; padding: 20px;">åŠ è½½å†å²æ•°æ®å¤±è´¥</div>';
            }
        }

        function displayHistoryResults(historyData) {
            const resultsContainer = document.getElementById('history-results');
            
            if (historyData.length === 0) {
                resultsContainer.innerHTML = '<div style="color: #aaa; text-align: center; padding: 20px;">æš‚æ— å†å²æ¨¡æ‹Ÿæ•°æ®</div>';
                return;
            }
            
            let html = '';
            historyData.forEach(item => {
                html += `
                    <div class="history-item" onclick="loadHistorySimulation(${item.id})">
                        <h3>${item.asteroidName}</h3>
                        <div class="meta">
                            ğŸ“… ${item.date} | ğŸ“ ${item.location}
                </div>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-value">${item.craterDiameter}m</div>
                                <div class="stat-label">é™¨çŸ³å‘ç›´å¾„</div>
                </div>
                            <div class="stat-item">
                                <div class="stat-value">${item.impactVelocity/1000}km/s</div>
                                <div class="stat-label">æ’å‡»é€Ÿåº¦</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${item.seismicMagnitude}</div>
                                <div class="stat-label">åœ°éœ‡éœ‡çº§</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${item.populationLoss.toLocaleString()}</div>
                                <div class="stat-label">äººå£æŸå¤±</div>
                            </div>
                        </div>
                </div>
            `;
            });
            
            resultsContainer.innerHTML = html;
        }

        function searchHistory() {
            const asteroidName = document.getElementById('asteroid-name-filter').value.toLowerCase();
            const startDate = document.getElementById('start-date-filter').value;
            const endDate = document.getElementById('end-date-filter').value;
            const location = document.getElementById('location-filter').value.toLowerCase();
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIè¿›è¡Œæœç´¢
            // ç›®å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            loadHistoryData();
        }

        function loadHistorySimulation(simulationId) {
            // åŠ è½½å†å²æ¨¡æ‹Ÿåˆ°åœ°å›¾ä¸Š
            console.log('åŠ è½½å†å²æ¨¡æ‹Ÿ:', simulationId);
            
            // æ¨¡æ‹Ÿå†å²æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥ä»åç«¯è·å–ï¼‰
            const mockHistory = [
                {
                    id: 1,
                    asteroidName: "2062 Aten (1976 AA)",
                    date: "2024-01-15",
                    location: "33.14Â°, 120.59Â°",
                    lat: 33.14,
                    lng: 120.59,
                    craterDiameter: 1000,
                    impactVelocity: 11300,
                    seismicMagnitude: 11.3,
                    tsunamiHeight: 61,
                    populationLoss: 54772,
                    buildingLoss: 362.3,
                    totalEconomicLoss: 83.2
                },
                {
                    id: 2,
                    asteroidName: "99942 Apophis",
                    date: "2024-01-10",
                    location: "40.71Â°, -74.01Â°",
                    lat: 40.71,
                    lng: -74.01,
                    craterDiameter: 2500,
                    impactVelocity: 15000,
                    seismicMagnitude: 12.1,
                    tsunamiHeight: 85,
                    populationLoss: 125000,
                    buildingLoss: 850.7,
                    totalEconomicLoss: 195.3
                },
                {
                    id: 3,
                    asteroidName: "101955 Bennu",
                    date: "2024-01-05",
                    location: "51.51Â°, -0.13Â°",
                    lat: 51.51,
                    lng: -0.13,
                    craterDiameter: 800,
                    impactVelocity: 9800,
                    seismicMagnitude: 10.8,
                    tsunamiHeight: 45,
                    populationLoss: 32000,
                    buildingLoss: 180.5,
                    totalEconomicLoss: 42.1
                }
            ];
            
            const historyItem = mockHistory.find(item => item.id === simulationId);
            if (historyItem) {
                // æ¸…é™¤ä¹‹å‰çš„å½±å“åœˆå±‚
                clearImpactZones();
                
                // ç§»åŠ¨åˆ°æ’å‡»ä½ç½®ï¼Œä½¿ç”¨åˆé€‚çš„ç¼©æ”¾çº§åˆ«
                const maxRadius = Math.max(historyItem.craterDiameter / 2000 * 50, 50); // ç¡®ä¿èƒ½çœ‹åˆ°æœ€å¤§åœˆå±‚
                const zoomLevel = Math.max(4, Math.min(8, 10 - Math.log2(maxRadius / 100)));
                map.setView([historyItem.lat, historyItem.lng], zoomLevel);
                
                // æ˜¾ç¤ºå½±å“åœˆå±‚
                showHistoryImpactZones(historyItem);
                
                // æ˜¾ç¤ºå†å²æ¨¡æ‹Ÿä¿¡æ¯
                showHistoryInfo(historyItem);
                
                // å…³é—­æ¨¡æ€æ¡†
                closeHistoryModal();
            }
        }

        function showHistoryImpactZones(historyItem) {
            const lat = historyItem.lat;
            const lng = historyItem.lng;
            const craterDiameter = historyItem.craterDiameter; // ç±³
            const craterRadius = craterDiameter / 2; // è½¬æ¢ä¸ºç±³åŠå¾„ï¼Œä¸å®æ—¶æ¨¡æ‹Ÿä¿æŒä¸€è‡´
            
            console.log('å†å²æ¨¡æ‹Ÿåœˆå±‚è®¡ç®—:', {
                craterDiameter,
                craterRadius,
                lat,
                lng
            });
            
            // ç¡®ä¿æœ€å°åŠå¾„ï¼Œé¿å…åœˆå±‚å¤ªå°çœ‹ä¸è§
            const minRadius = 10; // æœ€å°10å…¬é‡Œ
            const adjustedCraterRadius = Math.max(craterRadius, minRadius);
            
            // åŸºäºè°ƒæ•´åçš„é™¨çŸ³å‘åŠå¾„è®¡ç®—å…¶ä»–åœˆå±‚
            const immediateRadius = adjustedCraterRadius * 5; // ç«‹å³å½±å“åŒºåŸŸ
            const severeRadius = adjustedCraterRadius * 15; // ä¸¥é‡å½±å“åŒºåŸŸ
            const moderateRadius = adjustedCraterRadius * 30; // ä¸­ç­‰å½±å“åŒºåŸŸ
            const lightRadius = adjustedCraterRadius * 50; // è½»å¾®å½±å“åŒºåŸŸ
            
            // åˆ›å»ºä¸åŒåœˆå±‚
            const zones = [
                {
                    radius: adjustedCraterRadius,
                    color: '#ff0000',
                    opacity: 0.8,
                    label: 'é™¨çŸ³å‘',
                    description: 'ç›´æ¥æ’å‡»åŒºåŸŸ'
                },
                {
                    radius: immediateRadius,
                    color: '#ff4400',
                    opacity: 0.6,
                    label: 'ç«‹å³å½±å“åŒº',
                    description: 'çˆ†ç‚¸ã€åœ°éœ‡ã€çƒ­è¾å°„'
                },
                {
                    radius: severeRadius,
                    color: '#ff8800',
                    opacity: 0.4,
                    label: 'ä¸¥é‡å½±å“åŒº',
                    description: 'å¼ºçƒˆåœ°éœ‡ã€å†²å‡»æ³¢'
                },
                {
                    radius: moderateRadius,
                    color: '#ffaa00',
                    opacity: 0.3,
                    label: 'ä¸­ç­‰å½±å“åŒº',
                    description: 'ä¸­ç­‰åœ°éœ‡ã€ç¢ç‰‡é£æº…'
                },
                {
                    radius: lightRadius,
                    color: '#ffcc00',
                    opacity: 0.2,
                    label: 'è½»å¾®å½±å“åŒº',
                    description: 'è½»å¾®åœ°éœ‡ã€å£°æ³¢'
                }
            ];
            
            console.log('å†å²æ¨¡æ‹Ÿåœˆå±‚æ•°æ®:', zones);
            
            // åˆ›å»ºå½±å“åœˆå±‚
            createImpactCircles(lat, lng, zones);
            
            // æ·»åŠ å†å²æ ‡è®°
            const historyMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'history-marker',
                    html: `
                        <div style="background: #4a90e2; color: white; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; text-align: center; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                            ğŸ“Š å†å²æ¨¡æ‹Ÿ<br>
                            <small>${historyItem.asteroidName}</small>
                        </div>
                    `,
                    iconSize: [80, 40],
                    iconAnchor: [40, 20]
                })
            }).addTo(map);
            historyMarker._impactZone = true;
            
            // æ·»åŠ å›¾ä¾‹
            showImpactLegend(zones);
        }

        function showHistoryInfo(historyItem) {
            // åˆ›å»ºå†å²ä¿¡æ¯æ˜¾ç¤ºæ¡†
            const historyInfo = document.createElement('div');
            historyInfo.id = 'history-info';
            historyInfo.style.position = 'absolute';
            historyInfo.style.top = '20px';
            historyInfo.style.left = '20px';
            historyInfo.style.background = 'rgba(74, 144, 226, 0.9)';
            historyInfo.style.color = 'white';
            historyInfo.style.padding = '15px';
            historyInfo.style.borderRadius = '8px';
            historyInfo.style.fontSize = '14px';
            historyInfo.style.zIndex = '1001';
            historyInfo.style.maxWidth = '300px';
            historyInfo.style.border = '2px solid #4a90e2';
            
            historyInfo.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">
                    ğŸ“Š å†å²æ¨¡æ‹Ÿè¯¦æƒ…
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>å°è¡Œæ˜Ÿ:</strong> ${historyItem.asteroidName}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>æ¨¡æ‹Ÿæ—¥æœŸ:</strong> ${historyItem.date}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>æ’å‡»ä½ç½®:</strong> ${historyItem.location}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>é™¨çŸ³å‘ç›´å¾„:</strong> ${historyItem.craterDiameter}m
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>æ’å‡»é€Ÿåº¦:</strong> ${historyItem.impactVelocity ? (historyItem.impactVelocity/1000).toFixed(1) : 'N/A'}km/s
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>åœ°éœ‡éœ‡çº§:</strong> ${historyItem.seismicMagnitude}
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>æµ·å•¸é«˜åº¦:</strong> ${historyItem.tsunamiHeight}m
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>äººå£æŸå¤±:</strong> ${historyItem.populationLoss.toLocaleString()}äºº
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>å»ºç­‘æŸå¤±:</strong> $${historyItem.buildingLoss}B
                </div>
                <div style="margin-bottom: 8px;">
                    <strong>æ€»ç»æµæŸå¤±:</strong> $${historyItem.totalEconomicLoss}B
                </div>
                <button onclick="clearHistoryDisplay()" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                    âœ• æ¸…é™¤æ˜¾ç¤º
                </button>
            `;
            
            document.getElementById('map').appendChild(historyInfo);
        }

        function clearHistoryDisplay() {
            // æ¸…é™¤å†å²ä¿¡æ¯æ˜¾ç¤º
            const historyInfo = document.getElementById('history-info');
            if (historyInfo) {
                historyInfo.remove();
            }
            
            // æ¸…é™¤å½±å“åœˆå±‚
            clearImpactZones();
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('history-modal');
            if (event.target === modal) {
                closeHistoryModal();
            }
        }

        // æŠ˜å /å±•å¼€ç»“æœé¢æ¿
        function toggleResults() {
            const resultsDiv = document.getElementById('results');
            const toggleBtn = document.getElementById('results-toggle');
            
            if (resultsDiv.classList.contains('collapsed')) {
                resultsDiv.classList.remove('collapsed');
                toggleBtn.textContent = 'âˆ’';
                toggleBtn.title = 'æŠ˜å é¢æ¿';
            } else {
                resultsDiv.classList.add('collapsed');
                toggleBtn.textContent = '+';
                toggleBtn.title = 'å±•å¼€é¢æ¿';
            }
        }

        async function create3DTrajectory(container, impactPixel, asteroid, show3DEffect = true) {
            // æ ¹æ®å°è¡Œæ˜Ÿè½¨é“æ•°æ®è®¡ç®—çœŸå®è½¨è¿¹
            const orbitalData = asteroid.orbital_data || {};
            const closeApproachData = asteroid.close_approach_data || [];
            
            console.log('ğŸŒ åˆ›å»ºçœŸå®è½¨è¿¹æ¨¡æ‹Ÿ');
            console.log('å°è¡Œæ˜Ÿ:', asteroid.name);
            console.log('è½¨é“æ•°æ®:', orbitalData);
            console.log('æ¥è¿‘æ•°æ®:', closeApproachData);
            
            // è®¡ç®—æ’å‡»è§’åº¦ï¼ˆåŸºäºè½¨é“å€¾è§’ï¼‰
            let impactAngle = 45; // é»˜è®¤è§’åº¦
            if (orbitalData.inclination && !isNaN(parseFloat(orbitalData.inclination))) {
                const inclination = parseFloat(orbitalData.inclination);
                // è½¨é“å€¾è§’è¶Šå¤§ï¼Œæ’å‡»è§’åº¦è¶Šå¤§ï¼ˆæ›´æ¥è¿‘æ°´å¹³ï¼‰
                impactAngle = Math.min(85, Math.max(15, inclination * 0.8 + 20));
                console.log('ğŸ“ è½¨é“å€¾è§’:', inclination, 'Â° â†’ æ’å‡»è§’åº¦:', impactAngle, 'Â°');
            }
            
            // æ ¹æ®è½¨é“åå¿ƒç‡è®¡ç®—è½¨è¿¹å¼¯æ›²åº¦
            let trajectoryCurvature = 0;
            if (orbitalData.eccentricity && !isNaN(parseFloat(orbitalData.eccentricity))) {
                const eccentricity = parseFloat(orbitalData.eccentricity);
                // åå¿ƒç‡è¶Šå¤§ï¼Œè½¨è¿¹è¶Šå¼¯æ›²
                trajectoryCurvature = Math.min(30, Math.max(-30, (eccentricity - 0.5) * 60));
                console.log('ğŸ”„ è½¨é“åå¿ƒç‡:', eccentricity, 'â†’ è½¨è¿¹å¼¯æ›²åº¦:', trajectoryCurvature, 'Â°');
            }
            
            // è®¡ç®—è½¨è¿¹æ–¹å‘ï¼ˆåŸºäºè½¨é“å‚æ•°å’Œæ¥è¿‘æ–¹å‘ï¼‰
            let trajectoryDirection = 0; // é»˜è®¤ä»ä¸Šæ–¹
            let trajectoryLength = 200;
            let animationDuration = 3000;
            let approachDirection = 0; // æ¥è¿‘æ–¹å‘è§’åº¦
            
            if (closeApproachData.length > 0) {
                const approach = closeApproachData[0];
                const relativeVelocity = approach.relative_velocity || {};
                
                // æ ¹æ®ç›¸å¯¹é€Ÿåº¦è®¡ç®—è½¨è¿¹é•¿åº¦å’ŒåŠ¨ç”»æ—¶é•¿
                if (relativeVelocity.kilometers_per_second && !isNaN(parseFloat(relativeVelocity.kilometers_per_second))) {
                    const velocity = parseFloat(relativeVelocity.kilometers_per_second);
                    trajectoryLength = Math.min(500, Math.max(200, velocity * 10));
                    animationDuration = Math.min(6000, Math.max(2000, 5000 - velocity * 40));
                    
                    // æ ¹æ®é€Ÿåº¦è®¡ç®—åŸºç¡€è½¨è¿¹æ–¹å‘
                    trajectoryDirection = Math.min(60, Math.max(-60, (velocity - 15) * 2));
                    
                    console.log('ğŸš€ ç›¸å¯¹é€Ÿåº¦:', velocity, 'km/s â†’ é•¿åº¦:', trajectoryLength, 'px æ—¶é•¿:', animationDuration, 'ms');
                }
                
                // æ ¹æ®è½¨é“å€¾è§’è®¡ç®—æ¥è¿‘æ–¹å‘
                if (orbitalData.inclination && !isNaN(parseFloat(orbitalData.inclination))) {
                    const inclination = parseFloat(orbitalData.inclination);
                    // è½¨é“å€¾è§’å½±å“æ¥è¿‘æ–¹å‘ï¼ˆ0-180åº¦ï¼‰
                    approachDirection = (inclination * 2) % 360;
                    console.log('ğŸ“ è½¨é“å€¾è§’:', inclination, 'Â° â†’ æ¥è¿‘æ–¹å‘:', approachDirection, 'Â°');
                }
                
                // æ ¹æ®è½¨é“åå¿ƒç‡è®¡ç®—è½¨è¿¹å¼¯æ›²
                if (orbitalData.eccentricity && !isNaN(parseFloat(orbitalData.eccentricity))) {
                    const eccentricity = parseFloat(orbitalData.eccentricity);
                    // åå¿ƒç‡è¶Šå¤§ï¼Œè½¨è¿¹è¶Šå¼¯æ›²
                    const curvature = (eccentricity - 0.5) * 30;
                    approachDirection += curvature;
                    console.log('ğŸ”„ è½¨é“åå¿ƒç‡:', eccentricity, 'â†’ è½¨è¿¹å¼¯æ›²:', curvature, 'Â°');
                }
                
                // æ ¹æ®è½¨é“å‘¨æœŸè°ƒæ•´è½¨è¿¹ç‰¹å¾
                if (orbitalData.orbital_period && !isNaN(parseFloat(orbitalData.orbital_period))) {
                    const period = parseFloat(orbitalData.orbital_period);
                    // è½¨é“å‘¨æœŸè¶Šé•¿ï¼Œè½¨è¿¹è¶Šå¹³ç¼“
                    const periodEffect = Math.min(20, Math.max(-20, (period - 365) * 0.05));
                    approachDirection += periodEffect;
                    console.log('â° è½¨é“å‘¨æœŸ:', period, 'å¤© â†’ è½¨è¿¹è°ƒæ•´:', periodEffect, 'Â°');
                }
            }
            
            // è®¡ç®—æœ€ç»ˆè½¨è¿¹æ–¹å‘ï¼ˆç»“åˆæ‰€æœ‰å› ç´ ï¼‰
            const finalDirection = (trajectoryDirection + approachDirection + trajectoryCurvature) % 360;
            console.log('ğŸ¯ æœ€ç»ˆè½¨è¿¹æ–¹å‘:', finalDirection, 'Â° (åŸºç¡€:', trajectoryDirection, 'Â° + æ¥è¿‘:', approachDirection, 'Â° + å¼¯æ›²:', trajectoryCurvature, 'Â°)');
            
            // æ ¹æ®è½¨é“å‘¨æœŸè°ƒæ•´åŠ¨ç”»é€Ÿåº¦
            if (orbitalData.orbital_period && !isNaN(parseFloat(orbitalData.orbital_period))) {
                const period = parseFloat(orbitalData.orbital_period);
                // è½¨é“å‘¨æœŸè¶Šé•¿ï¼ŒåŠ¨ç”»è¶Šæ…¢
                animationDuration = Math.min(6000, Math.max(2000, period * 0.1));
                console.log('â° è½¨é“å‘¨æœŸ:', period, 'å¤© â†’ åŠ¨ç”»æ—¶é•¿:', animationDuration, 'ms');
            }
            
            // è®¡ç®—æœ€ç»ˆè½¨è¿¹å‚æ•°ï¼ˆä½¿ç”¨æ–°çš„æ–¹å‘è®¡ç®—ï¼‰
            const angleRad = (finalDirection * Math.PI) / 180;
            const startX = impactPixel.x - Math.cos(angleRad) * trajectoryLength;
            const startY = impactPixel.y - Math.sin(angleRad) * trajectoryLength;
            
            console.log('ğŸ¯ æœ€ç»ˆè½¨è¿¹å‚æ•°:');
            console.log('  èµ·å§‹ä½ç½®:', startX, startY);
            console.log('  æ’å‡»ä½ç½®:', impactPixel.x, impactPixel.y);
            console.log('  è½¨è¿¹é•¿åº¦:', trajectoryLength);
            console.log('  æ€»è§’åº¦:', impactAngle + trajectoryDirection + trajectoryCurvature, 'Â°');
            
            // ä¸å†åˆ›å»ºè½¨è¿¹çº¿ï¼Œåªä¿ç•™å°è¡Œæ˜Ÿå’Œå°¾è¿¹æ•ˆæœ

            // åˆ›å»ºå°è¡Œæ˜Ÿï¼ˆåŸºäºçœŸå®æ•°æ®ï¼‰
            const asteroidElement = document.createElement('div');
            asteroidElement.style.position = 'absolute';
            asteroidElement.style.left = startX + 'px';
            asteroidElement.style.top = startY + 'px';
            
            // æ ¹æ®å°è¡Œæ˜Ÿå¤§å°è°ƒæ•´æ˜¾ç¤ºå°ºå¯¸
            const diameter = asteroid.diameter_min || 100;
            const displaySize = Math.max(8, Math.min(20, diameter / 50));
            asteroidElement.style.width = displaySize + 'px';
            asteroidElement.style.height = displaySize + 'px';
            
            // æ ¹æ®å°è¡Œæ˜Ÿç±»å‹é€‰æ‹©é¢œè‰²
            let asteroidColor = '#ff6b6b';
            if (asteroid.orbital_data && asteroid.orbital_data.orbit_class) {
                // ç¡®ä¿orbit_classæ˜¯å­—ç¬¦ä¸²ç±»å‹
                const orbitClass = String(asteroid.orbital_data.orbit_class).toLowerCase();
                if (orbitClass.includes('apollo')) asteroidColor = '#ff4444';
                else if (orbitClass.includes('aten')) asteroidColor = '#ff8800';
                else if (orbitClass.includes('amor')) asteroidColor = '#ffaa00';
                else if (orbitClass.includes('main_belt')) asteroidColor = '#ffcc00';
            }
            
            asteroidElement.style.background = `radial-gradient(circle, ${asteroidColor}, #cc0000)`;
            asteroidElement.style.borderRadius = '50%';
            asteroidElement.style.boxShadow = `0 0 ${displaySize * 2}px ${asteroidColor}, 0 0 ${displaySize * 4}px rgba(255, 107, 107, 0.5)`;
            asteroidElement.style.animation = `asteroidFall ${animationDuration}ms ease-in forwards`;
            asteroidElement.title = `${asteroid.name} (${diameter}m)`;
            container.appendChild(asteroidElement);
            
            console.log('ğŸª¨ å°è¡Œæ˜Ÿåˆ›å»ºå®Œæˆ:', {
                name: asteroid.name,
                size: displaySize + 'px',
                color: asteroidColor,
                duration: animationDuration + 'ms'
            });

            // åˆ›å»ºå°¾è¿¹æ•ˆæœï¼ˆåŸºäºçœŸå®æ•°æ®ï¼‰
            const trail = document.createElement('div');
            trail.style.position = 'absolute';
            trail.style.left = startX + 'px';
            trail.style.top = startY + 'px';
            trail.style.width = '2px';
            trail.style.height = '0px';
            
            // æ ¹æ®é€Ÿåº¦è°ƒæ•´å°¾è¿¹é¢œè‰²å’Œå¼ºåº¦
            let trailColor = '#ffaa00';
            let trailIntensity = '0.8';
            if (closeApproachData.length > 0) {
                const approach = closeApproachData[0];
                const relativeVelocity = approach.relative_velocity || {};
                if (relativeVelocity.kilometers_per_second && !isNaN(parseFloat(relativeVelocity.kilometers_per_second))) {
                    const velocity = parseFloat(relativeVelocity.kilometers_per_second);
                    if (velocity > 30) {
                        trailColor = '#ff4444'; // é«˜é€Ÿ - çº¢è‰²
                        trailIntensity = '1.0';
                    } else if (velocity > 20) {
                        trailColor = '#ff8800'; // ä¸­é€Ÿ - æ©™è‰²
                        trailIntensity = '0.9';
                    } else {
                        trailColor = '#ffaa00'; // ä½é€Ÿ - é»„è‰²
                        trailIntensity = '0.7';
                    }
                }
            }
            
            trail.style.background = `linear-gradient(to bottom, transparent, ${trailColor}, #ff6b6b)`;
            trail.style.transform = `rotate(${finalDirection}deg)`;
            trail.style.animation = `trailGrow ${animationDuration}ms ease-in forwards`;
            trail.style.opacity = trailIntensity;
            container.appendChild(trail);
            
            console.log('ğŸŒ  å°¾è¿¹åˆ›å»ºå®Œæˆ:', {
                color: trailColor,
                intensity: trailIntensity,
                duration: animationDuration + 'ms'
            });
            
            // æ·»åŠ è½¨è¿¹æ–¹å‘æŒ‡ç¤ºå™¨
            const directionIndicator = document.createElement('div');
            directionIndicator.style.position = 'absolute';
            directionIndicator.style.left = (startX - 20) + 'px';
            directionIndicator.style.top = (startY - 20) + 'px';
            directionIndicator.style.width = '40px';
            directionIndicator.style.height = '40px';
            directionIndicator.style.background = `conic-gradient(from ${finalDirection}deg, transparent 0deg, ${asteroidColor} 60deg, transparent 120deg)`;
            directionIndicator.style.borderRadius = '50%';
            directionIndicator.style.opacity = '0.6';
            directionIndicator.style.animation = 'pulse 2s infinite';
            directionIndicator.title = `è½¨è¿¹æ–¹å‘: ${finalDirection ? finalDirection.toFixed(1) : 'N/A'}Â°`;
            container.appendChild(directionIndicator);
            
            // æ·»åŠ æ–¹å‘ç®­å¤´
            const arrow = document.createElement('div');
            arrow.style.position = 'absolute';
            arrow.style.left = (startX - 5) + 'px';
            arrow.style.top = (startY - 5) + 'px';
            arrow.style.width = '10px';
            arrow.style.height = '10px';
            arrow.style.background = asteroidColor;
            arrow.style.clipPath = 'polygon(0% 0%, 100% 50%, 0% 100%)';
            arrow.style.transform = `rotate(${finalDirection + 90}deg)`;
            arrow.style.animation = 'pulse 2s infinite';
            container.appendChild(arrow);
            
            console.log('ğŸ§­ æ–¹å‘æŒ‡ç¤ºå™¨åˆ›å»ºå®Œæˆ:', {
                direction: finalDirection ? finalDirection.toFixed(1) + 'Â°' : 'N/A',
                color: asteroidColor
            });

            // æ·»åŠ ç«‹ä½“åœ°å›¾æ•ˆæœï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (show3DEffect) {
                add3DMapEffect(container);
            }

            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes trajectoryFall {
                    0% {
                        transform: translate(-50%, -50%) rotate(0deg) scale(1);
                        opacity: 1;
                    }
                    50% {
                        transform: translate(-50%, -50%) rotate(15deg) scale(1.2);
                        opacity: 0.8;
                    }
                    100% {
                        transform: translate(${impactPixel.x - window.innerWidth/2}px, ${impactPixel.y - window.innerHeight/10}px) rotate(45deg) scale(1.5);
                        opacity: 0;
                    }
                }
                
                @keyframes asteroidFall {
                    0% {
                        transform: translate(-50%, -50%) scale(0.5);
                        opacity: 1;
                    }
                    50% {
                        transform: translate(-50%, -50%) scale(1);
                        opacity: 0.9;
                    }
                    100% {
                        transform: translate(${impactPixel.x - startX}px, ${impactPixel.y - startY}px) scale(1.2);
                        opacity: 0;
                    }
                }
                
                @keyframes trailGrow {
                    0% {
                        height: 0px;
                        opacity: 0;
                    }
                    50% {
                        height: ${trajectoryLength * 0.3}px;
                        opacity: ${trailIntensity};
                    }
                    100% {
                        height: ${trajectoryLength}px;
                        opacity: ${parseFloat(trailIntensity) * 0.8};
                    }
                }
                
                @keyframes mapShake {
                    0%, 100% { transform: translate(0, 0) rotate(0deg); }
                    10% { transform: translate(-2px, -1px) rotate(-0.5deg); }
                    20% { transform: translate(2px, 1px) rotate(0.5deg); }
                    30% { transform: translate(-1px, 2px) rotate(-0.3deg); }
                    40% { transform: translate(1px, -2px) rotate(0.3deg); }
                    50% { transform: translate(-2px, 1px) rotate(-0.2deg); }
                    60% { transform: translate(2px, -1px) rotate(0.2deg); }
                    70% { transform: translate(-1px, -2px) rotate(-0.1deg); }
                    80% { transform: translate(1px, 2px) rotate(0.1deg); }
                    90% { transform: translate(-2px, -1px) rotate(-0.05deg); }
                }
                
                @keyframes pulse {
                    0%, 100% { 
                        opacity: 0.6; 
                        transform: scale(1); 
                    }
                    50% { 
                        opacity: 1; 
                        transform: scale(1.2); 
                    }
                }
            `;
            document.head.appendChild(style);

            // æ’å‡»ç¬é—´æ•ˆæœ
            setTimeout(() => {
                // åœ°å›¾éœ‡åŠ¨æ•ˆæœ
                const mapElement = document.getElementById('map');
                mapElement.style.animation = 'mapShake 0.5s ease-out';

                // æ’å‡»é—ªå…‰
                const flash = document.createElement('div');
                flash.style.position = 'absolute';
                flash.style.left = impactPixel.x + 'px';
                flash.style.top = impactPixel.y + 'px';
                flash.style.width = '20px';
                flash.style.height = '20px';
                flash.style.background = 'radial-gradient(circle, #ffff00, #ff4444)';
                flash.style.borderRadius = '50%';
                flash.style.transform = 'translate(-50%, -50%)';
                flash.style.animation = 'impactFlash 0.5s ease-out';
                container.appendChild(flash);

                // å†²å‡»æ³¢
                const shockwave = document.createElement('div');
                shockwave.style.position = 'absolute';
                shockwave.style.left = impactPixel.x + 'px';
                shockwave.style.top = impactPixel.y + 'px';
                shockwave.style.width = '0px';
                shockwave.style.height = '0px';
                shockwave.style.border = '3px solid #ffaa00';
                shockwave.style.borderRadius = '50%';
                shockwave.style.transform = 'translate(-50%, -50%)';
                shockwave.style.animation = 'shockwaveExpand 1s ease-out';
                container.appendChild(shockwave);

                // æ·»åŠ å†²å‡»æ³¢åŠ¨ç”»
                const shockwaveStyle = document.createElement('style');
                shockwaveStyle.textContent = `
                    @keyframes impactFlash {
                        0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
                        100% { transform: translate(-50%, -50%) scale(10); opacity: 0; }
                    }
                    
                    @keyframes shockwaveExpand {
                        0% { 
                            width: 0px; 
                            height: 0px; 
                            opacity: 1; 
                        }
                        100% { 
                            width: 200px; 
                            height: 200px; 
                            opacity: 0; 
                        }
                    }
                `;
                document.head.appendChild(shockwaveStyle);

                // æ¸…ç†åŠ¨ç”»æ ·å¼
                setTimeout(() => {
                    document.head.removeChild(style);
                    document.head.removeChild(shockwaveStyle);
                    mapElement.style.animation = '';
                }, 3000);

            }, 2500);
        }

        function add3DMapEffect(container) {
            // æ·»åŠ ç«‹ä½“åœ°å›¾æ•ˆæœ
            const mapElement = document.getElementById('map');
            
            // æ·»åŠ 3Då˜æ¢
            mapElement.style.transform = 'perspective(1000px) rotateX(5deg)';
            mapElement.style.transition = 'transform 0.3s ease';
            
            // æ·»åŠ é˜´å½±æ•ˆæœ
            const shadow = document.createElement('div');
            shadow.style.position = 'absolute';
            shadow.style.bottom = '-20px';
            shadow.style.left = '20px';
            shadow.style.right = '20px';
            shadow.style.height = '20px';
            shadow.style.background = 'radial-gradient(ellipse, rgba(0,0,0,0.3), transparent)';
            shadow.style.borderRadius = '50%';
            shadow.style.transform = 'scale(1.2)';
            container.appendChild(shadow);

            // æ·»åŠ æ·±åº¦æŒ‡ç¤ºå™¨
            const depthIndicator = document.createElement('div');
            depthIndicator.style.position = 'absolute';
            depthIndicator.style.top = '20px';
            depthIndicator.style.right = '20px';
            depthIndicator.style.background = 'rgba(0, 0, 0, 0.8)';
            depthIndicator.style.color = 'white';
            depthIndicator.style.padding = '10px';
            depthIndicator.style.borderRadius = '5px';
            depthIndicator.style.fontSize = '12px';
            depthIndicator.innerHTML = `
                <div>ğŸŒ ç«‹ä½“åœ°å›¾è§†å›¾</div>
                <div>ğŸ“ 3Dè½¨è¿¹æ˜¾ç¤º</div>
            `;
            container.appendChild(depthIndicator);

            // 3ç§’åæ¢å¤åœ°å›¾
            setTimeout(() => {
                mapElement.style.transform = 'perspective(1000px) rotateX(0deg)';
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
