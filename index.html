<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¡Œæ˜Ÿæ’å‡»åœ°çƒæ¨¡æ‹Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        // ç¡®ä¿Three.jså’ŒOrbitControlsåŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            console.log('Three.js loaded:', typeof THREE !== 'undefined');
            console.log('OrbitControls loaded:', typeof THREE.OrbitControls !== 'undefined');
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            overflow: hidden;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            border: 2px solid #333;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff88;
            text-align: center;
        }

        .instruction {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }

        .step {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #00ff88;
        }

        .step-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .step-content {
            font-size: 14px;
            color: white;
        }

        select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            margin-top: 5px;
        }

        select:focus {
            outline: none;
            border-color: #00ff88;
        }

        select option {
            background: #1a1a1a;
            color: white;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-height: 50vh;
            min-height: 200px;
            overflow-y: auto;
            resize: vertical;
        }

        .results-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ff4444;
            text-align: center;
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 0;
            margin: -20px -20px 15px -20px;
            border-radius: 15px 15px 0 0;
            z-index: 10;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to right, #4A90E2, #00aaff);
            cursor: ns-resize;
            border-radius: 0 0 15px 15px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .resize-handle:hover {
            opacity: 1;
        }

        .trajectory-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #fff;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4A90E2;
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: #4A90E2;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .impact-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
        }

        .cities-section {
            margin-top: 15px;
        }

        .cities-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        .cities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .city-item {
            background: rgba(255, 107, 107, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #ff6b6b;
            font-size: 12px;
        }

        .city-name {
            font-weight: bold;
            color: #ff6b6b;
        }

        .city-info {
            color: #ccc;
            font-size: 11px;
        }

        .error {
            background: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 3px solid #ff4444;
            font-size: 12px;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-ready { color: #00ff88; }
        .status-selected { color: #ffaa00; }
        .status-simulating { color: #00aaff; }
        .status-error { color: #ff4444; }

        /* åŠ¨æ€æ¼”ç¤ºæ ·å¼ */
        .demo-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .asteroid-trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff6b6b;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff6b6b;
            animation: asteroidMove 3s ease-in-out forwards;
        }

        .impact-flash {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ffff00, #ff4444);
            border-radius: 50%;
            animation: impactFlash 0.5s ease-out;
        }

        .orbit-path {
            position: absolute;
            border: 2px dashed #00aaff;
            border-radius: 50%;
            opacity: 0.7;
            animation: orbitPulse 2s ease-in-out infinite;
        }

        @keyframes asteroidMove {
            0% {
                transform: translate(0, 0) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(var(--target-x), var(--target-y)) scale(1);
                opacity: 0;
            }
        }

        @keyframes impactFlash {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(10);
                opacity: 0;
            }
        }

        @keyframes orbitPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff88;
            font-size: 18px;
            z-index: 1001;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .map-controls button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .map-controls button:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .map-controls button.active {
            background: #00ff88;
            color: #000;
        }

        .layer-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
        }

        .layer-controls h4 {
            color: #00ff88;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .layer-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .layer-item label {
            color: white;
            cursor: pointer;
            flex: 1;
        }

        .layer-opacity {
            width: 60px;
            margin-left: 10px;
        }

        .real-time-indicator {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 1000;
            border: 1px solid #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
        <div class="container">
        <div id="map"></div>
        <div class="map-loading" id="map-loading">ğŸŒ æ­£åœ¨åŠ è½½åœ°å›¾...</div>
        
        <div class="control-panel">
            <div class="title">ğŸŒ å°è¡Œæ˜Ÿæ’å‡»åœ°çƒæ¨¡æ‹Ÿ</div>
            <div class="instruction">
                ç‚¹å‡»åœ°å›¾é€‰æ‹©æ’å‡»åœ°ç‚¹ â†’ é€‰æ‹©å°è¡Œæ˜Ÿ â†’ è¿è¡Œæ¨¡æ‹Ÿ
                    </div>

            <div class="step">
                <div class="step-label">æ­¥éª¤ 1: é€‰æ‹©æ’å‡»åœ°ç‚¹</div>
                <div class="step-content" id="location-status">ç‚¹å‡»åœ°å›¾ä¸Šçš„ä»»æ„ä½ç½®</div>
                    </div>

            <div class="step">
                <div class="step-label">æ­¥éª¤ 2: é€‰æ‹©å°è¡Œæ˜Ÿ</div>
                <select id="asteroid-select">
                    <option value="">è¯·å…ˆé€‰æ‹©æ’å‡»åœ°ç‚¹</option>
                </select>
                    </div>

        <div class="step">
            <div class="step-label">æ­¥éª¤ 3: è½¨è¿¹è®¾ç½®</div>
            <div class="trajectory-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="show-trajectory" checked>
                    <span class="checkmark"></span>
                    æ˜¾ç¤ºé™è½è½¨è¿¹
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="show-3d-effect" checked>
                    <span class="checkmark"></span>
                    ç«‹ä½“åœ°å›¾æ•ˆæœ
                </label>
            </div>
        </div>

            <button class="btn" id="simulate-btn" onclick="runSimulation()" disabled>
                ğŸš€ è¿è¡Œæ’å‡»æ¨¡æ‹Ÿ
            </button>
            
            <div class="error" id="error" style="display: none;"></div>
                    </div>

        <div class="status-indicator" id="status">
            <span class="status-ready">â— å‡†å¤‡å°±ç»ª</span>
        </div>

        <div class="real-time-indicator">
            ğŸ›°ï¸ NASAå°è¡Œæ˜Ÿæ•°æ®
        </div>

        <div class="layer-controls">
            <h4>ğŸ—ºï¸ åœ°å›¾å›¾å±‚</h4>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="osm-layer" checked>
                <label for="osm-layer">OpenStreetMap</label>
            </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="terrain-layer">
                <label for="terrain-layer">åœ°å½¢å›¾</label>
            </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="dark-layer">
                <label for="dark-layer">æ·±è‰²ä¸»é¢˜</label>
            </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="esri-layer">
                <label for="esri-layer">Esriåœ°å›¾</label>
            </div>
            <div class="layer-item">
                <input type="radio" name="map-layer" id="imagery-layer">
                <label for="imagery-layer">å«æ˜Ÿå½±åƒ</label>
            </div>
        </div>

        <div class="results" id="results">
            <div class="results-header">ğŸ’¥ æ’å‡»å½±å“åˆ†æ</div>
            
            <div class="impact-stats" id="impact-stats">
                <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>

            <div class="cities-section">
                <div class="cities-title">ğŸ™ï¸ å—å½±å“åŸå¸‚</div>
                <div class="cities-grid" id="affected-cities">
                    <!-- åŸå¸‚åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let impactMarker;
        let impactCircle;
        let cityMarkers = [];
        let selectedLocation = null;
        let currentImpactData = null;
        let activeLayers = {};

        // ä¸»è¦åŸå¸‚æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const majorCities = [
            { name: "åŒ—äº¬", lat: 39.9042, lng: 116.4074, population: 21540000, country: "ä¸­å›½" },
            { name: "ä¸Šæµ·", lat: 31.2304, lng: 121.4737, population: 24280000, country: "ä¸­å›½" },
            { name: "å¹¿å·", lat: 23.1291, lng: 113.2644, population: 15300000, country: "ä¸­å›½" },
            { name: "æ·±åœ³", lat: 22.5431, lng: 114.0579, population: 17560000, country: "ä¸­å›½" },
            { name: "æˆéƒ½", lat: 30.5728, lng: 104.0668, population: 16580000, country: "ä¸­å›½" },
            { name: "é‡åº†", lat: 29.4316, lng: 106.9123, population: 32050000, country: "ä¸­å›½" },
            { name: "å¤©æ´¥", lat: 39.3434, lng: 117.3616, population: 13870000, country: "ä¸­å›½" },
            { name: "æ­¦æ±‰", lat: 30.5928, lng: 114.3055, population: 12320000, country: "ä¸­å›½" },
            { name: "è¥¿å®‰", lat: 34.3416, lng: 108.9398, population: 12950000, country: "ä¸­å›½" },
            { name: "æ­å·", lat: 30.2741, lng: 120.1551, population: 11930000, country: "ä¸­å›½" },
            { name: "å—äº¬", lat: 32.0603, lng: 118.7969, population: 9315000, country: "ä¸­å›½" },
            { name: "é’å²›", lat: 36.0986, lng: 120.3719, population: 10070000, country: "ä¸­å›½" },
            { name: "å¤§è¿", lat: 38.9140, lng: 121.6147, population: 7450000, country: "ä¸­å›½" },
            { name: "å¦é—¨", lat: 24.4798, lng: 118.0819, population: 4110000, country: "ä¸­å›½" },
            { name: "è‹å·", lat: 31.2989, lng: 120.5853, population: 12750000, country: "ä¸­å›½" },
            { name: "å®æ³¢", lat: 29.8683, lng: 121.5440, population: 8542000, country: "ä¸­å›½" },
            { name: "é•¿æ²™", lat: 28.2278, lng: 112.9388, population: 10050000, country: "ä¸­å›½" },
            { name: "éƒ‘å·", lat: 34.7466, lng: 113.6254, population: 12600000, country: "ä¸­å›½" },
            { name: "æµå—", lat: 36.6512, lng: 117.1201, population: 9200000, country: "ä¸­å›½" },
            { name: "ç¦å·", lat: 26.0745, lng: 119.2965, population: 8290000, country: "ä¸­å›½" },
            { name: "çŸ³å®¶åº„", lat: 38.0428, lng: 114.5149, population: 11200000, country: "ä¸­å›½" },
            { name: "åˆè‚¥", lat: 31.8206, lng: 117.2272, population: 9465000, country: "ä¸­å›½" },
            { name: "å—æ˜Œ", lat: 28.6820, lng: 115.8579, population: 6255000, country: "ä¸­å›½" },
            { name: "æ˜†æ˜", lat: 25.0389, lng: 102.7183, population: 8460000, country: "ä¸­å›½" },
            { name: "è´µé˜³", lat: 26.6470, lng: 106.6302, population: 6100000, country: "ä¸­å›½" },
            { name: "å…°å·", lat: 36.0611, lng: 103.8343, population: 4350000, country: "ä¸­å›½" },
            { name: "é“¶å·", lat: 38.4872, lng: 106.2309, population: 2850000, country: "ä¸­å›½" },
            { name: "è¥¿å®", lat: 36.6232, lng: 101.7782, population: 2460000, country: "ä¸­å›½" },
            { name: "ä¹Œé²æœ¨é½", lat: 43.8256, lng: 87.6168, population: 4050000, country: "ä¸­å›½" },
            { name: "æ‹‰è¨", lat: 29.6465, lng: 91.1172, population: 867000, country: "ä¸­å›½" },
            { name: "å°åŒ—", lat: 25.0330, lng: 121.5654, population: 2600000, country: "ä¸­å›½å°æ¹¾" },
            { name: "é«˜é›„", lat: 22.6273, lng: 120.3014, population: 2700000, country: "ä¸­å›½å°æ¹¾" },
            { name: "é¦™æ¸¯", lat: 22.3193, lng: 114.1694, population: 7500000, country: "ä¸­å›½é¦™æ¸¯" },
            { name: "æ¾³é—¨", lat: 22.1987, lng: 113.5439, population: 680000, country: "ä¸­å›½æ¾³é—¨" },
            // å›½é™…ä¸»è¦åŸå¸‚
            { name: "ä¸œäº¬", lat: 35.6762, lng: 139.6503, population: 37400000, country: "æ—¥æœ¬" },
            { name: "é¦–å°”", lat: 37.5665, lng: 126.9780, population: 9720000, country: "éŸ©å›½" },
            { name: "æ–°åŠ å¡", lat: 1.3521, lng: 103.8198, population: 5450000, country: "æ–°åŠ å¡" },
            { name: "æ›¼è°·", lat: 13.7563, lng: 100.5018, population: 10540000, country: "æ³°å›½" },
            { name: "é›…åŠ è¾¾", lat: -6.2088, lng: 106.8456, population: 10560000, country: "å°åº¦å°¼è¥¿äºš" },
            { name: "é©¬å°¼æ‹‰", lat: 14.5995, lng: 120.9842, population: 13480000, country: "è²å¾‹å®¾" },
            { name: "èƒ¡å¿—æ˜å¸‚", lat: 10.8231, lng: 106.6297, population: 8993000, country: "è¶Šå—" },
            { name: "å‰éš†å¡", lat: 3.1390, lng: 101.6869, population: 1588000, country: "é©¬æ¥è¥¿äºš" },
            { name: "æ–°å¾·é‡Œ", lat: 28.6139, lng: 77.2090, population: 32900000, country: "å°åº¦" },
            { name: "å­Ÿä¹°", lat: 19.0760, lng: 72.8777, population: 20000000, country: "å°åº¦" },
            { name: "åŠ å°”å„ç­”", lat: 22.5726, lng: 88.3639, population: 14900000, country: "å°åº¦" },
            { name: "ç­åŠ ç½—å°”", lat: 12.9716, lng: 77.5946, population: 12400000, country: "å°åº¦" },
            { name: "æ‚‰å°¼", lat: -33.8688, lng: 151.2093, population: 5312000, country: "æ¾³å¤§åˆ©äºš" },
            { name: "å¢¨å°”æœ¬", lat: -37.8136, lng: 144.9631, population: 5078000, country: "æ¾³å¤§åˆ©äºš" },
            { name: "çº½çº¦", lat: 40.7128, lng: -74.0060, population: 8336000, country: "ç¾å›½" },
            { name: "æ´›æ‰çŸ¶", lat: 34.0522, lng: -118.2437, population: 3972000, country: "ç¾å›½" },
            { name: "èŠåŠ å“¥", lat: 41.8781, lng: -87.6298, population: 2694000, country: "ç¾å›½" },
            { name: "ä¼‘æ–¯é¡¿", lat: 29.7604, lng: -95.3698, population: 2320000, country: "ç¾å›½" },
            { name: "ä¼¦æ•¦", lat: 51.5074, lng: -0.1278, population: 8982000, country: "è‹±å›½" },
            { name: "å·´é»", lat: 48.8566, lng: 2.3522, population: 2161000, country: "æ³•å›½" },
            { name: "æŸæ—", lat: 52.5200, lng: 13.4050, population: 3669000, country: "å¾·å›½" },
            { name: "ç½—é©¬", lat: 41.9028, lng: 12.4964, population: 2873000, country: "æ„å¤§åˆ©" },
            { name: "è«æ–¯ç§‘", lat: 55.7558, lng: 37.6176, population: 12500000, country: "ä¿„ç½—æ–¯" },
            { name: "åœ£å½¼å¾—å ¡", lat: 59.9311, lng: 30.3609, population: 5384000, country: "ä¿„ç½—æ–¯" },
            { name: "å¼€ç½—", lat: 30.0444, lng: 31.2357, population: 20480000, country: "åŸƒåŠ" },
            { name: "æ‹‰å„æ–¯", lat: 6.5244, lng: 3.3792, population: 15388000, country: "å°¼æ—¥åˆ©äºš" },
            { name: "çº¦ç¿°å†…æ–¯å ¡", lat: -26.2041, lng: 28.0473, population: 5635000, country: "å—é" },
            { name: "å¼€æ™®æ•¦", lat: -33.9249, lng: 18.4241, population: 4618000, country: "å—é" },
            { name: "åœ£ä¿ç½—", lat: -23.5505, lng: -46.6333, population: 12300000, country: "å·´è¥¿" },
            { name: "é‡Œçº¦çƒ­å†…å¢", lat: -22.9068, lng: -43.1729, population: 6748000, country: "å·´è¥¿" },
            { name: "å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯", lat: -34.6118, lng: -58.3960, population: 15590000, country: "é˜¿æ ¹å»·" },
            { name: "å¢¨è¥¿å“¥åŸ", lat: 19.4326, lng: -99.1332, population: 21800000, country: "å¢¨è¥¿å“¥" },
            { name: "å¤šä¼¦å¤š", lat: 43.6532, lng: -79.3832, population: 2930000, country: "åŠ æ‹¿å¤§" },
            { name: "æ¸©å“¥å", lat: 49.2827, lng: -123.1207, population: 675000, country: "åŠ æ‹¿å¤§" }
        ];

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            try {
                map = L.map('map', {
                    zoomControl: true,
                    attributionControl: false
                }).setView([20, 0], 2);  // ä½¿ç”¨æ ‡å‡†åæ ‡ç³»
                
                // ä½¿ç”¨å¯é çš„åœ°å›¾æœåŠ¡
                const mapLayers = [
                    // OpenStreetMap (æœ€å¯é )
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors',
                        maxZoom: 19
                    }),
                    // å¤‡ç”¨1: OpenTopoMap åœ°å½¢å›¾
                    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors, SRTM | Â© OpenTopoMap (CC-BY-SA)',
                        subdomains: 'abc',
                        maxZoom: 17
                    }),
                    // å¤‡ç”¨2: CartoDB æ·±è‰²ä¸»é¢˜
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: 'Â© OpenStreetMap contributors Â© CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }),
                    // å¤‡ç”¨3: Esri ä¸–ç•Œåœ°å›¾
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Â© Esri',
                        maxZoom: 19
                    }),
                    // å¤‡ç”¨4: Esri ä¸–ç•Œå½±åƒ
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Â© Esri',
                        maxZoom: 19
                    })
                ];

                // åˆå§‹åŒ–å›¾å±‚
                activeLayers = {
                    osm: mapLayers[0],
                    terrain: mapLayers[1],
                    dark: mapLayers[2],
                    esri: mapLayers[3],
                    imagery: mapLayers[4]
                };

                // é»˜è®¤æ˜¾ç¤ºOpenStreetMap
                activeLayers.osm.addTo(map);

                // è®¾ç½®å›¾å±‚æ§åˆ¶äº‹ä»¶
                setupLayerControls();

                // åœ°å›¾åŠ è½½æˆåŠŸåéšè—åŠ è½½æç¤º
                map.on('load', function() {
                    document.getElementById('map-loading').style.display = 'none';
                });

                // å¦‚æœåœ°å›¾åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡
                activeLayers.osm.on('tileerror', function() {
                    console.log('OpenStreetMapåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡...');
                    map.removeLayer(activeLayers.osm);
                    activeLayers.dark.addTo(map);
                });

                // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ5ç§’åè¿˜åœ¨åŠ è½½ï¼Œå¼ºåˆ¶éšè—åŠ è½½æç¤º
                setTimeout(function() {
                    document.getElementById('map-loading').style.display = 'none';
                }, 5000);

                // æ·»åŠ åŸå¸‚æ ‡è®°
                addCityMarkers();

                // åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.on('click', function(e) {
                    selectImpactLocation(e.latlng);
                });

                // åŠ è½½å°è¡Œæ˜Ÿæ•°æ®
                loadAsteroids();

            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // æ·»åŠ åŸå¸‚æ ‡è®°
        function addCityMarkers() {
            majorCities.forEach(city => {
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: 3,
                    fillColor: '#ff6b6b',
                    color: 'white',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                }).addTo(map);

                marker.bindPopup(`
                    <div style="text-align: center; color: #333;">
                        <h4 style="margin: 0 0 5px 0;">${city.name}</h4>
                        <p style="margin: 0; font-size: 12px;">${city.country}</p>
                        <p style="margin: 0; font-size: 11px; color: #666;">äººå£: ${city.population.toLocaleString()}</p>
                    </div>
                `);

                cityMarkers.push(marker);
            });
        }

        // é€‰æ‹©æ’å‡»åœ°ç‚¹
        function selectImpactLocation(latlng) {
            selectedLocation = latlng;
            
            // ç§»é™¤ä¹‹å‰çš„æ’å‡»æ ‡è®°
            if (impactMarker) {
                map.removeLayer(impactMarker);
            }
            if (impactCircle) {
                map.removeLayer(impactCircle);
            }

            // æ·»åŠ æ–°çš„æ’å‡»æ ‡è®°
            impactMarker = L.circleMarker(latlng, {
                radius: 8,
                fillColor: '#ff4444',
                color: 'white',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            impactMarker.bindPopup(`
                <div style="text-align: center; color: #333;">
                    <h4 style="margin: 0 0 5px 0;">ğŸ¯ æ’å‡»åœ°ç‚¹</h4>
                    <p style="margin: 0; font-size: 12px;">çº¬åº¦: ${latlng.lat.toFixed(4)}Â°</p>
                    <p style="margin: 0; font-size: 12px;">ç»åº¦: ${latlng.lng.toFixed(4)}Â°</p>
                </div>
            `);

            // æ›´æ–°çŠ¶æ€
            updateStatus('selected', 'å·²é€‰æ‹©æ’å‡»åœ°ç‚¹');
            document.getElementById('location-status').textContent = 
                `å·²é€‰æ‹©: ${latlng.lat.toFixed(2)}Â°, ${latlng.lng.toFixed(2)}Â°`;
            
            // å¯ç”¨å°è¡Œæ˜Ÿé€‰æ‹©
            document.getElementById('asteroid-select').disabled = false;
            document.getElementById('asteroid-select').innerHTML = '<option value="">åŠ è½½å°è¡Œæ˜Ÿæ•°æ®...</option>';
            
            // é‡æ–°åŠ è½½å°è¡Œæ˜Ÿæ•°æ®
            loadAsteroids();
        }

        // åŠ è½½å°è¡Œæ˜Ÿæ•°æ®
        async function loadAsteroids() {
            try {
                const response = await fetch('http://localhost:8000/asteroids');
                const asteroids = await response.json();
                
                const select = document.getElementById('asteroid-select');
                select.innerHTML = '<option value="">é€‰æ‹©å°è¡Œæ˜Ÿ...</option>';
                
                asteroids.forEach(asteroid => {
                    const option = document.createElement('option');
                    option.value = asteroid.id;
                    option.textContent = `${asteroid.name} (ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)}km)`;
                    select.appendChild(option);
                });

                // å¯ç”¨æ¨¡æ‹ŸæŒ‰é’®
                document.getElementById('simulate-btn').disabled = false;
                
            } catch (error) {
                console.error('åŠ è½½å°è¡Œæ˜Ÿæ•°æ®å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½å°è¡Œæ˜Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
            }
        }

        // è¿è¡Œæ’å‡»æ¨¡æ‹Ÿ
        async function runSimulation() {
            const asteroidSelect = document.getElementById('asteroid-select');
            const asteroidId = asteroidSelect.value;
            
            if (!asteroidId) {
                showError('è¯·é€‰æ‹©ä¸€ä¸ªå°è¡Œæ˜Ÿ');
                return;
            }

            if (!selectedLocation) {
                showError('è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©æ’å‡»åœ°ç‚¹');
                return;
            }

            await runStaticSimulation(asteroidId);
        }

        async function runStaticSimulation(asteroidId) {
            hideError();

            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºè½¨è¿¹
                const showTrajectory = document.getElementById('show-trajectory').checked;
                const show3DEffect = document.getElementById('show-3d-effect').checked;
                
                if (showTrajectory) {
                    updateStatus('simulating', 'æ­£åœ¨æ˜¾ç¤ºé™è½è½¨è¿¹...');
                    // æ˜¾ç¤ºé™è½è½¨è¿¹åŠ¨ç”»
                    await showImpactTrajectory(asteroidId, show3DEffect);
                }
                
                // æ›´æ–°çŠ¶æ€
                updateStatus('simulating', 'æ­£åœ¨è®¡ç®—æ’å‡»å½±å“...');

                // è·å–å°è¡Œæ˜Ÿæ•°æ®ä»¥è·å–çœŸå®é€Ÿåº¦
                const asteroidResponse = await fetch('http://localhost:8000/asteroids');
                const asteroids = await asteroidResponse.json();
                const asteroid = asteroids.find(a => a.id === asteroidId);
                
                // ä½¿ç”¨APIä¸­çš„çœŸå®é€Ÿåº¦ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
                let impactVelocity = 20000; // é»˜è®¤20km/s
                
                if (asteroid && asteroid.close_approach_data && asteroid.close_approach_data.length > 0) {
                    // ä»å¤šä¸ªæ¥è¿‘æ•°æ®ä¸­é€‰æ‹©ä¸€ä¸ªé€Ÿåº¦ï¼ˆé€‰æ‹©æœ€è¿‘çš„æˆ–éšæœºçš„ï¼‰
                    const approachData = asteroid.close_approach_data[0]; // ä½¿ç”¨æœ€è¿‘çš„æ¥è¿‘æ•°æ®
                    const velocityStr = approachData.relative_velocity.kilometers_per_second;
                    const velocity = parseFloat(velocityStr);
                    if (!isNaN(velocity) && velocity > 0) {
                        impactVelocity = velocity * 1000; // è½¬æ¢ä¸ºm/s
                    }
                } else if (asteroid && asteroid.velocity) {
                    // ä½¿ç”¨å­˜å‚¨çš„å¹³å‡é€Ÿåº¦
                    impactVelocity = asteroid.velocity;
                }
                
                console.log('æ’å‡»é€Ÿåº¦:', impactVelocity, 'm/s');
                console.log('å°è¡Œæ˜Ÿæ¥è¿‘æ•°æ®:', asteroid.close_approach_data?.length || 0, 'æ¡è®°å½•');
                
                const response = await fetch('http://localhost:8000/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        asteroid_id: asteroidId,
                        impact_angle: 45,
                        impact_velocity: impactVelocity,
                        target_density: 3000,
                        target_type: 'continental_crust',
                        impact_latitude: selectedLocation.lat,
                        impact_longitude: selectedLocation.lng
                    })
                });

                const result = await response.json();
                currentImpactData = result;
                
                // æ˜¾ç¤ºç»“æœï¼ˆä¸æ˜¾ç¤ºèŒƒå›´åœ†åœˆï¼‰
                displayResults(result, 0);
                
                // å»¶è¿Ÿæ˜¾ç¤ºæ’å‡»èŒƒå›´ï¼Œæ¨¡æ‹Ÿæ’å‡»åçš„æ•ˆæœ
                setTimeout(() => {
                    showImpactArea(result);
                }, 1000);
                
                updateStatus('ready', 'æ¨¡æ‹Ÿå®Œæˆ');
                
            } catch (error) {
                console.error('æ¨¡æ‹Ÿå¤±è´¥:', error);
                showError('æ¨¡æ‹Ÿå¤±è´¥: ' + error.message);
                updateStatus('error', 'æ¨¡æ‹Ÿå¤±è´¥');
            }
        }

        // æ˜¾ç¤ºæ’å‡»èŒƒå›´
        function showImpactArea(result) {
            const craterRadius = result.crater_diameter / 2;
            const impactRadius = craterRadius * 50; // å½±å“èŒƒå›´æ˜¯é™¨çŸ³å‘çš„50å€
            
            // æ¸…é™¤ä¹‹å‰çš„å½±å“èŒƒå›´åœ†åœˆ
            if (impactCircle) {
                map.removeLayer(impactCircle);
            }
            
            // æ·»åŠ æ’å‡»ç‚¹æ ‡è®°
            if (currentImpactMarker) {
                map.removeLayer(currentImpactMarker);
            }
            
            currentImpactMarker = L.circleMarker([selectedLocation.lat, selectedLocation.lng], {
                radius: 8,
                color: '#ff0000',
                fillColor: '#ff0000',
                fillOpacity: 0.8,
                weight: 2
            }).addTo(map);
            
            // æ·»åŠ å½±å“èŒƒå›´åœ†åœˆï¼ˆå¸¦åŠ¨ç”»æ•ˆæœï¼‰
            impactCircle = L.circle(selectedLocation, {
                radius: impactRadius * 1000, // è½¬æ¢ä¸ºç±³
                color: '#ff4444',
                weight: 2,
                opacity: 0.6,
                fillOpacity: 0.1,
                dashArray: '5, 5'
            }).addTo(map);
            
            // æ·»åŠ å†²å‡»æ³¢åŠ¨ç”»
            const shockwave = L.circle(selectedLocation, {
                radius: 0,
                color: '#ffaa00',
                weight: 3,
                opacity: 0.8,
                fillOpacity: 0
            }).addTo(map);
            
            // å†²å‡»æ³¢æ‰©æ•£åŠ¨ç”»
            let currentRadius = 0;
            const maxRadius = impactRadius * 1000;
            const animation = setInterval(() => {
                currentRadius += maxRadius / 20;
                shockwave.setRadius(currentRadius);
                shockwave.setStyle({
                    opacity: 0.8 * (1 - currentRadius / maxRadius)
                });
                
                if (currentRadius >= maxRadius) {
                    clearInterval(animation);
                    map.removeLayer(shockwave);
                }
            }, 50);
            
            // æ›´æ–°åŸå¸‚å½±å“çŠ¶æ€
            updateCityImpactStatus(selectedLocation, impactRadius);
        }

        // æ›´æ–°åŸå¸‚å½±å“çŠ¶æ€
        function updateCityImpactStatus(impactPoint, radius) {
            cityMarkers.forEach((marker, index) => {
                const city = majorCities[index];
                const distance = impactPoint.distanceTo([city.lat, city.lng]);
                
                if (distance <= radius) {
                    marker.setStyle({
                        fillColor: '#ff6b6b',
                        color: '#ff4444',
                        weight: 2,
                        radius: 5
                    });
                } else {
                    marker.setStyle({
                        fillColor: '#ff6b6b',
                        color: 'white',
                        weight: 1,
                        radius: 3
                    });
                }
            });
        }

        // æ ¼å¼åŒ–ç»æµæŸå¤±æ˜¾ç¤º
        function formatEconomicLoss(loss) {
            if (loss >= 1000000) {
                return (loss / 1000000).toFixed(1) + 'T'; // ä¸‡äº¿
            } else if (loss >= 1000) {
                return (loss / 1000).toFixed(1) + 'B'; // åäº¿
            } else if (loss >= 1) {
                return loss.toFixed(1) + 'M'; // ç™¾ä¸‡
            } else {
                return (loss * 1000).toFixed(1) + 'K'; // åƒ
            }
        }

        // æ ¼å¼åŒ–æ’å‡»é€Ÿåº¦æ˜¾ç¤º
        function formatImpactVelocity(velocity) {
            if (!velocity || isNaN(velocity) || velocity <= 0) {
                return 'N/A';
            }
            return (velocity / 1000).toFixed(1) + 'km/s';
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(result, impactRadius) {
            const resultsDiv = document.getElementById('results');
            const statsDiv = document.getElementById('impact-stats');
            const citiesDiv = document.getElementById('affected-cities');

            // æ·»åŠ è°ƒæ•´æ‰‹æŸ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!document.querySelector('.resize-handle')) {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                resultsDiv.appendChild(resizeHandle);
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${Math.round(result.crater_diameter/1000)}km</div>
                    <div class="stat-label">é™¨çŸ³å‘ç›´å¾„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatImpactVelocity(result.impact_velocity)}</div>
                    <div class="stat-label">æ’å‡»é€Ÿåº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.seismic_magnitude.toFixed(1)}</div>
                    <div class="stat-label">åœ°éœ‡éœ‡çº§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(result.tsunami_height)}m</div>
                    <div class="stat-label">æµ·å•¸é«˜åº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(result.impact_energy / 1e21).toFixed(1)}EJ</div>
                    <div class="stat-label">å†²å‡»èƒ½é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.population_loss.toLocaleString()}</div>
                    <div class="stat-label">äººå£æŸå¤±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${formatEconomicLoss(result.building_loss)}</div>
                    <div class="stat-label">å»ºç­‘æŸå¤±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${formatEconomicLoss(result.total_economic_loss)}</div>
                    <div class="stat-label">æ€»ç»æµæŸå¤±</div>
                </div>
            `;
            
            // è®¡ç®—å—å½±å“åŸå¸‚
            const affectedCities = [];
            const impactPoint = selectedLocation;
            
            console.log(`å½±å“åŠå¾„: ${impactRadius/1000}km`); // è°ƒè¯•ä¿¡æ¯
            
            majorCities.forEach(city => {
                const distance = impactPoint.distanceTo([city.lat, city.lng]);
                console.log(`${city.name}: è·ç¦» ${distance/1000}km`); // è°ƒè¯•ä¿¡æ¯
                
                if (distance <= impactRadius) {
                    affectedCities.push({
                        ...city,
                        distance: Math.round(distance / 1000)
                    });
                }
            });
            
            console.log(`å—å½±å“åŸå¸‚æ•°é‡: ${affectedCities.length}`); // è°ƒè¯•ä¿¡æ¯

            // æŒ‰è·ç¦»æ’åº
            affectedCities.sort((a, b) => a.distance - b.distance);

            // æ˜¾ç¤ºå—å½±å“åŸå¸‚
            if (affectedCities.length === 0) {
                // å¦‚æœæ²¡æœ‰åŸå¸‚åœ¨å½±å“èŒƒå›´å†…ï¼Œæ˜¾ç¤ºæœ€è¿‘çš„åŸå¸‚
                const nearestCities = majorCities.map(city => ({
                    ...city,
                    distance: Math.round(impactPoint.distanceTo([city.lat, city.lng]) / 1000)
                })).sort((a, b) => a.distance - b.distance).slice(0, 10);
                
                citiesDiv.innerHTML = `
                    <div style="color: #ffaa00; margin-bottom: 10px;">
                        âš ï¸ å½±å“èŒƒå›´å†…æš‚æ— åŸå¸‚ï¼Œæ˜¾ç¤ºæœ€è¿‘çš„åŸå¸‚ï¼š
                    </div>
                    ${nearestCities.map(city => `
                        <div class="city-item">
                            <div class="city-name">${city.name}</div>
                            <div class="city-info">${city.country} | ${city.distance}km | ${city.population.toLocaleString()}äºº</div>
                        </div>
                    `).join('')}
                `;
            } else {
                citiesDiv.innerHTML = affectedCities.map(city => `
                    <div class="city-item">
                        <div class="city-name">${city.name}</div>
                        <div class="city-info">${city.country} | ${city.distance}km | ${city.population.toLocaleString()}äºº</div>
                    </div>
                `).join('');
            }

            resultsDiv.style.display = 'block';
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            const statusMap = {
                'ready': { class: 'status-ready', text: 'â— å‡†å¤‡å°±ç»ª' },
                'selected': { class: 'status-selected', text: 'â— å·²é€‰æ‹©åœ°ç‚¹' },
                'simulating': { class: 'status-simulating', text: 'â— è®¡ç®—ä¸­...' },
                'error': { class: 'status-error', text: 'â— é”™è¯¯' }
            };
            
            const status = statusMap[type];
            statusEl.innerHTML = `<span class="${status.class}">${status.text}</span>`;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // è®¾ç½®å›¾å±‚æ§åˆ¶
        function setupLayerControls() {
            // OpenStreetMapæ§åˆ¶
            document.getElementById('osm-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ OSMå›¾å±‚
                    activeLayers.osm.addTo(map);
                }
            });

            // åœ°å½¢å›¾æ§åˆ¶
            document.getElementById('terrain-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ åœ°å½¢å›¾å±‚
                    activeLayers.terrain.addTo(map);
                }
            });

            // æ·±è‰²ä¸»é¢˜æ§åˆ¶
            document.getElementById('dark-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ æ·±è‰²å›¾å±‚
                    activeLayers.dark.addTo(map);
                }
            });

            // Esriåœ°å›¾æ§åˆ¶
            document.getElementById('esri-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ Esriå›¾å±‚
                    activeLayers.esri.addTo(map);
                }
            });

            // å«æ˜Ÿå½±åƒæ§åˆ¶
            document.getElementById('imagery-layer').addEventListener('change', function() {
                if (this.checked) {
                    // ç§»é™¤æ‰€æœ‰å›¾å±‚
                    Object.values(activeLayers).forEach(layer => map.removeLayer(layer));
                    // æ·»åŠ å«æ˜Ÿå½±åƒå›¾å±‚
                    activeLayers.imagery.addTo(map);
                }
            });
        }

        async function runDynamicDemo(asteroidId, mode) {
            updateStatus('simulating', 'æ­£åœ¨å‡†å¤‡åŠ¨æ€æ¼”ç¤º...');
            hideError();

            try {
                // è·å–å°è¡Œæ˜Ÿæ•°æ®
                const response = await fetch('http://localhost:8000/asteroids');
                const asteroids = await response.json();
                const asteroid = asteroids.find(a => a.id === asteroidId);
                
                if (!asteroid) {
                    showError('å°è¡Œæ˜Ÿæ•°æ®æœªæ‰¾åˆ°');
                    return;
                }

                // åˆ›å»ºæ¼”ç¤ºå®¹å™¨
                createDemoContainer();
                
                if (mode === 'orbit') {
                    await showOrbitDemo(asteroid);
                } else if (mode === '3d') {
                    await show3DOrbitDemo(asteroid);
                } else if (mode === 'simple-3d') {
                    await showSimple3DDemo(asteroid);
                } else {
                    await showImpactDemo(asteroid);
                }

                // è¿è¡Œé™æ€æ¨¡æ‹Ÿè·å–ç»“æœ
                await runStaticSimulation(asteroidId);

            } catch (error) {
                console.error('Demo error:', error);
                showError('æ¼”ç¤ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                updateStatus('error', 'æ¼”ç¤ºå¤±è´¥');
            }
        }

        function createDemoContainer() {
            // ç§»é™¤ç°æœ‰çš„æ¼”ç¤ºå®¹å™¨
            const existing = document.getElementById('demo-container');
            if (existing) {
                existing.remove();
            }

            // åˆ›å»ºæ–°çš„æ¼”ç¤ºå®¹å™¨
            const container = document.createElement('div');
            container.id = 'demo-container';
            container.className = 'demo-container';
            document.getElementById('map').appendChild(container);
        }

        async function showOrbitDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // æ˜¾ç¤ºè½¨é“è·¯å¾„
            const orbitPath = document.createElement('div');
            orbitPath.className = 'orbit-path';
            orbitPath.style.left = '50%';
            orbitPath.style.top = '50%';
            orbitPath.style.width = '200px';
            orbitPath.style.height = '200px';
            orbitPath.style.marginLeft = '-100px';
            orbitPath.style.marginTop = '-100px';
            container.appendChild(orbitPath);

            // æ˜¾ç¤ºå°è¡Œæ˜Ÿåœ¨è½¨é“ä¸Šç§»åŠ¨
            const asteroidElement = document.createElement('div');
            asteroidElement.className = 'asteroid-trail';
            asteroidElement.style.left = '50%';
            asteroidElement.style.top = '50%';
            asteroidElement.style.marginLeft = '-2px';
            asteroidElement.style.marginTop = '-2px';
            container.appendChild(asteroidElement);

            // æ·»åŠ è½¨é“ä¿¡æ¯
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '10px';
            info.style.borderRadius = '5px';
            info.style.fontSize = '12px';
            info.innerHTML = `
                <div><strong>ğŸ›°ï¸ ${asteroid.name}</strong></div>
                <div>ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>é€Ÿåº¦: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>è½¨é“ç±»å‹: è¿‘åœ°è½¨é“</div>
            `;
            container.appendChild(info);

            // 3ç§’åæ¸…ç†
            setTimeout(() => {
                container.remove();
            }, 5000);
        }

        async function showImpactDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // è·å–åœ°å›¾å®¹å™¨å’Œé€‰ä¸­çš„æ’å‡»ä½ç½®
            const mapContainer = document.getElementById('map');
            const mapRect = mapContainer.getBoundingClientRect();
            
            // å°†é€‰ä¸­çš„ç»çº¬åº¦è½¬æ¢ä¸ºå±å¹•åæ ‡
            const mapBounds = map.getBounds();
            const mapSize = map.getSize();
            
            // è®¡ç®—æ’å‡»ç‚¹åœ¨å±å¹•ä¸Šçš„ä½ç½®
            const impactPoint = L.latLng(selectedLocation.lat, selectedLocation.lng);
            const impactPixel = map.latLngToContainerPoint(impactPoint);
            
            // è®¡ç®—è½¨è¿¹èµ·ç‚¹ï¼ˆä»å±å¹•è¾¹ç¼˜éšæœºä½ç½®ï¼‰
            const startX = Math.random() * (mapRect.width - 100) + 50;
            const startY = 50;
            const endX = impactPixel.x;
            const endY = impactPixel.y;

            // åˆ›å»ºå°è¡Œæ˜Ÿè½¨è¿¹
            const asteroidElement = document.createElement('div');
            asteroidElement.className = 'asteroid-trail';
            asteroidElement.style.left = startX + 'px';
            asteroidElement.style.top = startY + 'px';
            asteroidElement.style.setProperty('--target-x', (endX - startX) + 'px');
            asteroidElement.style.setProperty('--target-y', (endY - startY) + 'px');
            container.appendChild(asteroidElement);

            // æ·»åŠ å°è¡Œæ˜Ÿä¿¡æ¯
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.right = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '10px';
            info.style.borderRadius = '5px';
            info.style.fontSize = '12px';
            info.innerHTML = `
                <div><strong>ğŸš€ ${asteroid.name}</strong></div>
                <div>ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>æ’å‡»é€Ÿåº¦: 20,000 m/s</div>
                <div>æ’å‡»è§’åº¦: 45Â°</div>
            `;
            container.appendChild(info);

            // æ’å‡»ç¬é—´æ•ˆæœ
            setTimeout(() => {
                const impactFlash = document.createElement('div');
                impactFlash.className = 'impact-flash';
                impactFlash.style.left = endX + 'px';
                impactFlash.style.top = endY + 'px';
                impactFlash.style.marginLeft = '-10px';
                impactFlash.style.marginTop = '-10px';
                container.appendChild(impactFlash);

                // æ·»åŠ æ’å‡»ä¿¡æ¯
                const impactInfo = document.createElement('div');
                impactInfo.style.position = 'absolute';
                impactInfo.style.bottom = '20px';
                impactInfo.style.left = '50%';
                impactInfo.style.transform = 'translateX(-50%)';
                impactInfo.style.background = 'rgba(255, 0, 0, 0.9)';
                impactInfo.style.color = 'white';
                impactInfo.style.padding = '15px';
                impactInfo.style.borderRadius = '10px';
                impactInfo.style.fontSize = '14px';
                impactInfo.style.fontWeight = 'bold';
                impactInfo.style.textAlign = 'center';
                impactInfo.innerHTML = 'ğŸ’¥ æ’å‡»å‘ç”Ÿï¼';
                container.appendChild(impactInfo);
            }, 2500);

            // 5ç§’åæ¸…ç†
            setTimeout(() => {
                container.remove();
            }, 5000);
        }

        async function show3DOrbitDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // æ£€æŸ¥Three.jsæ˜¯å¦åŠ è½½
            if (typeof THREE === 'undefined') {
                showError('Three.jsåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            try {
                // åˆ›å»º3Dåœºæ™¯
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ alpha: true });
                
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                renderer.setClearColor(0x000000, 0);
                container.appendChild(renderer.domElement);

                // æ·»åŠ è½¨é“æ§åˆ¶å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                let controls = null;
                if (typeof THREE.OrbitControls !== 'undefined') {
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                }

            // åˆ›å»ºåœ°çƒ
            const earthGeometry = new THREE.SphereGeometry(2, 32, 32);
            const earthMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x4A90E2,
                shininess: 100
            });
            const earth = new THREE.Mesh(earthGeometry, earthMaterial);
            scene.add(earth);

            // åˆ›å»ºå°è¡Œæ˜Ÿ
            const asteroidGeometry = new THREE.SphereGeometry(0.1, 8, 8);
            const asteroidMaterial = new THREE.MeshPhongMaterial({ color: 0xff6b6b });
            const asteroidMesh = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
            scene.add(asteroidMesh);

            // åˆ›å»ºè½¨é“è·¯å¾„
            const orbitGeometry = new THREE.RingGeometry(3, 3.1, 64);
            const orbitMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00aaff, 
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.3
            });
            const orbit = new THREE.Mesh(orbitGeometry, orbitMaterial);
            orbit.rotation.x = Math.PI / 2;
            scene.add(orbit);

            // æ·»åŠ å…‰ç…§
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            // è®¾ç½®ç›¸æœºä½ç½®
            camera.position.set(8, 4, 8);
            controls.target.set(0, 0, 0);

            // æ·»åŠ ä¿¡æ¯é¢æ¿
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '15px';
            info.style.borderRadius = '8px';
            info.style.fontSize = '14px';
            info.style.zIndex = '1000';
            info.innerHTML = `
                <div><strong>ğŸ›°ï¸ ${asteroid.name}</strong></div>
                <div>ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>é€Ÿåº¦: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>è½¨é“ç±»å‹: è¿‘åœ°è½¨é“</div>
                <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                    ä½¿ç”¨é¼ æ ‡æ‹–æ‹½æ—‹è½¬è§†è§’ï¼Œæ»šè½®ç¼©æ”¾
                </div>
            `;
            container.appendChild(info);

            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'âœ• å…³é—­3Dè§†å›¾';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '20px';
            closeBtn.style.right = '20px';
            closeBtn.style.background = 'rgba(255, 0, 0, 0.8)';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.padding = '10px 15px';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.zIndex = '1000';
            closeBtn.onclick = () => {
                container.remove();
            };
            container.appendChild(closeBtn);

                // åŠ¨ç”»å¾ªç¯
                let angle = 0;
                function animate() {
                    requestAnimationFrame(animate);
                    
                    // å°è¡Œæ˜Ÿè½¨é“è¿åŠ¨
                    angle += 0.02;
                    asteroidMesh.position.x = Math.cos(angle) * 3;
                    asteroidMesh.position.z = Math.sin(angle) * 3;
                    asteroidMesh.position.y = Math.sin(angle * 2) * 0.5;

                    // åœ°çƒè‡ªè½¬
                    earth.rotation.y += 0.01;

                    // æ›´æ–°æ§åˆ¶å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                    if (controls) {
                        controls.update();
                    }
                    renderer.render(scene, camera);
                }
                animate();

                // 10ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (container.parentNode) {
                        container.remove();
                    }
                }, 10000);
                
            } catch (error) {
                console.error('3Dæ¼”ç¤ºé”™è¯¯:', error);
                showError('3Dæ¼”ç¤ºåˆå§‹åŒ–å¤±è´¥: ' + error.message);
                // æ¸…ç†å®¹å™¨
                if (container.parentNode) {
                    container.remove();
                }
            }
        }

        async function showSimple3DDemo(asteroid) {
            const container = document.getElementById('demo-container');
            
            // åˆ›å»ºç®€åŒ–çš„3Dæ¼”ç¤ºï¼ˆä½¿ç”¨CSS 3Då˜æ¢ï¼‰
            const earth = document.createElement('div');
            earth.style.width = '100px';
            earth.style.height = '100px';
            earth.style.borderRadius = '50%';
            earth.style.background = 'radial-gradient(circle at 30% 30%, #4A90E2, #2E5BBA)';
            earth.style.position = 'absolute';
            earth.style.left = '50%';
            earth.style.top = '50%';
            earth.style.marginLeft = '-50px';
            earth.style.marginTop = '-50px';
            earth.style.boxShadow = '0 0 20px rgba(74, 144, 226, 0.5)';
            earth.style.animation = 'earthRotate 10s linear infinite';
            container.appendChild(earth);

            // åˆ›å»ºå°è¡Œæ˜Ÿ
            const asteroidElement = document.createElement('div');
            asteroidElement.style.width = '8px';
            asteroidElement.style.height = '8px';
            asteroidElement.style.borderRadius = '50%';
            asteroidElement.style.background = '#ff6b6b';
            asteroidElement.style.position = 'absolute';
            asteroidElement.style.left = '50%';
            asteroidElement.style.top = '50%';
            asteroidElement.style.marginLeft = '-4px';
            asteroidElement.style.marginTop = '-4px';
            asteroidElement.style.boxShadow = '0 0 10px #ff6b6b';
            asteroidElement.style.animation = 'asteroidOrbit 5s linear infinite';
            container.appendChild(asteroidElement);

            // åˆ›å»ºè½¨é“è·¯å¾„
            const orbit = document.createElement('div');
            orbit.style.width = '200px';
            orbit.style.height = '200px';
            orbit.style.border = '2px dashed #00aaff';
            orbit.style.borderRadius = '50%';
            orbit.style.position = 'absolute';
            orbit.style.left = '50%';
            orbit.style.top = '50%';
            orbit.style.marginLeft = '-100px';
            orbit.style.marginTop = '-100px';
            orbit.style.opacity = '0.5';
            container.appendChild(orbit);

            // æ·»åŠ ä¿¡æ¯é¢æ¿
            const info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '20px';
            info.style.left = '20px';
            info.style.background = 'rgba(0, 0, 0, 0.8)';
            info.style.color = 'white';
            info.style.padding = '15px';
            info.style.borderRadius = '8px';
            info.style.fontSize = '14px';
            info.style.zIndex = '1000';
            info.innerHTML = `
                <div><strong>ğŸ›°ï¸ ${asteroid.name}</strong></div>
                <div>ç›´å¾„: ${Math.round(asteroid.diameter_min/1000)}-${Math.round(asteroid.diameter_max/1000)} km</div>
                <div>é€Ÿåº¦: ${Math.round(asteroid.velocity/1000)} km/s</div>
                <div>è½¨é“ç±»å‹: è¿‘åœ°è½¨é“</div>
                <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                    ç®€åŒ–3Dæ¼”ç¤º - ä½¿ç”¨CSSåŠ¨ç”»
                </div>
            `;
            container.appendChild(info);

            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'âœ• å…³é—­æ¼”ç¤º';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '20px';
            closeBtn.style.right = '20px';
            closeBtn.style.background = 'rgba(255, 0, 0, 0.8)';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.padding = '10px 15px';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.zIndex = '1000';
            closeBtn.onclick = () => {
                container.remove();
            };
            container.appendChild(closeBtn);

            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes earthRotate {
                    from { transform: rotateY(0deg); }
                    to { transform: rotateY(360deg); }
                }
                @keyframes asteroidOrbit {
                    from { 
                        transform: rotate(0deg) translateX(100px) rotate(0deg);
                    }
                    to { 
                        transform: rotate(360deg) translateX(100px) rotate(-360deg);
                    }
                }
            `;
            document.head.appendChild(style);

            // 8ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (container.parentNode) {
                    container.remove();
                }
                document.head.removeChild(style);
            }, 8000);
        }

        async function showImpactTrajectory(asteroidId, show3DEffect = true) {
            // è·å–å°è¡Œæ˜Ÿæ•°æ®
            const response = await fetch('http://localhost:8000/asteroids');
            const asteroids = await response.json();
            const asteroid = asteroids.find(a => a.id === asteroidId);
            
            if (!asteroid) return;

            // åˆ›å»ºè½¨è¿¹å®¹å™¨
            const container = document.createElement('div');
            container.id = 'trajectory-container';
            container.style.position = 'absolute';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            container.style.pointerEvents = 'none';
            container.style.zIndex = '1000';
            document.getElementById('map').appendChild(container);

            // è®¡ç®—æ’å‡»ç‚¹åœ¨å±å¹•ä¸Šçš„ä½ç½®
            const impactPoint = L.latLng(selectedLocation.lat, selectedLocation.lng);
            const impactPixel = map.latLngToContainerPoint(impactPoint);

            // åˆ›å»ºè½¨è¿¹æ•ˆæœ
            await create3DTrajectory(container, impactPixel, asteroid, show3DEffect);

            // 3ç§’åæ¸…ç†
            setTimeout(() => {
                if (container.parentNode) {
                    container.remove();
                }
            }, 3000);
        }

        async function create3DTrajectory(container, impactPixel, asteroid, show3DEffect = true) {
            // åˆ›å»ºè½¨è¿¹è·¯å¾„
            const trajectory = document.createElement('div');
            trajectory.style.position = 'absolute';
            trajectory.style.left = '50%';
            trajectory.style.top = '10%';
            trajectory.style.width = '4px';
            trajectory.style.height = '2px';
            trajectory.style.background = 'linear-gradient(45deg, #ff6b6b, #ffaa00)';
            trajectory.style.borderRadius = '2px';
            trajectory.style.boxShadow = '0 0 20px #ff6b6b';
            trajectory.style.transformOrigin = 'left center';
            trajectory.style.animation = 'trajectoryFall 2.5s ease-in forwards';
            container.appendChild(trajectory);

            // åˆ›å»ºå°è¡Œæ˜Ÿ
            const asteroidElement = document.createElement('div');
            asteroidElement.style.position = 'absolute';
            asteroidElement.style.left = '50%';
            asteroidElement.style.top = '10%';
            asteroidElement.style.width = '12px';
            asteroidElement.style.height = '12px';
            asteroidElement.style.background = 'radial-gradient(circle, #ff6b6b, #cc0000)';
            asteroidElement.style.borderRadius = '50%';
            asteroidElement.style.boxShadow = '0 0 15px #ff6b6b, 0 0 30px rgba(255, 107, 107, 0.5)';
            asteroidElement.style.animation = 'asteroidFall 2.5s ease-in forwards';
            container.appendChild(asteroidElement);

            // åˆ›å»ºå°¾è¿¹æ•ˆæœ
            const trail = document.createElement('div');
            trail.style.position = 'absolute';
            trail.style.left = '50%';
            trail.style.top = '10%';
            trail.style.width = '2px';
            trail.style.height = '0px';
            trail.style.background = 'linear-gradient(to bottom, transparent, #ffaa00, #ff6b6b)';
            trail.style.animation = 'trailGrow 2.5s ease-in forwards';
            container.appendChild(trail);

            // æ·»åŠ ç«‹ä½“åœ°å›¾æ•ˆæœï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (show3DEffect) {
                add3DMapEffect(container);
            }

            // æ·»åŠ CSSåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes trajectoryFall {
                    0% {
                        transform: translate(-50%, -50%) rotate(0deg) scale(1);
                        opacity: 1;
                    }
                    50% {
                        transform: translate(-50%, -50%) rotate(15deg) scale(1.2);
                        opacity: 0.8;
                    }
                    100% {
                        transform: translate(${impactPixel.x - window.innerWidth/2}px, ${impactPixel.y - window.innerHeight/10}px) rotate(45deg) scale(1.5);
                        opacity: 0;
                    }
                }
                
                @keyframes asteroidFall {
                    0% {
                        transform: translate(-50%, -50%) scale(0.5);
                        opacity: 1;
                    }
                    50% {
                        transform: translate(-50%, -50%) scale(1);
                        opacity: 0.9;
                    }
                    100% {
                        transform: translate(${impactPixel.x - window.innerWidth/2}px, ${impactPixel.y - window.innerHeight/10}px) scale(1.2);
                        opacity: 0;
                    }
                }
                
                @keyframes trailGrow {
                    0% {
                        height: 0px;
                        opacity: 0;
                    }
                    50% {
                        height: 100px;
                        opacity: 0.7;
                    }
                    100% {
                        height: 200px;
                        opacity: 0;
                    }
                }
                
                @keyframes mapShake {
                    0%, 100% { transform: translate(0, 0) rotate(0deg); }
                    10% { transform: translate(-2px, -1px) rotate(-0.5deg); }
                    20% { transform: translate(2px, 1px) rotate(0.5deg); }
                    30% { transform: translate(-1px, 2px) rotate(-0.3deg); }
                    40% { transform: translate(1px, -2px) rotate(0.3deg); }
                    50% { transform: translate(-2px, 1px) rotate(-0.2deg); }
                    60% { transform: translate(2px, -1px) rotate(0.2deg); }
                    70% { transform: translate(-1px, -2px) rotate(-0.1deg); }
                    80% { transform: translate(1px, 2px) rotate(0.1deg); }
                    90% { transform: translate(-2px, -1px) rotate(-0.05deg); }
                }
            `;
            document.head.appendChild(style);

            // æ’å‡»ç¬é—´æ•ˆæœ
            setTimeout(() => {
                // åœ°å›¾éœ‡åŠ¨æ•ˆæœ
                const mapElement = document.getElementById('map');
                mapElement.style.animation = 'mapShake 0.5s ease-out';

                // æ’å‡»é—ªå…‰
                const flash = document.createElement('div');
                flash.style.position = 'absolute';
                flash.style.left = impactPixel.x + 'px';
                flash.style.top = impactPixel.y + 'px';
                flash.style.width = '20px';
                flash.style.height = '20px';
                flash.style.background = 'radial-gradient(circle, #ffff00, #ff4444)';
                flash.style.borderRadius = '50%';
                flash.style.transform = 'translate(-50%, -50%)';
                flash.style.animation = 'impactFlash 0.5s ease-out';
                container.appendChild(flash);

                // å†²å‡»æ³¢
                const shockwave = document.createElement('div');
                shockwave.style.position = 'absolute';
                shockwave.style.left = impactPixel.x + 'px';
                shockwave.style.top = impactPixel.y + 'px';
                shockwave.style.width = '0px';
                shockwave.style.height = '0px';
                shockwave.style.border = '3px solid #ffaa00';
                shockwave.style.borderRadius = '50%';
                shockwave.style.transform = 'translate(-50%, -50%)';
                shockwave.style.animation = 'shockwaveExpand 1s ease-out';
                container.appendChild(shockwave);

                // æ·»åŠ å†²å‡»æ³¢åŠ¨ç”»
                const shockwaveStyle = document.createElement('style');
                shockwaveStyle.textContent = `
                    @keyframes impactFlash {
                        0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
                        100% { transform: translate(-50%, -50%) scale(10); opacity: 0; }
                    }
                    
                    @keyframes shockwaveExpand {
                        0% { 
                            width: 0px; 
                            height: 0px; 
                            opacity: 1; 
                        }
                        100% { 
                            width: 200px; 
                            height: 200px; 
                            opacity: 0; 
                        }
                    }
                `;
                document.head.appendChild(shockwaveStyle);

                // æ¸…ç†åŠ¨ç”»æ ·å¼
                setTimeout(() => {
                    document.head.removeChild(style);
                    document.head.removeChild(shockwaveStyle);
                    mapElement.style.animation = '';
                }, 3000);

            }, 2500);
        }

        function add3DMapEffect(container) {
            // æ·»åŠ ç«‹ä½“åœ°å›¾æ•ˆæœ
            const mapElement = document.getElementById('map');
            
            // æ·»åŠ 3Då˜æ¢
            mapElement.style.transform = 'perspective(1000px) rotateX(5deg)';
            mapElement.style.transition = 'transform 0.3s ease';
            
            // æ·»åŠ é˜´å½±æ•ˆæœ
            const shadow = document.createElement('div');
            shadow.style.position = 'absolute';
            shadow.style.bottom = '-20px';
            shadow.style.left = '20px';
            shadow.style.right = '20px';
            shadow.style.height = '20px';
            shadow.style.background = 'radial-gradient(ellipse, rgba(0,0,0,0.3), transparent)';
            shadow.style.borderRadius = '50%';
            shadow.style.transform = 'scale(1.2)';
            container.appendChild(shadow);

            // æ·»åŠ æ·±åº¦æŒ‡ç¤ºå™¨
            const depthIndicator = document.createElement('div');
            depthIndicator.style.position = 'absolute';
            depthIndicator.style.top = '20px';
            depthIndicator.style.right = '20px';
            depthIndicator.style.background = 'rgba(0, 0, 0, 0.8)';
            depthIndicator.style.color = 'white';
            depthIndicator.style.padding = '10px';
            depthIndicator.style.borderRadius = '5px';
            depthIndicator.style.fontSize = '12px';
            depthIndicator.innerHTML = `
                <div>ğŸŒ ç«‹ä½“åœ°å›¾è§†å›¾</div>
                <div>ğŸ“ 3Dè½¨è¿¹æ˜¾ç¤º</div>
            `;
            container.appendChild(depthIndicator);

            // 3ç§’åæ¢å¤åœ°å›¾
            setTimeout(() => {
                mapElement.style.transform = 'perspective(1000px) rotateX(0deg)';
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
