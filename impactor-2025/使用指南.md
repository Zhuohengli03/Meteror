# Impactor 2025 使用指南

## 📖 目录
- [快速开始](#快速开始)
- [GeoNames API 设置](#geonames-api-设置)
- [功能说明](#功能说明)
- [常见问题](#常见问题)

---

## 🚀 快速开始

### 1. 环境要求
- Python 3.8+
- Node.js 16+
- npm 或 yarn

### 2. 安装依赖

**后端**:
```bash
cd backend
pip install -r requirements.txt
```

**前端**:
```bash
cd frontend
npm install
```

### 3. 配置环境变量

复制 `env.example` 为 `.env` 并配置：
```bash
cp env.example .env
```

必需配置：
```bash
# 后端 API 地址
VITE_API_BASE_URL=http://localhost:8001

# GeoNames 用户名（可选，不配置会使用备用数据库）
GEONAMES_USERNAME=your_username_here
```

### 4. 启动服务

**后端**:
```bash
cd backend
python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8001
```

**前端**:
```bash
cd frontend
npm run dev
```

访问 http://localhost:5173

---

## 🌍 GeoNames API 设置

### 为什么需要 GeoNames？

GeoNames API 可以**根据撞击点位置动态查询附近的真实城市**，而不是只从预设的城市列表中筛选。

**优势**:
- ✅ 动态查询撞击点附近的所有城市（人口 > 10,000）
- ✅ 支持全球任意位置
- ✅ 基于真实人口分布
- ✅ 免费使用（每天 20,000 次请求）

**不配置也可以**: 系统会自动使用内置的 50+ 个全球主要城市数据库作为备用。

### 注册步骤

#### 1. 创建账户
访问 https://www.geonames.org/login

1. 点击 "create a new user account"
2. 填写用户名、邮箱、密码
3. 确认邮箱验证链接

#### 2. 启用 Web Services（重要！）
⚠️ 注册后必须手动启用此功能：

1. 登录 https://www.geonames.org/login
2. 点击你的用户名进入账户页面
3. 找到 "Free Web Services" 部分
4. 点击 **"Click here to enable"** 按钮

如果不启用，API 会返回错误！

#### 3. 配置环境变量
在 `.env` 文件中添加：
```bash
GEONAMES_USERNAME=你的用户名
```

#### 4. 重启后端
```bash
cd backend
lsof -ti:8001 | xargs kill -9
python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8001
```

### API 限制
- 免费账户：每小时 1,000 次，每天 20,000 次
- 超限后自动切换到备用数据库
- 可升级到付费账户获取更高配额

---

## 🎯 功能说明

### 1. 选择小行星

在 "Select Asteroid" 下拉菜单中选择一个来自 NASA API 的真实小行星。

系统会自动加载：
- 小行星直径
- 撞击速度
- 轨道倾角
- 危险等级

### 2. 设置撞击位置

**方法 1**: 在地图上点击选择位置

**方法 2**: 在 "Custom Settings" 中手动输入经纬度

### 3. 自定义参数（可选）

点击 "Show Custom Settings" 展开高级选项：

- **直径**: 调整小行星大小（10-1000m）
- **密度类型**: 石质/铁质/碳质
- **撞击速度**: 调整速度（5-30 km/s）
- **撞击角度**: 调整角度（5-90°）
- **目标类型**: 大陆地壳/海洋地壳/海洋
- **偏转策略**: 选择防御策略（见下文）

### 4. 偏转策略

系统支持 4 种偏转策略：

| 策略 | Delta-V | 成本 | 提前时间 | 描述 |
|------|---------|------|---------|------|
| **Kinetic Impactor** | 10 m/s | $1.0B | 365天 | 高速撞击器改变轨道 |
| **Nuclear Standoff** | 50 m/s | $5.0B | 730天 | 核爆炸产生冲击波 |
| **Gravity Tractor** | 1 m/s | $10.0B | 3650天 | 长期引力牵引 |
| **Ion Beam** | 5 m/s | $8.0B | 1825天 | 离子束持续推进 |

**如何选择**:
1. 在 "Custom Settings" 中找到 "Deflection Strategy"
2. 选择一个策略或 "No Deflection"
3. 查看策略详情（Delta-V、成本、提前时间）
4. 可以随时切换或清除策略

### 5. 运行模拟

点击 "Run Simulation" 按钮。

系统会计算：
- 撞击能量和 TNT 当量
- 陨石坑大小
- 地震强度和影响范围
- 海啸高度（如果撞击海洋）
- 受影响城市和人口
- 经济损失

### 6. 查看结果

**Impact Analysis** 部分显示：
- 撞击参数（能量、速度、角度）
- 陨石坑尺寸
- 地震强度
- 海啸信息
- 受影响城市列表
- 经济损失估算

**地图显示**:
- 红色标记：撞击点
- 蓝色标记：受影响城市
- 点击城市查看详细信息

---

## 🔍 影响等级说明

系统根据城市距离撞击点的距离自动分配影响等级：

| 距离范围 | 影响等级 | 经济损失 | 描述 |
|---------|---------|---------|------|
| 0 - 陨石坑半径 | **Extreme** | 95% | 完全摧毁 |
| 陨石坑 - 爆炸半径 | **High** | 50% | 严重破坏 |
| 爆炸半径 - 3倍 | **Medium** | 20% | 中度破坏 |
| 3倍 - 10倍 | **Low** | 5% | 轻微破坏 |
| 10倍 - 地震半径 | **Minimal** | 1% | 轻微影响 |

---

## ❓ 常见问题

### Q1: 为什么只显示少数几个城市？

**可能原因**:
1. 撞击点在偏远地区
2. 小行星太小，影响范围小
3. 未配置 GeoNames API

**解决方法**:
- 增大小行星直径
- 配置 GeoNames API 获取更多城市数据
- 选择人口密集地区测试

### Q2: GeoNames API 报错怎么办？

**常见错误**:

**"user account not enabled"**
- 原因：未启用 Web Services
- 解决：登录账户，点击 "enable free web services"

**"hourly limit exceeded"**
- 原因：超过每小时 1,000 次限制
- 解决：等待一小时，或系统会自动切换到备用数据库

**"invalid user"**
- 原因：用户名错误
- 解决：检查 `.env` 文件中的 `GEONAMES_USERNAME`

### Q3: 偏转策略无法更改？

已修复！现在可以：
- ✅ 选择任意策略
- ✅ 在策略之间切换
- ✅ 选择 "No Deflection" 清除策略

### Q4: 模拟结果不一致？

**原因**: 之前版本的撞击角度计算包含随机因素。

**解决**: 已修复，现在结果完全基于轨道参数，具有确定性。

### Q5: 后端启动失败？

**检查**:
1. 是否安装了所有依赖：`pip install -r requirements.txt`
2. 端口是否被占用：`lsof -ti:8001`
3. Python 版本是否 >= 3.8

### Q6: 前端无法连接后端？

**检查**:
1. 后端是否正在运行
2. `.env` 中的 `VITE_API_BASE_URL` 是否正确
3. 端口是否匹配（默认 8001）

---

## 📚 更多资源

### 文档
- `README.md` - 项目总览（英文）
- `docs/api.md` - API 文档
- `docs/formulas.md` - 物理公式说明
- `docs/data-sources.md` - 数据来源
- `docs/geonames-setup.md` - GeoNames 详细设置（英文）

### 技术文档
- `GEONAMES_INTEGRATION.md` - GeoNames 集成技术文档
- `UPDATES_SUMMARY.md` - 最新更新总结
- `偏转策略修复说明.md` - 偏转策略修复详情

### 在线资源
- [NASA NEO API](https://api.nasa.gov/)
- [GeoNames](https://www.geonames.org/)
- [项目 GitHub](https://github.com/your-repo)

---

## 🆘 获取帮助

如有问题：
1. 查看本文档的常见问题部分
2. 查看详细技术文档
3. 提交 GitHub Issue
4. 联系项目维护者

---

**版本**: v1.1.1  
**更新时间**: 2025-10-05
